<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE article
  PUBLIC "-//NLM//DTD Journal Publishing DTD v3.0 20080202//EN" "http://dtd.nlm.nih.gov/publishing/3.0/journalpublishing3.dtd">
<article xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink" article-type="research-article" dtd-version="3.0" xml:lang="EN">
<front>
<journal-meta><journal-id journal-id-type="publisher-id">plos</journal-id><journal-id journal-id-type="nlm-ta">PLoS Comput Biol</journal-id><journal-id journal-id-type="pmc">ploscomp</journal-id><!--===== Grouping journal title elements =====--><journal-title-group><journal-title>PLoS Computational Biology</journal-title></journal-title-group><issn pub-type="ppub">1553-734X</issn><issn pub-type="epub">1553-7358</issn><publisher>
<publisher-name>Public Library of Science</publisher-name>
<publisher-loc>San Francisco, USA</publisher-loc></publisher></journal-meta>
<article-meta><article-id pub-id-type="publisher-id">08-PLCB-RA-0709R3</article-id><article-id pub-id-type="doi">10.1371/journal.pcbi.1000483</article-id><article-categories><subj-group subj-group-type="heading"><subject>Research Article</subject></subj-group><subj-group subj-group-type="Discipline"><subject>Computational Biology/Evolutionary Modeling</subject></subj-group></article-categories><title-group><article-title>Evolutionary Triplet Models of Structured RNA</article-title><alt-title alt-title-type="running-head">Evolutionary Triplet Models of Structured RNA</alt-title></title-group><contrib-group>
<contrib contrib-type="author" xlink:type="simple"><name name-style="western"><surname>Bradley</surname><given-names>Robert K.</given-names></name><xref ref-type="aff" rid="aff1"><sup>1</sup></xref></contrib>
<contrib contrib-type="author" xlink:type="simple"><name name-style="western"><surname>Holmes</surname><given-names>Ian</given-names></name><xref ref-type="aff" rid="aff1"><sup>1</sup></xref><xref ref-type="aff" rid="aff2"><sup>2</sup></xref><xref ref-type="corresp" rid="cor1"><sup>*</sup></xref></contrib>
</contrib-group><aff id="aff1"><label>1</label><addr-line>Biophysics Graduate Group, University of California, Berkeley, California, United States of America</addr-line>       </aff><aff id="aff2"><label>2</label><addr-line>Department of Bioengineering, University of California, Berkeley, California, United States of America</addr-line>       </aff><contrib-group>
<contrib contrib-type="editor" xlink:type="simple"><name name-style="western"><surname>Stormo</surname><given-names>Gary D.</given-names></name>
<role>Editor</role>
<xref ref-type="aff" rid="edit1"/></contrib>
</contrib-group><aff id="edit1">Washington University School of Medicine, United States of America</aff><author-notes>
<corresp id="cor1">* E-mail: <email xlink:type="simple">indiegram@postbox.biowiki.org</email></corresp>
<fn fn-type="con"><p>Conceived and designed the experiments: RKB IH. Performed the experiments: RKB IH. Analyzed the data: RKB IH. Contributed reagents/materials/analysis tools: RKB IH. Wrote the paper: RKB IH.</p></fn>
<fn fn-type="conflict"><p>The authors have declared that no competing interests exist.</p></fn></author-notes><pub-date pub-type="collection"><month>8</month><year>2009</year></pub-date><pub-date pub-type="epub"><day>28</day><month>8</month><year>2009</year></pub-date><volume>5</volume><issue>8</issue><elocation-id>e1000483</elocation-id><history>
<date date-type="received"><day>21</day><month>8</month><year>2008</year></date>
<date date-type="accepted"><day>23</day><month>7</month><year>2009</year></date>
</history><!--===== Grouping copyright info into permissions =====--><permissions><copyright-year>2009</copyright-year><copyright-holder>Bradley, Holmes</copyright-holder><license><license-p>This is an open-access article distributed under the terms of the Creative Commons Attribution License, which permits unrestricted use, distribution, and reproduction in any medium, provided the original author and source are credited.</license-p></license></permissions><abstract>
<p>The reconstruction and synthesis of ancestral RNAs is a feasible goal for paleogenetics. This will require new bioinformatics methods, including a robust statistical framework for reconstructing histories of substitutions, indels and structural changes. We describe a “transducer composition” algorithm for extending pairwise probabilistic models of RNA structural evolution to models of multiple sequences related by a phylogenetic tree. This algorithm draws on formal models of computational linguistics as well as the 1985 protosequence algorithm of David Sankoff. The output of the composition algorithm is a multiple-sequence stochastic context-free grammar. We describe dynamic programming algorithms, which are robust to null cycles and empty bifurcations, for parsing this grammar. Example applications include structural alignment of non-coding RNAs, propagation of structural information from an experimentally-characterized sequence to its homologs, and inference of the ancestral structure of a set of diverged RNAs. We implemented the above algorithms for a simple model of pairwise RNA structural evolution; in particular, the algorithms for maximum likelihood (ML) alignment of three known RNA structures and a known phylogeny and inference of the common ancestral structure. We compared this ML algorithm to a variety of related, but simpler, techniques, including ML alignment algorithms for simpler models that omitted various aspects of the full model and also a posterior-decoding alignment algorithm for one of the simpler models. In our tests, incorporation of basepair structure was the most important factor for accurate alignment inference; appropriate use of posterior-decoding was next; and fine details of the model were least important. Posterior-decoding heuristics can be substantially faster than exact phylogenetic inference, so this motivates the use of sum-over-pairs heuristics where possible (and approximate sum-over-pairs). For more exact probabilistic inference, we discuss the use of transducer composition for ML (or MCMC) inference on phylogenies, including possible ways to make the core operations tractable.</p>
</abstract><abstract abstract-type="summary"><title>Author Summary</title>
<p>A number of leading methods for bioinformatics analysis of structural RNAs use probabilistic grammars as models for pairs of homologous RNAs. We show that any such pairwise grammar can be extended to an entire phylogeny by treating the pairwise grammar as a machine (a “transducer”) that models a single ancestor-descendant relationship in the tree, transforming one RNA structure into another. In addition to phylogenetic enhancement of current applications, such as RNA genefinding, homology detection, alignment and secondary structure prediction, this should enable probabilistic phylogenetic reconstruction of RNA sequences that are ancestral to present-day genes. We describe statistical inference algorithms, software implementations, and a simulation-based comparison of three-taxon maximum likelihood alignment to several other methods for aligning three sibling RNAs. In the Discussion we consider how the three-taxon RNA alignment-reconstruction-folding algorithm, which is currently very computationally-expensive, might be made more efficient so that larger phylogenies could be considered.</p>
</abstract><funding-group><funding-statement>This work was funded by NIH/NHGRI grant GM076705. RKB was partially supported by a NSF Graduate Research Fellowship. The funders had no role in study design, data collection and analysis, decision to publish, or preparation of the manuscript.</funding-statement></funding-group><counts><page-count count="20"/></counts></article-meta>
</front>
<body><sec id="s1">
<title>Introduction</title>
<p>In 1968, Francis Crick hypothesized that the first ribosome consisted entirely of RNA, without any protein cofactors <xref ref-type="bibr" rid="pcbi.1000483-Crick1">[1]</xref>. A domain structure for this primeval ribosome was recently proposed <xref ref-type="bibr" rid="pcbi.1000483-Smith1">[2]</xref>. To synthesize such a reconstructed ribosome or reconstructions of other evolutionarily significant RNAs such as group II introns <xref ref-type="bibr" rid="pcbi.1000483-Lehmann1">[3]</xref> or telomerase <xref ref-type="bibr" rid="pcbi.1000483-Antal1">[4]</xref>, it will be necessary to develop methods that can predict the sequences and structures of ancient RNAs based on the divergent sequences of their many descendants.</p>
<p>An inspection of RNA alignments, such as those in the RFAM database <xref ref-type="bibr" rid="pcbi.1000483-GriffithsJones1">[5]</xref>, suggests that an evolutionary model for RNA structure must eventually include multiple layers of detail: point substitutions, covariant substitutions of base-pairs <xref ref-type="bibr" rid="pcbi.1000483-Hancock1">[6]</xref>,<xref ref-type="bibr" rid="pcbi.1000483-Leontis1">[7]</xref>, indels <xref ref-type="bibr" rid="pcbi.1000483-Yokoyama1">[8]</xref>, local changes in secondary structure such as helix slippage <xref ref-type="bibr" rid="pcbi.1000483-Hancock2">[9]</xref>, and changes in domain structure <xref ref-type="bibr" rid="pcbi.1000483-Smith1">[2]</xref>. Stochastic context-free grammars (SCFGs), which can efficiently detect the long-range correlations of RNA base-pairing structures, are natural probabilistic models of such phenomena and have been used for ncRNA homology detection <xref ref-type="bibr" rid="pcbi.1000483-Eddy1">[10]</xref>–<xref ref-type="bibr" rid="pcbi.1000483-Nawrocki1">[13]</xref>, gene prediction <xref ref-type="bibr" rid="pcbi.1000483-Rivas1">[14]</xref>,<xref ref-type="bibr" rid="pcbi.1000483-Pedersen1">[15]</xref>, folding <xref ref-type="bibr" rid="pcbi.1000483-Knudsen1">[16]</xref>,<xref ref-type="bibr" rid="pcbi.1000483-Dowell1">[17]</xref> and alignment <xref ref-type="bibr" rid="pcbi.1000483-Holmes1">[18]</xref>–<xref ref-type="bibr" rid="pcbi.1000483-Bradley1">[20]</xref>.</p>
<p>By analogy with models of substitution processes, which are well-understood <xref ref-type="bibr" rid="pcbi.1000483-Felsenstein1">[21]</xref>, we may take the problem of building phylogenetic models of RNA evolution and split it into two halves. The first half is the development of a <bold>pairwise model</bold>, describing the probability distribution <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e001" xlink:type="simple"/></inline-formula> of a descendant (<inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e002" xlink:type="simple"/></inline-formula>) conditional on its immediate ancestor (<inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e003" xlink:type="simple"/></inline-formula>). In substitution processes, the pairwise model is a conditional substitution matrix. Often (but not always) the pairwise model, representing a finite evolutionary time <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e004" xlink:type="simple"/></inline-formula>, is derived from an instantaneous model of change over an infinitesimal time interval, i.e., a continuous-time Markov chain (parametrized by a rate matrix). Obtaining the transition probabilities of this chain (via exponentiation of the rate matrix) yields a pairwise model whose parameters are smoothly-varying functions of <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e005" xlink:type="simple"/></inline-formula>. A pairwise model represents an individual branch of a phylogenetic tree, with <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e006" xlink:type="simple"/></inline-formula> representing the length of that branch.</p>
<p>The second half of the phylogenetic modeling problem involves extending the model (and related inference algorithms) from a single branch to a complete phylogeny, i.e., from a pairwise model of two sequences to a <bold>multiple-sequence model</bold> of many sequences. In a typical situation, the sequences at the leaves of the tree are observed but those at internal nodes are not. Questions of interest then include:</p>
<list list-type="alpha-upper"><list-item>
<p>What is the likelihood for the observed sequence data?</p>
</list-item><list-item>
<p>Can we sample (find the mode, take moments, etc.) from the posterior distribution of the unobserved sequence at the root node?</p>
</list-item><list-item>
<p>Can we sample from the posterior of the unobserved sequences at the other internal nodes?</p>
</list-item><list-item>
<p>Can we estimate summaries of the evolutionary history, such as the number of substitution events on each branch (for a substitution model), the alignment (for a model which includes indels), or changes in the underlying structure (for a model of RNA structure)?</p>
</list-item></list>
<p>For substitution models, there has been extensive work focused on answering each of these questions. Given a pairwise substitution model, questions A and B can be answered exactly by Felsenstein's pruning algorithm <xref ref-type="bibr" rid="pcbi.1000483-Felsenstein2">[22]</xref> and question C can be answered by the peeling algorithm (first presented for pedigree analysis by Elston and Stewart <xref ref-type="bibr" rid="pcbi.1000483-Elston1">[23]</xref>). The estimation of evolutionary histories (question D) has been addressed by exact summarization <xref ref-type="bibr" rid="pcbi.1000483-Holmes2">[24]</xref> and sampling <xref ref-type="bibr" rid="pcbi.1000483-Nielsen1">[25]</xref> approaches. Another representation of answers A–C is that the pruning and peeling algorithms (combined) are just the sum-product algorithm on a directed graphical model <xref ref-type="bibr" rid="pcbi.1000483-Pearl1">[26]</xref>, yielding exact marginal distributions for unobserved variables. Graphical models also suggest general-purpose sampling approaches in addition to the exact sum-product algorithm.</p>
<p>The two halves of the reconstruction problem — developing a pairwise model and then extending it to multiple sequences — are largely independent. Felsenstein's pruning algorithm, for example, is essentially blind to the parametric form of the pairwise substitution model; it just assumes that a substitution matrix is provided for every branch. Subsequent models developed by other researchers can be plugged into the pruning algorithm without modification <xref ref-type="bibr" rid="pcbi.1000483-Yang1">[27]</xref>,<xref ref-type="bibr" rid="pcbi.1000483-Whelan1">[28]</xref>.</p>
<p>We therefore addressed the problem of modeling the indel-evolution of multiple structured RNAs in a similarly-modular fashion by separating the creation of pairwise and multiple-sequence models. In previous work, we addressed the first (pairwise) part of the RNA reconstruction problem by describing a simple continuous-time model of RNA structural evolution <xref ref-type="bibr" rid="pcbi.1000483-Holmes3">[29]</xref>. This model corresponded to a Pair SCFG with a time-dependent parametrization which we used to simultaneously align and predict the structure of pairs of related RNAs. The focus of the present work is to solve the second (multiple-sequence) part of the RNA reconstruction problem by giving a general procedure for extending a pairwise model to multiple sequences related by a phylogenetic tree. This process yields a multiple-sequence SCFG, a natural model of the evolutionary relationships between multiple structured RNAs.</p>
<p>The main contributions of this paper are (1) an algorithm that transforms a phylogenetic ensemble of pair grammars, representing models on branches of a phylogenetic tree, into a coherent, multiple-sequence SCFG, (2) dynamic programming (DP) algorithms for performing inference under this multiple-sequence SCFG, and (3) freely-available software implementing algorithms (1) and (2) for the simplified case of a three-taxon star-topology tree. While the idea of composing conditionally-normalized models on trees is intuitive, the resulting models can be very complex, even for simple models of RNA evolution, making (1) necessary. Studies of related indel models have suggested that an implementation of dynamic programming (DP) algorithms on a three-taxon tree is sufficient to draw samples from the posterior distribution of ancestral sequences on more complex tree topologies, using Markov Chain Monte Carlo or MCMC <xref ref-type="bibr" rid="pcbi.1000483-Holmes4">[30]</xref>–<xref ref-type="bibr" rid="pcbi.1000483-Redelings1">[32]</xref>, suggesting that (2) and (3) are, in principle, sufficient for analyzing trees relating many sequences.</p>
<p>We show that our algorithm produces a multiple-sequence grammar which is much more compact than suggested by naive approaches to model construction. We provide analyses of the asymptotic complexities of models constructed using our procedure and provide estimates of the time and memory required to reconstruct the structures of several RNA families for the case of a three-taxon phylogeny, which we have implemented in the program Indiegram. While by these estimates only the smallest sequences currently fit into affordable memory, thereby preventing us from applying our method to many problems of interest, a simulation study suggests that we can hope to accurately reconstruct ancestral structures over long evolutionary time, even in the presence of structural divergence.</p>
<p>In the <xref ref-type="sec" rid="s4">Discussion</xref>, we speculate on algorithmic extensions that may reduce memory requirements, inspired by related work in reconstructing DNA and protein sequences.</p>
</sec><sec id="s2">
<title>Methods</title>
<p>We describe below a general method for constructing a multiple-sequence stochastic grammar for alignment, folding and ancestral reconstruction of RNA, given a phylogenetic tree and a description of the evolutionary process acting along each branch.</p>
<sec id="s2a">
<title>Overview</title>
<p>Our problem statement is this: <bold>Given a phylogenetic tree relating several structured RNAs and a description of the evolution of a structured RNA along a single branch of the tree (in the form of a Pair SCFG), (1) find the corresponding phylogenetic multiple-sequence grammar and (2) use that grammar to reconstruct, </bold><bold><italic>a posteriori</italic></bold><bold>, the evolutionary histories of the RNAs</bold>. We assume here that the phylogeny, including both the tree topology and branch lengths, is given.</p>
<p>This paper focuses on model construction and inference algorithms rather than the heuristics which will be necessary to make these algorithms fast enough for analysis of many biological datasets. As discussed below, the complexity of general inference algorithms is prohibitively high for many problems of interest. However, this complexity can be significantly reduced by incorporating outside knowledge. For example, if we know the consensus structure of several sequences or their individual structures, then we can constrain our algorithms accordingly. Similarly, we might consider only ancestral structures which are compatible with a given multiple sequence alignment, or a relatively small set of candidate alignments (as in the ORTHEUS program <xref ref-type="bibr" rid="pcbi.1000483-Paten1">[33]</xref>). Such constraints are commonly used by programs for SCFG-based RNA sequence analysis such as QRNA <xref ref-type="bibr" rid="pcbi.1000483-Rivas2">[34]</xref>, Stemloc <xref ref-type="bibr" rid="pcbi.1000483-Holmes1">[18]</xref> and CONSAN <xref ref-type="bibr" rid="pcbi.1000483-Dowell2">[19]</xref>. Alignment and structural constraints can be combined <xref ref-type="bibr" rid="pcbi.1000483-Holmes1">[18]</xref>.</p>
<p>In the following sections we introduce more precise definitions for two-sequence models of RNA structure and outline our algorithms for (1) combining these two-sequence models on a phylogenetic tree and (2) using the composite phylogenetic grammars for inference.</p>
</sec><sec id="s2b">
<title>Two-sequence models</title>
<p>We discuss the general problem of creating state-space models of the evolution of related sequences, beginning with models of substitution processes acting at independent sites (as studied in likelihood phylogenetics) and generalizing to models of indels, first in primary sequences and then in sequences with conserved secondary structure.</p>
<p>A stochastic model for the evolution of one sequence (the ancestor, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e007" xlink:type="simple"/></inline-formula>) into another (the descendant, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e008" xlink:type="simple"/></inline-formula>) over an interval of time (<inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e009" xlink:type="simple"/></inline-formula>) can be described by a joint distribution, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e010" xlink:type="simple"/></inline-formula>. This joint distribution can be factored, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e011" xlink:type="simple"/></inline-formula>, where <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e012" xlink:type="simple"/></inline-formula> is the marginal distribution over ancestral sequences and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e013" xlink:type="simple"/></inline-formula> is the conditional distribution over descendant sequences given an ancestral sequence. In terms of phylogenetics, the conditional distribution <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e014" xlink:type="simple"/></inline-formula> describes the evolution <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e015" xlink:type="simple"/></inline-formula> along a branch of length <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e016" xlink:type="simple"/></inline-formula>.</p>
<p>It is possible to “multiply” two such models together. More precisely, one multiplies two conditional distributions and sums out the intermediate sequence. Thus, successive evolution along two branches <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e017" xlink:type="simple"/></inline-formula> is modeled by the distribution<disp-formula><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e018" xlink:type="simple"/></disp-formula>and we can sum sequence <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e019" xlink:type="simple"/></inline-formula> out of this, obtaining the distribution<disp-formula><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e020" xlink:type="simple"/></disp-formula>for the composite branch <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e021" xlink:type="simple"/></inline-formula>.</p>
<p>This formalism underlies likelihood phylogenetics. Working under the independent-sites assumption, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e022" xlink:type="simple"/></inline-formula> is the <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e023" xlink:type="simple"/></inline-formula>'th element of the joint substitution matrix for a single site and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e024" xlink:type="simple"/></inline-formula> is the corresponding element of the conditional matrix. The conditional matrix is in fact the matrix exponential <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e025" xlink:type="simple"/></inline-formula>, where <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e026" xlink:type="simple"/></inline-formula> is the substitution rate matrix <xref ref-type="bibr" rid="pcbi.1000483-Holmes2">[24]</xref>. Composition of two branches just amounts to a matrix multiplication.</p>
<p>A similar formalism can be used to describe the evolution of whole sequences with indels. Suppose that the joint distribution <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e027" xlink:type="simple"/></inline-formula> is the distribution modeled by a pair hidden Markov model (Pair HMM) <xref ref-type="bibr" rid="pcbi.1000483-Durbin1">[11]</xref>, a probabilistic model of the evolution of two sequences under the approximation that only adjacent characters are directly correlated, and the marginal <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e028" xlink:type="simple"/></inline-formula> is the distribution of a single-sequence HMM, a probabilistic model of single sequences under the same approximation. The conditional distribution <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e029" xlink:type="simple"/></inline-formula> then corresponds to a conditional Pair HMM, a discrete-state machine which transforms one sequence (the input, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e030" xlink:type="simple"/></inline-formula>) into another (the output, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e031" xlink:type="simple"/></inline-formula>). Following computational linguists, we call this conditionally-normalized state machine a <bold>string transducer</bold> or simply a <bold>transducer</bold> <xref ref-type="bibr" rid="pcbi.1000483-Bradley2">[35]</xref>. Because of its conditional normalization, this state machine is distinct from a standard Pair HMM. A Pair HMM has two outputs <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e032" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e033" xlink:type="simple"/></inline-formula> and emits symbols to both of those outputs, while a transducer absorbs symbols from the input <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e034" xlink:type="simple"/></inline-formula> and emits symbols to the output <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e035" xlink:type="simple"/></inline-formula>. Despite this distinction, Pair HMMs and transducers share very similar inference algorithms; for example, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e036" xlink:type="simple"/></inline-formula> is computed using a direct analogue of the Forward algorithm <xref ref-type="bibr" rid="pcbi.1000483-Durbin1">[11]</xref>.</p>
<p>We extend this formalism to the case of structured RNA as follows. Let <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e037" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e038" xlink:type="simple"/></inline-formula> now represent structured RNA sequences or, more precisely, parse trees. A single-sequence SCFG models the marginal <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e039" xlink:type="simple"/></inline-formula>; a jointly-normalized Pair SCFG <xref ref-type="bibr" rid="pcbi.1000483-Durbin1">[11]</xref> models the the joint distribution <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e040" xlink:type="simple"/></inline-formula>. The conditional distribution <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e041" xlink:type="simple"/></inline-formula> is modeled by a conditionally-normalized Pair SCFG. Following terminology from computational linguistics <xref ref-type="bibr" rid="pcbi.1000483-Comon1">[36]</xref>, we call this conditionally-normalized grammar a <bold>parse-tree transducer</bold>.</p>
<p>String transducers are special cases of parse-tree transducers, just as HMMs are special cases of SCFGs. Henceforth, we will drop the distinction between strings and parse trees. We will also refer interchangeably to “states” (in the state-machine representation) and “nonterminals” (in the grammar representation). Likewise, we will refer interchangeably to “state paths” (machines) and “parse trees” (grammars).</p>
<sec id="s2b1">
<title>Terminology and normalization</title>
<p>Consider the stochastic grammar which generates parse trees from the marginal distribution <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e042" xlink:type="simple"/></inline-formula>. It is convenient to represent this grammar as a transducer whose input is constrained to be null, i.e. a machine that accepts a dummy (empty) input sequence, and outputs sequence <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e043" xlink:type="simple"/></inline-formula>. We refer to this as the <bold>singlet transducer</bold>. In contrast, the more general type of transducer that absorbs parse trees <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e044" xlink:type="simple"/></inline-formula> and generates modified parse trees <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e045" xlink:type="simple"/></inline-formula> from the conditional distribution <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e046" xlink:type="simple"/></inline-formula> is a <bold>branch transducer</bold>. By definition, singlet transducers only emit symbols to their output sequence, and use a restricted set of state types. Branch transducers, in contrast, can both emit symbols to their outputs and absorb symbols from their inputs, and so use the full range of state types.</p>
<p>Transducers can have states of type <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e047" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e048" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e049" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e050" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e051" xlink:type="simple"/></inline-formula>. The first three state types, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e052" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e053" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e054" xlink:type="simple"/></inline-formula>, are null: they do not emit or absorb any symbols and are required solely for organizational purposes (see following section). Two types of states can emit and/or absorb symbols, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e055" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e056" xlink:type="simple"/></inline-formula>. An <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e057" xlink:type="simple"/></inline-formula> state emits a symbol to the output without absorbing anything. A <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e058" xlink:type="simple"/></inline-formula> state absorbs a symbol on the input and either emits the same symbol to the output, substitutes a different output symbol, or emits no output symbol at all, the last corresponding to a deletion.</p>
<p>As stated above, the Pair SCFG must be conditionally normalized so that models can be chained together, extending the pairwise model to multiple sequences. The transformation rules are partitioned into co-normalized groups; within each group, the rule probabilities must sum to one. In a jointly-normalized Pair SCFG, each group corresponds to the set of all rules that can be applied to a given nonterminal (i.e., all outgoing transitions from a particular state). In a conditionally-normalized Pair SCFG, in contrast, each co-normalized group includes all rules that can be applied to a given nonterminal <italic>for a given set of absorbed symbols</italic>.</p>
</sec></sec><sec id="s2c">
<title>Multiple-sequence models</title>
<p>We can use the concepts of factoring probability distributions introduced in the two-sequence framework to model the common descent of many homologous sequences. Given a phylogenetic tree and a two-sequence model, we wish to obtain a multiple-sequence SCFG describing the common descent of the observed sequences.</p>
<p>A singlet transducer (which emits, but does not absorb, symbols) lies at the root of the phylogeny and serves as a generative model of the ancestral sequence. To represent the evolution of an ancestral sequence into many descendant sequences, we place a branch transducer on each branch of the phylogeny.</p>
<p>Throughout this paper we frequently refer to two and three-taxon (star) phylogenies. In all cases, the sequence <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e059" xlink:type="simple"/></inline-formula> is assumed to be the (unobserved) ancestral sequence and the sequences <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e060" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e061" xlink:type="simple"/></inline-formula>, and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e062" xlink:type="simple"/></inline-formula> the (observed) extant sequences.</p>
<sec id="s2c1">
<title>The composition algorithm</title>
<p>While this composition of conditionally-normalized models on a phylogenetic tree is intuitive, in practice building such an ensemble model is challenging due to the sheer number of possible states and transitions of the ensemble model. The maximum possible state space of the ensemble is the Cartesian product of the individual transducer state spaces. If the singlet transducer has <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e063" xlink:type="simple"/></inline-formula> states, each branch transducer has <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e064" xlink:type="simple"/></inline-formula> states, and the phylogeny has <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e065" xlink:type="simple"/></inline-formula> branches, then an upper bound on the number of ensemble states is <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e066" xlink:type="simple"/></inline-formula>. However, in practice there are many fewer states than suggested by this bound; many state configurations are not reachable. For example, for the tree with two extant sequences and a single parent, the branch transducers above leaves <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e067" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e068" xlink:type="simple"/></inline-formula> cannot simultaneously be in <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e069" xlink:type="simple"/></inline-formula> states, as this would correspond to aligning non-homologous (inserted) characters. Similarly, while an upper bound on the number of possible transitions in the transition matrix of the ensemble model is <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e070" xlink:type="simple"/></inline-formula>, in practice models never reach this bound, due both to inaccessible configurations, such as the one described above, and the sparseness of transitions between the remaining, accessible configurations.</p>
<p>While the accessible state space of the ensemble is smaller than that given by the exponential upper bound, it is generally nonetheless too complex to deal with by hand. For example, the simple model of RNA structural evolution described in <xref ref-type="sec" rid="s3">Results</xref> yields an ensemble model of three sequences with 230 states and 1,789 transitions. More realistic models of RNA give rise to even larger ensemble models.</p>
<p>We therefore need an algorithm to efficiently construct the state graph of the ensemble model, consisting of a list of accessible states and the possible transitions between them. By analogy with algorithms for uninformed graph search in artificial intelligence, the transition graph of the ensemble can be constructed by an uninformed depth-first search, where at each step of the search we obtain the next possible ensemble states by changing the state of one or more of the singlet or branch transducers. Beginning with the entire ensemble in state <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e071" xlink:type="simple"/></inline-formula>, the depth-first search of states continues until all nodes are in state <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e072" xlink:type="simple"/></inline-formula>.</p>
<p>The allowed transitions of the ensemble can be categorized as follows:</p>
<list list-type="simple"><list-item>
<p><bold>Null Transition:</bold> A branch transducer makes a transition into a <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e073" xlink:type="simple"/></inline-formula> state, with no terminal emission or bifurcation.</p>
</list-item><list-item>
<p><bold>Terminal Emission:</bold> A singlet or branch transducer makes a transition into a state of type <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e074" xlink:type="simple"/></inline-formula>, emitting left and/or right terminal symbols (e.g., a single base or base-pair). These symbols are absorbed by the immediately-descended transducers, which are pushed into states of type <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e075" xlink:type="simple"/></inline-formula> and may themselves emit terminal symbols that will be absorbed by <italic>their</italic> descendant transducers. This continues down the tree: The terminal symbols are passed from parents to children to grandchildren (albeit possibly being replaced by other terminal symbols as they are propagated down) and they propel branch transducers into <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e076" xlink:type="simple"/></inline-formula> states as they go. Eventually, the cascade of emitted terminal symbols stops when all the symbols have been deleted or when the cascade reaches the leaves of the tree.</p>
</list-item><list-item>
<p><bold>Bifurcation:</bold> A singlet or branch transducer makes a transition into a state of type <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e077" xlink:type="simple"/></inline-formula> that spawns left and/or right nonterminal states. These nonterminals are processed recursively down the tree, just as in a terminal emission (conceptually, a bifurcation is a “nonterminal emission”). As with terminal emissions, absorption of nonterminal emissions propels descendant transducers into <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e078" xlink:type="simple"/></inline-formula> states, making transitions which may themselves propagate nonterminals further down the tree. A biologically-relevant example of a bifurcation is the insertion of a stem into an ancestral RNA structure, which may then be conserved or deleted in the descendant structures.</p>
</list-item><list-item>
<p><bold>End Transition:</bold> The singlet transducer at the root makes a transition to the <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e079" xlink:type="simple"/></inline-formula> state, pushing all the descendant branch transducers into <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e080" xlink:type="simple"/></inline-formula> states and terminating the current branch of the parse tree.</p>
</list-item></list>
<p>Co-ordination between the various branch machines is achieved by specifying an ordering on the nodes and by having branch transducers pause in <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e081" xlink:type="simple"/></inline-formula> states while waiting to absorb a symbol from the node above. Only one transducer is allowed to make a spontaneous transition at a time. If this transition corresponds to a terminal emission or a bifurcation, then this may force descendant transducers into making reactive transitions.</p>
<p>The four types of allowed transitions listed above can be formalized as follows. Let the total order on the nodes correspond to any preorder traversal of the tree; thus, “<inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e082" xlink:type="simple"/></inline-formula> is ancestral to <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e083" xlink:type="simple"/></inline-formula>” is sufficient-but-not-necessary for “<inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e084" xlink:type="simple"/></inline-formula>.” Let <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e085" xlink:type="simple"/></inline-formula> denote the singlet or branch transducer which emits symbols to node <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e086" xlink:type="simple"/></inline-formula>. Transducer <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e087" xlink:type="simple"/></inline-formula> changes state if and only if one of the following three mutually-exclusive conditions holds:</p>
<list list-type="simple"><list-item>
<p>Type 1: Transducer <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e088" xlink:type="simple"/></inline-formula> is not in a <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e089" xlink:type="simple"/></inline-formula> state, while all its successor transducers <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e090" xlink:type="simple"/></inline-formula> are in <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e091" xlink:type="simple"/></inline-formula> states (where <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e092" xlink:type="simple"/></inline-formula>). <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e093" xlink:type="simple"/></inline-formula> is free to make any transition.</p>
</list-item><list-item>
<p>Type 2: Transducer <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e094" xlink:type="simple"/></inline-formula> is in a <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e095" xlink:type="simple"/></inline-formula> state. Its parent transducer enters a <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e096" xlink:type="simple"/></inline-formula> or <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e097" xlink:type="simple"/></inline-formula> state, emitting a symbol and forcing <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e098" xlink:type="simple"/></inline-formula> into a <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e099" xlink:type="simple"/></inline-formula> state so it can absorb that symbol.</p>
</list-item><list-item>
<p>Type 3: Transducer <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e100" xlink:type="simple"/></inline-formula> is in a <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e101" xlink:type="simple"/></inline-formula> state. Its parent transducer enters the <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e102" xlink:type="simple"/></inline-formula> state, forcing <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e103" xlink:type="simple"/></inline-formula> into the <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e104" xlink:type="simple"/></inline-formula> state as well.</p>
</list-item></list>
<p>A notational prescription for the allowed transitions may be found in <xref ref-type="supplementary-material" rid="pcbi.1000483.s001">Text S1</xref>.</p>
</sec><sec id="s2c2">
<title>How the ensemble generates multiple alignments</title>
<p>The possible transitions of the ensemble generate multiple alignments as follows:</p>
<list list-type="order"><list-item>
<p>The singlet transducer and all branch transducers begin in their respective <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e105" xlink:type="simple"/></inline-formula> states.</p>
</list-item><list-item>
<p>Before any residues can appear at the root, the branch transducers all wind back into <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e106" xlink:type="simple"/></inline-formula> states, via type-1 transitions. This occurs in reverse order (i.e., a postorder traversal of the tree).</p>
</list-item><list-item>
<p>During this initial windback, clade-specific insertions can occur. This process is described in detail at step 9.</p>
</list-item><list-item>
<p>With all the branch transducers wound back into <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e107" xlink:type="simple"/></inline-formula> states, the singlet transducer makes a (type-1) transition into an <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e108" xlink:type="simple"/></inline-formula> state, emitting a symbol to the sequence at the root node.</p>
</list-item><list-item>
<p>The transducers on outgoing branches from the root then make (type-2) transitions into <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e109" xlink:type="simple"/></inline-formula> states, either copying the root symbol to their own outputs, substituting it for a different symbol or staying silent (this silence corresponds to a clade-specific deletion; in our formalism, both substitutions and deletions are handled by <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e110" xlink:type="simple"/></inline-formula> states.)</p>
</list-item><list-item>
<p>The transducers on branches one step away from the root then process the symbols which reached them (if any did), followed by transducers on branches two steps away from the root, then three steps, and so on (these can all be regarded as occurring simultaneously, in a single cascading wave of emissions).</p>
</list-item><list-item>
<p>Eventually the emitted symbols are propagated, via type-2 transitions, all the way to the tips of the tree (if they survived) or to the nodes where they were deleted (if they did not survive). The wave of type-2 transitions has left a lot of branch transducers in <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e111" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e112" xlink:type="simple"/></inline-formula> states.</p>
</list-item><list-item>
<p>The branch transducers then, in postorder, each wind back into <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e113" xlink:type="simple"/></inline-formula> states, just as at step 2. (These windback transitions can be collapsed into a single ensemble transition, as with the emission cascade; however, the windback may be interrupted by clade-specific insertions; see below.)</p>
</list-item><list-item>
<p>During the postorder windback, each branch transducer gets an opportunity to generate a new symbol (via type-1 transitions to <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e114" xlink:type="simple"/></inline-formula> states). (If such a transition to <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e115" xlink:type="simple"/></inline-formula> occurs, it corresponds to a clade-specific insertion. This insertion is propagated down the tree via a wave of type-2 transitions, as above, then we go back to step 7.)</p>
</list-item><list-item>
<p>Eventually, the entire ensemble has wound back, so that every transducer is in a <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e116" xlink:type="simple"/></inline-formula> state except the singlet transducer at the root, which is still in an <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e117" xlink:type="simple"/></inline-formula> state. At this point, all clade-specific insertions have been processed.</p>
</list-item><list-item>
<p>The singlet transducer now makes another type-1 transition. If this transition is to an <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e118" xlink:type="simple"/></inline-formula> state, the entire cycle begins again: the singlet transducer emits the next symbol at the root, and we go back to step 4.</p>
</list-item><list-item>
<p>If, on the other hand, the singlet transducer enters its <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e119" xlink:type="simple"/></inline-formula> state, then a wave of type-3 transitions drives all the branch transducers into their respective <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e120" xlink:type="simple"/></inline-formula> states too, bringing the entire ensemble to a halt.</p>
</list-item></list>
</sec><sec id="s2c3">
<title>Complexity of the transducer ensemble</title>
<p>The total sizes of both the state space and the transition matrix are, in general, dramatically smaller than implied by the exponential upper bounds of <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e121" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e122" xlink:type="simple"/></inline-formula>. While we do not have provable bounds on the size of the state space, we have observed that the size of the state space is roughly linear in the number of branches, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e123" xlink:type="simple"/></inline-formula>, and the number of transitions is approximately linear in the number of states for several pairwise models, including the pairwise model which we use here. However, these empirical observations are based on a limited class of pairwise models and we do not have theoretical results for how they will generalize to other pairwise models. We do believe, however, that the worst-case exponential bound will be avoided by (1) omitting inaccessible state configurations and (2) eliminating null windback states as described in the following section (which we believe will prevent affine gap penalties from generating exponential growth in the number of states).</p>
<p>Therefore, for the models which we have characterized, the search algorithm given above for enumerating all allowed transitions of the ensemble model typically generates <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e124" xlink:type="simple"/></inline-formula> transitions from any given state, thereby creating a very sparse transition matrix of size <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e125" xlink:type="simple"/></inline-formula>.</p>
</sec></sec><sec id="s2d">
<title>Inference algorithms for multiple-sequence models</title>
<p>In this section, we describe dynamic programming (DP) algorithms for inferring the alignment, structure and evolutionary history of multiple related RNAs, using the multiple-sequence SCFG we have derived.</p>
<p>The transducer composition algorithm described above constructs a phylogenetic SCFG for both ancestral and extant sequences. A parse tree for this SCFG represents a structural and evolutionary explanation of the extant sequences, including a complete ancestral reconstruction. Consequently, given a set of extant sequences, many of the questions of interest to us can be reduced to searches over, or summarizations of, the set of possible parse trees.</p>
<p>Well-known algorithms already exist for maxing or summing over SCFG parse tree likelihoods. The Cocke-Younger-Kasami (CYK) algorithm performs maximum-likelihood (ML) inference; the Inside algorithm can be used to sum over parse trees or sample them <italic>a posteriori</italic>; and the Inside-Outside algorithm yields posterior probabilities for individual parse tree nodes <xref ref-type="bibr" rid="pcbi.1000483-Durbin1">[11]</xref>.</p>
<p>All of these algorithms are, however, complicated (at least in our models) by the existence of “null cycles” in the grammar. A null cycle is a parse tree fragment that is redundant and could be removed, such as a detour through <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e126" xlink:type="simple"/></inline-formula> states (<inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e127" xlink:type="simple"/></inline-formula>) that could be replaced by a direct transition (<inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e128" xlink:type="simple"/></inline-formula>). Biologically, null cycles correspond to fragments of ancestral sequence that were universally deleted and therefore are unobserved in any of the extant sequences. These unobserved fragments can be unbounded in length (and so, therefore, can the parse tree). Within the CYK, Inside and Outside recursions, this causes cyclic dependencies which cannot be resolved.</p>
<p>Below we describe a method to eliminate null cycles from the ensemble model by transforming any SCFG to an equivalent acyclic SCFG. We then present multiple-sequence versions of the CYK, Inside and Outside algorithms.</p>
<p>While some sort of null-cycle elimination is often required in order to deal with cyclic dependencies, there are several ways to accomplish this other than the algorithm presented below. A simpler approach (that only works for the CYK algorithm) appears in the computational linguistics literature <xref ref-type="bibr" rid="pcbi.1000483-Gecseg1">[37]</xref>. We have also developed a heuristic for CYK that simply ignores null cycles as well as an iterative approximation that loops several times over cyclically-dependent cells of the DP matrix until the estimate starts to converge. For conciseness, we have omitted descriptions of these methods, presenting only the exact elimination algorithm.</p>
<sec id="s2d1">
<title>Exact elimination of null cycles in SCFGs</title>
<p>As noted above, the ensemble grammar contains many rules that can be applied redundantly, together or in isolation, to generate subtrees of the parse tree that do not generate any terminals. This generates cyclic dependencies in the standard DP recursions for inference. In this subsection, we describe how to transform the SCFG so as to eliminate such redundant rules, yielding strictly acyclic DP recursions. This transformation can be applied to any SCFG so as to remove null states and/or bifurcations: the procedure is not restricted to grammars that were generated using our transducer composition algorithm.</p>
<p>We begin by identifying two distinct classes of redundant parse-subtree: <bold>empty bifurcations</bold> and <bold>empty paths</bold>. We will eliminate each of these in turn.</p>
<p>An <bold>empty bifurcation</bold> occurs when a child branch of a bifurcation state transitions to the <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e129" xlink:type="simple"/></inline-formula> state without emitting any symbols and can be removed from the model by creating an effective direct transition encapsulating the empty bifurcation. For example, we can create an effective direct transition <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e130" xlink:type="simple"/></inline-formula> between null states <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e131" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e132" xlink:type="simple"/></inline-formula> in place of the empty parse-subtree <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e133" xlink:type="simple"/></inline-formula>, where <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e134" xlink:type="simple"/></inline-formula> is a bifurcation state with children <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e135" xlink:type="simple"/></inline-formula>. Bifurcation states are the most computationally-costly part of our models, so it is important to eliminate as many as possible without reducing model expressiveness.</p>
<p>In contrast, an <bold>empty path</bold> is defined as any parse-subtree <italic>without</italic> bifurcations that does not emit terminal symbols. If <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e136" xlink:type="simple"/></inline-formula> states <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e137" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e138" xlink:type="simple"/></inline-formula> are connected in the state graph via <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e139" xlink:type="simple"/></inline-formula> states <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e140" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e141" xlink:type="simple"/></inline-formula>, then the path <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e142" xlink:type="simple"/></inline-formula> with probability <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e143" xlink:type="simple"/></inline-formula> can be replaced by a single direct transition <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e144" xlink:type="simple"/></inline-formula> with an identical probability.</p>
<p>Empty paths occur in Hidden Markov Models (which are special cases of SCFGs) and independent-sites models (which can be viewed as special cases of HMMs). Conceptually, empty paths can represent histories that are valid according to the model but cannot be resolved by direct observation. Such null events can be real (e.g., ancestral residues that have been deleted in all extant lineages) or they can be artefactual (e.g., transitions between placeholder null states of an HMM).</p>
<p>In our composite model, empty paths occur whenever a series of branch transducers winds back into <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e145" xlink:type="simple"/></inline-formula> states. Empty bifurcations occur when an entire substructure, present in an ancestor, is deleted in all that ancestor's extant descendants.</p>
<p>Empty paths and empty bifurcations are problematic because they can be combined to give finite-probability sequences of rules that transform a nonterminal back into itself, with no observable emissions. We refer to such sequences of rules as <bold>null cycles</bold>. As noted, null cycles generate cyclic dependencies in the CYK, Inside &amp; Outside algorithms. Our goal is an algorithmic procedure to resolve these dependencies and account for the likelihood of such cycles by exact marginalization.</p>
<p>For simpler models, solutions to this problem are published. Missing (empty) columns in independent-sites models can be accounted for by applying a correction factor <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e146" xlink:type="simple"/></inline-formula> to account for the proportion of columns <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e147" xlink:type="simple"/></inline-formula> that are unobserved <xref ref-type="bibr" rid="pcbi.1000483-Rivas3">[38]</xref>. The slightly more complicated situation of missing emissions in a HMM can be dealt with by summing over all empty paths, yielding a geometric series that is solvable by matrix inversion <xref ref-type="bibr" rid="pcbi.1000483-Holmes5">[39]</xref>–<xref ref-type="bibr" rid="pcbi.1000483-Lunter1">[41]</xref>. Such algorithms effectively replace the HMM with another HMM that contains no null cycles but is equivalent to the original, in that it models the same probability distribution over sequences. However, these solutions do not easily generalize to SCFGs (which may have empty bifurcations as well as empty paths).</p>
<p><xref ref-type="supplementary-material" rid="pcbi.1000483.s002">Text S2</xref> includes a complete formal algorithm for exact null-cycle elimination in SCFGs, along with procedures for probabilistically restoring null cycles to sampled parse trees and Inside-Outside expectation counts. Informally, the essence of the algorithm is contained within the following two steps:</p>
<list list-type="roman-lower"><list-item>
<p>separating bifurcations into those which have one or more empty children (and can therefore be represented using transition or termination rules) and those that have two nonempty children;</p>
</list-item><list-item>
<p>replacing all empty paths through null states with effective direct transitions between non-null states, obtaining sum-over-paths probabilities by inverting the grammar's transition matrix.</p>
</list-item></list>
<p>Note that step (i) is unique to SCFGs; step (ii), in contrast, is very similar to the empty-path elimination algorithm for HMMs.</p>
</sec><sec id="s2d2">
<title>Dynamic programming algorithms for inference</title>
<p>Once we have performed the transformations described above to remove null cycles from the multiple-sequence SCFGs generated by our model-construction algorithm, we can compute likelihoods and sample parse trees using the standard CYK, Inside and Outside algorithms for multiple-sequence SCFGs <xref ref-type="bibr" rid="pcbi.1000483-Durbin1">[11]</xref>,<xref ref-type="bibr" rid="pcbi.1000483-Sankoff1">[42]</xref>.</p>
<p>The asymptotic time and memory complexities of our inference algorithms are essentially the same as for Sankoff's algorithm <xref ref-type="bibr" rid="pcbi.1000483-Sankoff1">[42]</xref>: the DP algorithms take memory <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e148" xlink:type="simple"/></inline-formula> and time <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e149" xlink:type="simple"/></inline-formula> for <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e150" xlink:type="simple"/></inline-formula> sequences of length <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e151" xlink:type="simple"/></inline-formula>, where <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e152" xlink:type="simple"/></inline-formula> is the number of (accessible) states in the multiple-SCFG and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e153" xlink:type="simple"/></inline-formula> is the number of bifurcations. Note that <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e154" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e155" xlink:type="simple"/></inline-formula> are also dependent on <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e156" xlink:type="simple"/></inline-formula> (see “The TKFST model on a three-taxon phylogeny”).</p>
<p>Exact inference on a star phylogeny with <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e157" xlink:type="simple"/></inline-formula> extant sequences therefore has complexities <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e158" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e159" xlink:type="simple"/></inline-formula> in memory and time (respectively) for a multiple-SCFG with <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e160" xlink:type="simple"/></inline-formula> states and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e161" xlink:type="simple"/></inline-formula> bifurcations. As described earlier, in practice we frequently have expert knowledge (such as a curated multiple alignment) about the structures and/or evolutionary histories of the sequences of interest. We can use this knowledge as a constraint to reduce the accessible volume, and hence the storage requirements, of the DP matrix <xref ref-type="bibr" rid="pcbi.1000483-Holmes1">[18]</xref>. The Inside, Outside, and CYK+traceback algorithms for a three-taxon star phylogeny can be constrained using the “fold envelope” concept, which will now be described.</p>
<p>We use the fold envelope concept <xref ref-type="bibr" rid="pcbi.1000483-Holmes3">[29]</xref>,<xref ref-type="bibr" rid="pcbi.1000483-Holmes7">[43]</xref> to constrain the set of structures which our algorithms consider. A fold envelope <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e162" xlink:type="simple"/></inline-formula> for a sequence <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e163" xlink:type="simple"/></inline-formula> is a set of coordinate pairs satisfying<disp-formula><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e164" xlink:type="simple"/><label>(1)</label></disp-formula>We consider a subsequence <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e165" xlink:type="simple"/></inline-formula> only if the corresponding coordinate pair <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e166" xlink:type="simple"/></inline-formula>. The unconstrained fold envelope has set equality in Equation 1.</p>
<p>An <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e167" xlink:type="simple"/></inline-formula> ordering is used for the iteration in the Inside algorithm: Subsequences are ordered such that each successive subsequence contains all previous subsequences in the fold envelope. More precisely, subsequences in <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e168" xlink:type="simple"/></inline-formula> are sorted in the same order as coordinate pairs <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e169" xlink:type="simple"/></inline-formula> are generated by the iteration <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e170" xlink:type="simple"/></inline-formula>.</p>
<p>The Outside algorithm uses the exact reverse of the <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e171" xlink:type="simple"/></inline-formula> ordering described above; we call this the <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e172" xlink:type="simple"/></inline-formula> ordering. Subsequences in <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e173" xlink:type="simple"/></inline-formula> are sorted in the same order as coordinate pairs <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e174" xlink:type="simple"/></inline-formula> are generated by the iteration <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e175" xlink:type="simple"/></inline-formula>.</p>
<p>We frequently refer to subsequences by their index in the fold envelope. The <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e176" xlink:type="simple"/></inline-formula> subsequence in <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e177" xlink:type="simple"/></inline-formula> is labeled <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e178" xlink:type="simple"/></inline-formula> and corresponds to the coordinate pair <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e179" xlink:type="simple"/></inline-formula>. The index of a pair <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e180" xlink:type="simple"/></inline-formula> is <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e181" xlink:type="simple"/></inline-formula>.</p>
<p>In order to take full advantage of the reduction in computational complexity offered by restricting our inference algorithms to subsequences contained in the fold envelopes, we must avoid iterating over unreachable combinations of subsequences (unreachable because they are not permitted by the fold envelope constraints). An efficient implementation relies on iterators over subsequences in the fold envelope which are connected by production rules of the ensemble grammar. Inward and outward emission connections for a sequence <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e182" xlink:type="simple"/></inline-formula>, specifying which subsequence is reachable from a given subsequence <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e183" xlink:type="simple"/></inline-formula> and ensemble state <bold><italic>b</italic></bold>, are defined as<disp-formula><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e184" xlink:type="simple"/></disp-formula>where the quantities <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e185" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e186" xlink:type="simple"/></inline-formula> are the lengths of the left and right emissions of the ensemble state <bold><italic>b</italic></bold> to the sequence <italic>X</italic>. (Recall that the m<sup>th</sup> subsequence in <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e187" xlink:type="simple"/></inline-formula> is labeled <italic>m</italic><sup>(<italic>X</italic>)</sup> and corresponds to the coordinate pair (<italic>i<sub>m</sub></italic>, <italic>j<sub>m</sub></italic>).) The emission connection is undefined if the corresponding subsequence is not in the fold envelope. Inward, outward-left and outward-right bifurcation connections, specifying which subsequences are connected by bifurcation production rules of the ensemble SCFG, are defined for a subsequence <italic>n</italic><sup>(<italic>X</italic>)</sup> as<disp-formula><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e188" xlink:type="simple"/><label>(2)</label></disp-formula><disp-formula><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e189" xlink:type="simple"/><label>(3)</label></disp-formula><disp-formula><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e190" xlink:type="simple"/><label>(4)</label></disp-formula>We generally write out explicit subsequence coordinate pairs (<italic>i</italic>, <italic>j</italic>) when their usage will make mathematical formulas clearer and fold-envelope labels <italic>n</italic><sup>(<italic>X</italic>)</sup> when writing pseudocode.</p>
<p>Using the fold envelope formalism, the main iteration over cells in the Inside and CYK matrices can be expressed as three nested loops: one for each sequence, traversing the fold envelope subsequences in inside→outside order. Conversely, the main iteration of the Outside algorithm consists of three nested outside→inside loops.</p>
<p>The Inside algorithm is used to calculate the likelihood of sequences under an ensemble model. It is analogous to the Forward algorithm for HMMs.</p>
<p>The inside probability <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e491" xlink:type="simple"/></inline-formula>(<italic>n</italic><sup>(<italic>X</italic>)</sup>, <italic>n</italic><sup>(<italic>Y</italic>)</sup>, <italic>n</italic><sup>(<italic>Z</italic>)</sup>) is the summed probability of the triplet of subsequences (<italic>n</italic><sup>(<italic>X</italic>)</sup>, <italic>n</italic><sup>(<italic>Y</italic>)</sup>, <italic>n</italic><sup>(<italic>Z</italic>)</sup>) for sequences <italic>X</italic>,<italic>Y</italic>,<italic>Z</italic> under all paths through the model which are rooted in state <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e490" xlink:type="simple"/></inline-formula>. <xref ref-type="fig" rid="pcbi-1000483-g001">Figure 1</xref> gives pseudocode for the fold-envelope version of the Inside algorithm. The subroutines calcTransEmitProb, calcLBifurcProb and calcRBifurcProb used in the Inside algorithm are defined below.</p>
<fig id="pcbi-1000483-g001" position="float"><object-id pub-id-type="doi">10.1371/journal.pcbi.1000483.g001</object-id><label>Figure 1</label><caption>
<title>Algorithm 1.</title>
<p>The constrained Inside algorithm for three sequences <italic>X</italic>, <italic>Y</italic>, <italic>Z</italic>. Ensemble states <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e490" xlink:type="simple"/></inline-formula> in the iteration over states are sorted in Inside fill order with Emit states first, then Null states in reverse topological order.</p>
</caption><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.g001" xlink:type="simple"/></fig>
<p>The transition and emission probability calcTransEmitProb(<inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e490" xlink:type="simple"/></inline-formula>; ·) can be calculated by iterating over ensemble states <bold><italic>b</italic></bold> which connect the subsequence triplet (<italic>n</italic><sup>(<italic>X</italic>)</sup>, <italic>n</italic><sup>(<italic>Y</italic>)</sup>, <italic>n</italic><sup>(<italic>Z</italic>)</sup>) to others in the fold envelopes.</p>
<p>Pseudocode for the constrained calculation is given in <xref ref-type="fig" rid="pcbi-1000483-g002">Figure 2</xref>.</p>
<fig id="pcbi-1000483-g002" position="float"><object-id pub-id-type="doi">10.1371/journal.pcbi.1000483.g002</object-id><label>Figure 2</label><caption>
<title>Algorithm 2.</title>
<p>Subroutine calcTransEmitProb() for the Inside algorithm. <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e490" xlink:type="simple"/></inline-formula> and <italic>b</italic> are ensemble states; <italic>l</italic> and <italic>r</italic> are left and right terminal emissions.</p>
</caption><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.g002" xlink:type="simple"/></fig>
<p>The left-bifurcation probability for an ensemble state <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e490" xlink:type="simple"/></inline-formula> bifurcating to two ensemble states, calcLBifurcProb (<inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e490" xlink:type="simple"/></inline-formula>; <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e191" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e192" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e193" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e194" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e195" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e196" xlink:type="simple"/></inline-formula>), is<disp-formula><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e197" xlink:type="simple"/></disp-formula>and the right-bifurcation probability for an ensemble state <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e490" xlink:type="simple"/></inline-formula> bifurcating to two ensemble states, calcRBifurcProb (<inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e490" xlink:type="simple"/></inline-formula>; <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e198" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e199" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e200" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e201" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e202" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e203" xlink:type="simple"/></inline-formula>), is<disp-formula><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e204" xlink:type="simple"/></disp-formula>The boundary condition of the probability of 0-length subsequences is determined by the probability of transitions to End. The termination condition is<disp-formula><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e205" xlink:type="simple"/></disp-formula>where Start is the unique start state of the ensemble grammar and <italic>N</italic><sup>(<italic>X</italic>)</sup> is the outermost subsequence for sequence <italic>X</italic>, etc.</p>
<p>Note that we are assuming that the transformations described in “Exact elimination of null cycles in SCFGs” have been performed, such that there are no cycles of Null states as well as no empty bifurcations.</p>
<p>The CYK algorithm is used to calculate the probability of the most-likely state path (or parse) capable of generating the input sequences. It is analogous to the Viterbi algorithm for HMMs.</p>
<p>The CYK algorithm can be obtained from the Inside algorithm by replacing sums over paths through the ensemble model with the max operation. The CYK probability for indices <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e492" xlink:type="simple"/></inline-formula>(<italic>n</italic><sup>(<italic>X</italic>)</sup>, <italic>n</italic><sup>(<italic>Y</italic>)</sup>, <italic>n</italic><sup>(<italic>Z</italic>)</sup>) then represents the probability of the most likely path through the model generating the triplet of subsequences (<italic>n</italic><sup>(<italic>X</italic>)</sup>, <italic>n</italic><sup>(<italic>Y</italic>)</sup>, <italic>n</italic><sup>(<italic>Z</italic>)</sup>).</p>
<p>The resulting CYK algorithm is shown in <xref ref-type="fig" rid="pcbi-1000483-g003">Figure 3</xref>. The subroutine caleTransEmitProb is defined in <xref ref-type="fig" rid="pcbi-1000483-g004">Figure 4</xref>. The subroutines calcLBifurcProb and calcRBifurcProb used in the CYK algorithm are defined as<disp-formula><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e206" xlink:type="simple"/></disp-formula>and<disp-formula><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e207" xlink:type="simple"/></disp-formula></p>
<fig id="pcbi-1000483-g003" position="float"><object-id pub-id-type="doi">10.1371/journal.pcbi.1000483.g003</object-id><label>Figure 3</label><caption>
<title>Algorithm 3.</title>
<p>The constrained CYK algorithm for three sequences <italic>X</italic>, <italic>Y</italic>, <italic>Z</italic>. Ensemble states <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e490" xlink:type="simple"/></inline-formula> in the iteration over states are sorted in Inside fill order with Emit states first, then Null states in reverse topological order.</p>
</caption><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.g003" xlink:type="simple"/></fig><fig id="pcbi-1000483-g004" position="float"><object-id pub-id-type="doi">10.1371/journal.pcbi.1000483.g004</object-id><label>Figure 4</label><caption>
<title>Algorithm 4.</title>
<p>Subroutine calcTransEmitProb() for the CYK algorithm. <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e490" xlink:type="simple"/></inline-formula> and <italic>b</italic> are ensemble states; <italic>l</italic> and <italic>r</italic> are left and right terminal emissions.</p>
</caption><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.g004" xlink:type="simple"/></fig>
<p>The CYK traceback algorithm, in combination with the CYK algorithm, is used to find the most-likely state path generating the extant sequences (in other words, the maximum-likelihood parse generating the observed data). It is analogous to the Viterbi traceback algorithm for HMMs. <xref ref-type="fig" rid="pcbi-1000483-g005">Figure 5</xref> gives the constrained CYK traceback algorithm.</p>
<fig id="pcbi-1000483-g005" position="float"><object-id pub-id-type="doi">10.1371/journal.pcbi.1000483.g005</object-id><label>Figure 5</label><caption>
<title>Algorithm 5.</title>
<p>The constrained CYK traceback algorithm for three sequences <italic>X</italic>, <italic>Y</italic>, <italic>Z</italic>.</p>
</caption><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.g005" xlink:type="simple"/></fig>
<p>The Outside algorithm is primarily used an an intermediary for calculating nucleotide-level posterior probabilities, e.g. for posterior decoding on the model. It is analogous to the Backward algorithm for HMMs.</p>
<p>The outside probability <italic>β</italic><bold><italic><sub>b</sub></italic></bold> (<italic>n</italic><sup>(<italic>X</italic>)</sup>, <italic>n</italic><sup>(<italic>Y</italic>)</sup>, <italic>n</italic><sup>(<italic>Z</italic>)</sup>) for an ensemble state <bold><italic>b</italic></bold> is the summed probability of the sequences <italic>X</italic>,<italic>Y</italic>,<italic>Z</italic> under all paths through the ensemble model which are rooted in the start state of the model, excluding all paths for the triplet of subsequences (<italic>n</italic><sup>(<italic>X</italic>)</sup>, <italic>n</italic><sup>(<italic>Y</italic>)</sup>, <italic>n</italic><sup>(<italic>Z</italic>)</sup>) which are rooted in the ensemble state <bold><italic>b</italic></bold>. <xref ref-type="fig" rid="pcbi-1000483-g006">Figure 6</xref> gives pseudocode for the fold-envelope version of the Outside algorithm. The subroutines calcTransEmitProb, calcLBifurcProb and calcRBifurcProb used in the Outside algorithm are defined below.</p>
<fig id="pcbi-1000483-g006" position="float"><object-id pub-id-type="doi">10.1371/journal.pcbi.1000483.g006</object-id><label>Figure 6</label><caption>
<title>Algorithm 6.</title>
<p>The constrained Outside algorithm for three sequences <italic>X</italic>,<italic>Y</italic>,<italic>Z</italic>. Ensemble states <italic>a</italic> in the iteration over states are sorted in Outside fill order with Emit states first, then Null states in topological order.</p>
</caption><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.g006" xlink:type="simple"/></fig>
<p>As with the Inside and CYK algorithms, the transition and emission probability calcTransEmitProb can be calculated efficiently using the subsequence connections defined earlier (<xref ref-type="fig" rid="pcbi-1000483-g007">Figure 7</xref>). The left-bifurcation probability calcLBifurcProb (<bold><italic>b</italic></bold>; <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e208" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e209" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e210" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e211" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e212" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e213" xlink:type="simple"/></inline-formula>) is<disp-formula><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e214" xlink:type="simple"/></disp-formula>and the right-bifurcation probability calcRBifurcProb (<bold><italic>b</italic></bold>; <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e215" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e216" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e217" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e218" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e219" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e220" xlink:type="simple"/></inline-formula>) is<disp-formula><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e221" xlink:type="simple"/></disp-formula>The boundary condition is just<disp-formula><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e222" xlink:type="simple"/></disp-formula>where <italic>N</italic><sup>(<italic>X</italic>)</sup> is the outermost subsequence for sequence <italic>X</italic>, etc.</p>
<fig id="pcbi-1000483-g007" position="float"><object-id pub-id-type="doi">10.1371/journal.pcbi.1000483.g007</object-id><label>Figure 7</label><caption>
<title>Algorithm 7.</title>
<p>Subroutine calcTransEmitProb() for the Outside algorithm. <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e490" xlink:type="simple"/></inline-formula> and <italic>b</italic> are ensemble states; <italic>l</italic> and <italic>r</italic> are left and right terminal emissions.</p>
</caption><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.g007" xlink:type="simple"/></fig></sec></sec></sec><sec id="s3">
<title>Results</title>
<sec id="s3a">
<title>Automated grammar construction</title>
<p>We implemented our model construction algorithm on the three-taxon star phylogeny. Given a singlet transducer modeling ancestral structures and a branch transducer modeling structural evolution, our Perl modules generate C++ code for the corresponding jointly-normalized three-sequence (Triplet) SCFG. Any model of structural evolution which can be represented as a Pair SCFG and factored into singlet and branch transducers is permitted as input to the packages, allowing for flexible, automated model design. The available software is described in <xref ref-type="supplementary-material" rid="pcbi.1000483.s003">Text S3</xref>.</p>
</sec><sec id="s3b">
<title>A simple model of RNA structural evolution</title>
<p>We illustrated our method for building models of structured sequences using a model which was introduced in previous work, the TKF Structure Tree <xref ref-type="bibr" rid="pcbi.1000483-Holmes3">[29]</xref>, a simplified probabilistic model of the evolution of RNA structure.</p>
<p>The TKF Structure Tree (TKFST) model is based on the Thorne-Kishino-Felsenstein (TKF) model of the stochastic evolution of primary sequences via indel events <xref ref-type="bibr" rid="pcbi.1000483-Thorne1">[44]</xref>. In the original TKF model, sequence evolves under a time-homogeneous linear birth-death-immigration process <xref ref-type="bibr" rid="pcbi.1000483-Kendall1">[45]</xref>. Single characters (“links”) are inserted with rate <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e223" xlink:type="simple"/></inline-formula> and deleted with rate <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e224" xlink:type="simple"/></inline-formula>. At equilibrium, sequences obey a geometric length distribution with parameter <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e225" xlink:type="simple"/></inline-formula>. Although this model has flaws (e.g., it lacks affine gap penalties, rate heterogeneity and context-dependent mutation rates), it illustrates many of the key ideas used by more sophisticated indel models, notably the possibility for systematic derivation of pairwise alignment automata from first principles via analysis of birth-death processes <xref ref-type="bibr" rid="pcbi.1000483-Thorne1">[44]</xref>,<xref ref-type="bibr" rid="pcbi.1000483-Feller1">[46]</xref>.</p>
<p>The TKF Structure Tree model is an extension of the TKF model to RNA structure. In this model, loop and stem regions are mutually nested (<xref ref-type="fig" rid="pcbi-1000483-g008">Figure 8</xref>): the parameter <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e226" xlink:type="simple"/></inline-formula> determines the proportion of links within loop sequences that are nested stems, and every stem sequence has a nested loop at the end. Single bases are inserted and deleted in loops with rates <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e227" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e228" xlink:type="simple"/></inline-formula>; similarly, base-pairs are inserted and deleted in stems with rates <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e229" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e230" xlink:type="simple"/></inline-formula>. Both loops and stems have geometric length distributions with parameters <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e231" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e232" xlink:type="simple"/></inline-formula>. Insertions of a new stem into an existing loop sequence (or deletions of an existing stem) occur at the same rate as single-base insertions (or deletions) and can model large-scale structural changes (<xref ref-type="fig" rid="pcbi-1000483-g009">Figure 9</xref>).</p>
<fig id="pcbi-1000483-g008" position="float"><object-id pub-id-type="doi">10.1371/journal.pcbi.1000483.g008</object-id><label>Figure 8</label><caption>
<title>The TKF Structure Tree model represents the evolution of RNA structure as nested stem and loop sequences.</title>
<p>The model consists of recursively nested loop sequences (gray, horizontal) and stem sequences (black, vertical). The loops are sequences of unpaired bases and the stems are sequences of covarying base-pairs. Both loop and stem sequences evolve according to the Thorne-Kishino-Felsenstein (TKF) model <xref ref-type="bibr" rid="pcbi.1000483-Thorne1">[44]</xref> of molecular evolution. Figure is extended from a similar version in <xref ref-type="bibr" rid="pcbi.1000483-Holmes3">[29]</xref>.</p>
</caption><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.g008" xlink:type="simple"/></fig><fig id="pcbi-1000483-g009" position="float"><object-id pub-id-type="doi">10.1371/journal.pcbi.1000483.g009</object-id><label>Figure 9</label><caption>
<title>Evolution of a RNA structure under the TKF Structure Tree model.</title>
<p>The TKF Structure Tree model includes phenomena such as point mutations in loop sequences (<inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e233" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e234" xlink:type="simple"/></inline-formula>), covariant mutations in stem sequences (<inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e235" xlink:type="simple"/></inline-formula>), insertions in loop sequences (<inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e236" xlink:type="simple"/></inline-formula>), insertions in stem sequences (<inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e237" xlink:type="simple"/></inline-formula>), structural insertions (<inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e238" xlink:type="simple"/></inline-formula>), and structural deletions (<inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e239" xlink:type="simple"/></inline-formula>). Figure is extended from a similar version in <xref ref-type="bibr" rid="pcbi.1000483-Holmes3">[29]</xref>.</p>
</caption><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.g009" xlink:type="simple"/></fig>
<p>We parametrized the singlet and branch transducers of the TKFST model using estimates reported by a phylo-grammar for RNA secondary structure prediction, PFOLD <xref ref-type="bibr" rid="pcbi.1000483-Knudsen1">[16]</xref>, and an implementation of pairwise alignment for the TKF Structure Tree model, Evoldoer <xref ref-type="bibr" rid="pcbi.1000483-Holmes3">[29]</xref>. The equilibrium distributions of unpaired and paired nucleotides of the singlet and branch transducers, as well as the substitution models of unpaired and paired nucleotides of the branch transducers, were derived from the substitution rate matrices of the PFOLD program. These rate matrices, which have proven useful for RNA structure prediction <xref ref-type="bibr" rid="pcbi.1000483-Knudsen1">[16]</xref>,<xref ref-type="bibr" rid="pcbi.1000483-Dowell1">[17]</xref>,<xref ref-type="bibr" rid="pcbi.1000483-Bradley3">[47]</xref>, were derived from the Bayreuth tRNA database <xref ref-type="bibr" rid="pcbi.1000483-Sprinzl1">[48]</xref> and the European large subunit rRNA database <xref ref-type="bibr" rid="pcbi.1000483-Rijk1">[49]</xref>.</p>
<p>This continuous-time model corresponds to a Pair SCFG and as such fits neatly into our modeling framework once the probability distribution is appropriately factored into marginal and conditional distributions (generated by singlet and branch transducers). <xref ref-type="table" rid="pcbi-1000483-t001">Tables 1</xref> and <xref ref-type="table" rid="pcbi-1000483-t002">2</xref> show the states and transitions of the singlet transducer (single-sequence SCFG) which generates ancestral sequence under the Structure Tree model. <xref ref-type="table" rid="pcbi-1000483-t003">Tables 3</xref> and <xref ref-type="table" rid="pcbi-1000483-t004">4</xref> show the states and transitions of the branch transducer (conditionally-normalized Pair SCFG) which evolves a sequence and structure along a branch of the phylogenetic tree.</p>
<table-wrap id="pcbi-1000483-t001" position="float"><object-id pub-id-type="doi">10.1371/journal.pcbi.1000483.t001</object-id><label>Table 1</label><caption>
<title>State types of the singlet transducer (single-sequence SCFG) of the TKF Structure Tree model.</title>
</caption><!--===== Grouping alternate versions of objects =====--><alternatives><graphic id="pcbi-1000483-t001-1" mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.t001" xlink:type="simple"/><table><colgroup span="1"><col align="left" span="1"/><col align="center" span="1"/><col align="center" span="1"/><col align="center" span="1"/><col align="center" span="1"/></colgroup>
<thead>
<tr>
<td align="left" colspan="1" rowspan="1">State</td>
<td align="left" colspan="1" rowspan="1">type</td>
<td align="left" colspan="1" rowspan="1">absorb</td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e240" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1">description</td>
</tr>
</thead>
<tbody>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e241" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e242" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1">Start of a loop</td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e243" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e244" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e245" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1">Single-base emission</td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e246" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e247" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1">Start of a stem</td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e248" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e249" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e250" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1">Base-pair emission</td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e251" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e252" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e253" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1">Bifurcation</td>
</tr>
</tbody>
</table></alternatives><table-wrap-foot><fn id="nt101"><label/><p>Singlet transducers can only have states of type <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e254" xlink:type="simple"/></inline-formula> or <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e255" xlink:type="simple"/></inline-formula>.</p></fn></table-wrap-foot></table-wrap><table-wrap id="pcbi-1000483-t002" position="float"><object-id pub-id-type="doi">10.1371/journal.pcbi.1000483.t002</object-id><label>Table 2</label><caption>
<title>Singlet transducer (single-sequence SCFG) of the TKF Structure Tree model.</title>
</caption><!--===== Grouping alternate versions of objects =====--><alternatives><graphic id="pcbi-1000483-t002-2" mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.t002" xlink:type="simple"/><table><colgroup span="1"><col align="left" span="1"/><col align="center" span="1"/><col align="center" span="1"/><col align="center" span="1"/></colgroup>
<thead>
<tr>
<td align="left" colspan="1" rowspan="1">Source→Destinatioon</td>
<td align="left" colspan="1" rowspan="1">probability</td>
<td align="left" colspan="1" rowspan="1">Source→Destinatioon</td>
<td align="left" colspan="1" rowspan="1">probability</td>
</tr>
</thead>
<tbody>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e256" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e257" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e258" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e259" xlink:type="simple"/></inline-formula></td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e260" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e261" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e262" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e263" xlink:type="simple"/></inline-formula></td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e264" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e265" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1"/>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e266" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e267" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e268" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e269" xlink:type="simple"/></inline-formula></td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e270" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e271" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e272" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e273" xlink:type="simple"/></inline-formula></td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e274" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e275" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1"/>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e276" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1">1</td>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1"/>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e277" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1">1</td>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1"/>
</tr>
</tbody>
</table></alternatives><table-wrap-foot><fn id="nt102"><label/><p>The state types for this model are shown in <xref ref-type="table" rid="pcbi-1000483-t001">Table 1</xref>. The singlet transducer generates ancestral RNA sequences and structures. We use the notation of formal grammars to represent state transformation rules; for example, the rule <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e278" xlink:type="simple"/></inline-formula> corresponds to (in a Pair HMM) an <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e279" xlink:type="simple"/></inline-formula> state <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e280" xlink:type="simple"/></inline-formula> emitting a nucleotide <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e281" xlink:type="simple"/></inline-formula> and then making a self-transition. Both loop (<inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e282" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e283" xlink:type="simple"/></inline-formula>) and stem (<inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e284" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e285" xlink:type="simple"/></inline-formula>) sequence evolve as TKF sequences with length parameters <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e286" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e287" xlink:type="simple"/></inline-formula> (defined in “A simple model of RNA structural evolution”). <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e288" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e289" xlink:type="simple"/></inline-formula> are the equilibrium distributions of unpaired nucleotides <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e290" xlink:type="simple"/></inline-formula> and paired nucleotides <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e291" xlink:type="simple"/></inline-formula> and are normalized such that <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e292" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e293" xlink:type="simple"/></inline-formula>. The bifurcation state <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e294" xlink:type="simple"/></inline-formula> is used to end stem sequences (only loop sequences are allowed to transition to the empty string).</p></fn></table-wrap-foot></table-wrap><table-wrap id="pcbi-1000483-t003" position="float"><object-id pub-id-type="doi">10.1371/journal.pcbi.1000483.t003</object-id><label>Table 3</label><caption>
<title>State types of the branch transducer (conditionally-normalized Pair SCFG) of the TKF Structure Tree model.</title>
</caption><!--===== Grouping alternate versions of objects =====--><alternatives><graphic id="pcbi-1000483-t003-3" mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.t003" xlink:type="simple"/><table><colgroup span="1"><col align="left" span="1"/><col align="center" span="1"/><col align="center" span="1"/><col align="center" span="1"/><col align="center" span="1"/></colgroup>
<thead>
<tr>
<td align="left" colspan="1" rowspan="1">State</td>
<td align="left" colspan="1" rowspan="1">type</td>
<td align="left" colspan="1" rowspan="1">absorb</td>
<td align="left" colspan="1" rowspan="1">emit</td>
<td align="left" colspan="1" rowspan="1">description</td>
</tr>
</thead>
<tbody>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e295" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e296" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1">Start of a loop</td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e297" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e298" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e299" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1">Single-base insertion</td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e300" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e301" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e302" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e303" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1">Single-base substitution</td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e304" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e305" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e306" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1">Single-base deletion</td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e307" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e308" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1">Wait for next base</td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e309" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e310" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1">Start of a stem</td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e311" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e312" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e313" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1">Base-pair insertion</td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e314" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e315" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e316" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e317" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1">Base-pair substitution</td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e318" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e319" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e320" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1">Base-pair deletion</td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e321" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e322" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1">Wait for next base-pair</td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e323" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e324" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e325" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1">Stem insertion</td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e326" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e327" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e328" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e329" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1">Stem conservation</td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e330" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e331" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e332" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e333" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1">Stem deletion</td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e334" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e335" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e336" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e337" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1">Stem extinction</td>
</tr>
</tbody>
</table></alternatives><table-wrap-foot><fn id="nt103"><label/><p>States which have the same names as states of the singlet transducer in <xref ref-type="table" rid="pcbi-1000483-t001">Table 1</xref> are the branch-transducer equivalents of the corresponding singlet-transducer states (e.g., a <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e338" xlink:type="simple"/></inline-formula> state might be the branch equivalent of an <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e339" xlink:type="simple"/></inline-formula> state). States <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e340" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e341" xlink:type="simple"/></inline-formula> are the <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e342" xlink:type="simple"/></inline-formula> states of a sub-model (not shown) identical in structure to the singlet transducer. They are used to insert a new stem-loop structure.</p></fn></table-wrap-foot></table-wrap><table-wrap id="pcbi-1000483-t004" position="float"><object-id pub-id-type="doi">10.1371/journal.pcbi.1000483.t004</object-id><label>Table 4</label><caption>
<title>Branch transducer (conditionally-normalized Pair SCFG) of the TKF Structure Tree model.</title>
</caption><!--===== Grouping alternate versions of objects =====--><alternatives><graphic id="pcbi-1000483-t004-4" mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.t004" xlink:type="simple"/><table><colgroup span="1"><col align="left" span="1"/><col align="center" span="1"/><col align="center" span="1"/><col align="center" span="1"/></colgroup>
<thead>
<tr>
<td align="left" colspan="1" rowspan="1">Source→Destinatioon</td>
<td align="left" colspan="1" rowspan="1">probability</td>
<td align="left" colspan="1" rowspan="1">Source→Destinatioon</td>
<td align="left" colspan="1" rowspan="1">probability</td>
</tr>
</thead>
<tbody>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e343" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e344" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e345" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e346" xlink:type="simple"/></inline-formula></td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e347" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e348" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e349" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e350" xlink:type="simple"/></inline-formula></td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e351" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e352" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1"/>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e353" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e354" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e355" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e356" xlink:type="simple"/></inline-formula></td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e357" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e358" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e359" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e360" xlink:type="simple"/></inline-formula></td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e361" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e362" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1"/>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e363" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e364" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e365" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e366" xlink:type="simple"/></inline-formula></td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e367" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e368" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e369" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e370" xlink:type="simple"/></inline-formula></td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e371" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e372" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1"/>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e373" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e374" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e375" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e376" xlink:type="simple"/></inline-formula></td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e377" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e378" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e379" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e380" xlink:type="simple"/></inline-formula></td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e381" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e382" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1"/>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e383" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e384" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e385" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e386" xlink:type="simple"/></inline-formula></td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e387" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e388" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e389" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e390" xlink:type="simple"/></inline-formula></td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e391" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e392" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e393" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e394" xlink:type="simple"/></inline-formula></td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e395" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e396" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1"/>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e397" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e398" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1"/>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e399" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1">1</td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e400" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1">1</td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e401" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1">1</td>
<td align="left" colspan="1" rowspan="1"><inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e402" xlink:type="simple"/></inline-formula></td>
<td align="left" colspan="1" rowspan="1">1</td>
</tr>
</tbody>
</table></alternatives><table-wrap-foot><fn id="nt104"><label/><p>The state types for this model are shown in <xref ref-type="table" rid="pcbi-1000483-t003">Table 3</xref>. The branch transducer evolves a sequence and structure along a branch of the phylogenetic tree. States <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e403" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e404" xlink:type="simple"/></inline-formula> are the <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e405" xlink:type="simple"/></inline-formula> states for a sub-model corresponding to an insertion of a new stem in the descendant sequences; the sub-model (not shown) is identical in structure to the singlet transducer shown in <xref ref-type="table" rid="pcbi-1000483-t002">Table 2</xref>. <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e406" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e407" xlink:type="simple"/></inline-formula> are the equilibrium distributions of, respectively, descendant unpaired nucleotide <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e408" xlink:type="simple"/></inline-formula> and descendant paired nucleotides <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e409" xlink:type="simple"/></inline-formula>; <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e410" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e411" xlink:type="simple"/></inline-formula> are the conditional distributions (i.e., match probabilities) of a descendant unpaired nucleotide <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e412" xlink:type="simple"/></inline-formula> given an ancestral unpaired nucleotide <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e413" xlink:type="simple"/></inline-formula> and descendant paired nucleotides <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e414" xlink:type="simple"/></inline-formula> given ancestral nucleotides <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e415" xlink:type="simple"/></inline-formula>. The functions <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e416" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e417" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e418" xlink:type="simple"/></inline-formula> are parametrized by the insertion and deletion rates of the TKFST model and are defined in “A simple model of RNA structural evolution”.</p></fn></table-wrap-foot></table-wrap>
<p>The equilibrium distribution and transition probabilities between states of the TKFST model can be expressed in terms of functions of the evolutionary time along a branch and the insertion and deletion rates <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e419" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e420" xlink:type="simple"/></inline-formula> of the model. The length of ancestral sequences is geometric in <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e421" xlink:type="simple"/></inline-formula> (<xref ref-type="table" rid="pcbi-1000483-t002">Table 2</xref>), defined as <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e422" xlink:type="simple"/></inline-formula>. The three functions <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e423" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e424" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e425" xlink:type="simple"/></inline-formula> which govern the transition probabilities in <xref ref-type="table" rid="pcbi-1000483-t004">Table 4</xref> are defined for loop sequences as<disp-formula><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e426" xlink:type="simple"/></disp-formula><disp-formula><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e427" xlink:type="simple"/></disp-formula><disp-formula><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e428" xlink:type="simple"/></disp-formula>and similarly for stem sequences <xref ref-type="bibr" rid="pcbi.1000483-Holmes3">[29]</xref>.</p>
<p>The above-described TKFST SCFGs must be transformed slightly before they can be loaded into Indiegram. The grammars are presented in Indiegram format in <xref ref-type="supplementary-material" rid="pcbi.1000483.s004">Text S4</xref>.</p>
<p>A few other useful statistics for the TKFST model: the expected number of links in a loop sequence is <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e429" xlink:type="simple"/></inline-formula> and in a stem sequence <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e430" xlink:type="simple"/></inline-formula>. Since <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e431" xlink:type="simple"/></inline-formula> of the links in a loop sequence are nested stems, and since each stem has twice as many nucleotides as it has links (since each link is a base <italic>pair</italic>), the expected number of bases in a loop sequence is<disp-formula><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e432" xlink:type="simple"/></disp-formula>The expected number of bases in a stem sequence is<disp-formula><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e433" xlink:type="simple"/></disp-formula>The expected number of bases that are created/removed when a loop-sequence link is inserted/deleted is<disp-formula><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e434" xlink:type="simple"/></disp-formula>The expected number of stems directly rooted in a given loop sequence is <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e435" xlink:type="simple"/></inline-formula> and the expected number of stems directly rooted in, <bold>or indirectly descended from</bold>, a given loop sequence is <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e436" xlink:type="simple"/></inline-formula> (note that this is also the expected total number of loop sequences indirectly descended from a given loop sequence). Therefore, in the equilibrium structure, the expected number of stems is <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e437" xlink:type="simple"/></inline-formula>; of loops, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e438" xlink:type="simple"/></inline-formula>; of unpaired bases, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e439" xlink:type="simple"/></inline-formula>; and of base-pairs, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e440" xlink:type="simple"/></inline-formula>. In a tree with total branch length <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e441" xlink:type="simple"/></inline-formula>, the expected number of single-base deletions is <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e442" xlink:type="simple"/></inline-formula>; of base-pair deletions, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e443" xlink:type="simple"/></inline-formula>; and of substructure deletions, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e444" xlink:type="simple"/></inline-formula>.</p>
</sec><sec id="s3c">
<title>Assessing TKFST as a model of RNA structure</title>
<p>The TKFST model, like the original TKF model, probably needs refinements in order to accurately model many structural RNAs. For example, it fails to model certain phenomena observed in natural RNA structures (such as base-stacking or tetraloops) and in alignments of those structures (such as helix slippage). We assessed its appropriateness as a model of RNA structural evolution by conducting benchmarks of its capabilities for (1) multiple sequence alignment of structured RNAs, summing over all possible structures, and (2) structure prediction of homologous structured RNAs and comparing its performance to Stemloc (one of the better-performing pairwise SCFGs used for RNA multiple alignment <xref ref-type="bibr" rid="pcbi.1000483-Bradley1">[20]</xref>). The results of these benchmarks, reported in <xref ref-type="table" rid="pcbi-1000483-t005">Table 5</xref> and <xref ref-type="table" rid="pcbi-1000483-t006">Table 6</xref>, suggest that TKFST is a useful guide for deriving more complicated models of RNA evolution: while it has relatively poor sensitivity (but high positive predictive value) as a base-pairing predictor, it is competitive with one of the most accurate RNA multiple sequence alignment programs <xref ref-type="bibr" rid="pcbi.1000483-Bradley1">[20]</xref>.</p>
<table-wrap id="pcbi-1000483-t005" position="float"><object-id pub-id-type="doi">10.1371/journal.pcbi.1000483.t005</object-id><label>Table 5</label><caption>
<title>Percentage sensitivity and positive predictive value (Sensitivity/PPV) for pairwise nucleotide-level alignments in the BRalibaseII benchmark.</title>
</caption><!--===== Grouping alternate versions of objects =====--><alternatives><graphic id="pcbi-1000483-t005-5" mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.t005" xlink:type="simple"/><table><colgroup span="1"><col align="left" span="1"/><col align="center" span="1"/><col align="center" span="1"/><col align="center" span="1"/><col align="center" span="1"/></colgroup>
<thead>
<tr>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1">U5</td>
<td align="left" colspan="1" rowspan="1">g2intron</td>
<td align="left" colspan="1" rowspan="1">rRNA</td>
<td align="left" colspan="1" rowspan="1">tRNA</td>
</tr>
</thead>
<tbody>
<tr>
<td align="left" colspan="1" rowspan="1">TKFST grammar</td>
<td align="left" colspan="1" rowspan="1">81.6/81.7</td>
<td align="left" colspan="1" rowspan="1"><bold>75.4</bold>/<bold>75.0</bold></td>
<td align="left" colspan="1" rowspan="1">91.4/92.6</td>
<td align="left" colspan="1" rowspan="1"><bold>94.6</bold>/<bold>94.4</bold></td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1">Stemloc grammar</td>
<td align="left" colspan="1" rowspan="1"><bold>82.6</bold>/<bold>83.7</bold></td>
<td align="left" colspan="1" rowspan="1">74.2/74.8</td>
<td align="left" colspan="1" rowspan="1"><bold>92.6</bold>/<bold>92.8</bold></td>
<td align="left" colspan="1" rowspan="1">93.2/93.9</td>
</tr>
</tbody>
</table></alternatives><table-wrap-foot><fn id="nt105"><label/><p>We compared the performance of the TKFST model for progressive multiple alignment of RNAs against the performance of a grammar with a richer model of RNA structure (Stemloc <xref ref-type="bibr" rid="pcbi.1000483-Holmes1">[18]</xref>). Sensitivity is defined as <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e445" xlink:type="simple"/></inline-formula> and PPV is defined as <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e446" xlink:type="simple"/></inline-formula>, where TP is the number of true positives (correctly aligned residue pairs), FN is the number of false negatives (residue pairs that should have been aligned but were not) and FP is the number of false positives (residue pairs that were incorrectly aligned). These statistics are summed over all pairs of sequences in the multiple alignment; therefore, “Sensitivity” for pairwise residue alignments is equivalent to the Sum of Pairs Score or SPS <xref ref-type="bibr" rid="pcbi.1000483-Thompson1">[103]</xref>. “g2intron” is the RFAM entry Intron_gpII, containing domains V and VI of the Group II intron.</p></fn></table-wrap-foot></table-wrap><table-wrap id="pcbi-1000483-t006" position="float"><object-id pub-id-type="doi">10.1371/journal.pcbi.1000483.t006</object-id><label>Table 6</label><caption>
<title>Percentage sensitivity and positive predictive value (Sensitivity/PPV) for predicted base-pairs in the BRalibaseII benchmark.</title>
</caption><!--===== Grouping alternate versions of objects =====--><alternatives><graphic id="pcbi-1000483-t006-6" mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.t006" xlink:type="simple"/><table><colgroup span="1"><col align="left" span="1"/><col align="center" span="1"/><col align="center" span="1"/><col align="center" span="1"/><col align="center" span="1"/></colgroup>
<thead>
<tr>
<td align="left" colspan="1" rowspan="1"/>
<td align="left" colspan="1" rowspan="1">U5</td>
<td align="left" colspan="1" rowspan="1">g2intron</td>
<td align="left" colspan="1" rowspan="1">rRNA</td>
<td align="left" colspan="1" rowspan="1">tRNA</td>
</tr>
</thead>
<tbody>
<tr>
<td align="left" colspan="1" rowspan="1">TKFST grammar</td>
<td align="left" colspan="1" rowspan="1">37.9/68.0</td>
<td align="left" colspan="1" rowspan="1">42.1/63.8</td>
<td align="left" colspan="1" rowspan="1">37.4/66.5</td>
<td align="left" colspan="1" rowspan="1">70.9/<bold>88.3</bold></td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1">Stemloc grammar</td>
<td align="left" colspan="1" rowspan="1">74.9/<bold>73.9</bold></td>
<td align="left" colspan="1" rowspan="1">64.3/56.7</td>
<td align="left" colspan="1" rowspan="1">51.0/59.0</td>
<td align="left" colspan="1" rowspan="1">74.0/76.4</td>
</tr>
</tbody>
</table></alternatives><table-wrap-foot><fn id="nt106"><label/><p>We compared the performance of the TKFST model for structure-prediction accuracy during progressive multiple alignment of RNAs against the performance of a grammar with a richer model of RNA structure (Stemloc <xref ref-type="bibr" rid="pcbi.1000483-Holmes1">[18]</xref>). “g2intron” is the RFAM entry Intron_gpII, containing domains V and VI of the Group II intron.</p></fn></table-wrap-foot></table-wrap>
<p>TKFST's poorer performance at base-pairing prediction is likely due to its much-simpler model of RNA structure. The richer grammar, as described in <xref ref-type="bibr" rid="pcbi.1000483-Holmes1">[18]</xref>, is much more complex than TKFST: excluding the substitution model, it has 14 free parameters (compared to TKFST's 4), uses an affine gap penalty (compared to TKFST's linear gap penalty), and explicitly models structural features such as multiple-branched loops, symmetric/asymmetric bulges, and minimum loop lengths. Unlike TKFST, the richer grammar is structurally unambiguous: a one-to-one mapping exists from structures to parse trees. Although we use the TKFST model as an illustrative example of a Pair SCFG that can be extended with our method, the model is not fundamental to our approach and can be replaced by a different and more realistic pairwise model, such as the Stemloc pairwise SCFG used in these comparisons <xref ref-type="bibr" rid="pcbi.1000483-Bradley1">[20]</xref>. We anticipate that further improvements should be possible by reviewing other comparisons of SCFGs at structure prediction, such as the study of <xref ref-type="bibr" rid="pcbi.1000483-Dowell1">[17]</xref>.</p>
</sec><sec id="s3d">
<title>The TKFST model on a three-taxon phylogeny</title>
<p>We used our model-construction algorithm to build the grammar corresponding to the TKFST model acting on a star phylogeny with three (extant) leaf sequences and a single (unobserved) ancestral sequence. We chose this phylogeny for two reasons: (1) it is the simplest extension of the well-studied, standard two-sequence (Pair SCFG) model and (2) algorithms on a phylogeny with three leaves should be sufficient for ergodic sampling of reconstructions on any larger phylogeny, using, e.g., a Gibbs-sampling MCMC kernel <xref ref-type="bibr" rid="pcbi.1000483-Jensen1">[31]</xref> or a progressive suboptimal-alignment sampling heuristic <xref ref-type="bibr" rid="pcbi.1000483-Paten1">[33]</xref>.</p>
<p>The statistics of the TKFST model on the three-taxon phylogeny illustrate the advantages of our procedure for model construction. While the singlet and branch transducers are relatively simple—the singlet transducer, shown in <xref ref-type="table" rid="pcbi-1000483-t002">Table 2</xref>, has 7 total states and 2 bifurcation states and the branch transducer, shown in <xref ref-type="table" rid="pcbi-1000483-t004">Table 4</xref>, has 21 total states and 6 bifurcation states—the ensemble model of three extant sequences is very complex. The naive exponential upper-bound gives a maximal state space of size <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e447" xlink:type="simple"/></inline-formula> states. Using our uninformed search algorithm, we determined that there are 287 accessible states and 686 possible transitions between these states (compare with the <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e448" xlink:type="simple"/></inline-formula> transitions estimated with the exponential calculation). After performing the transformations described in “Exact elimination of null cycles in SCFGs” to eliminate useless windback states, the ensemble model has a reduced state space with 230 states, albeit at the cost of extra transitions, bring the total to 1,789 transitions (here we are trading reduced memory complexity, which is linear in the number of states, for increased time complexity, which is linear in the number of transitions). Note that both before and after the reduction in complexity, the total number of states and transitions are less than the approximate bounds of <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e449" xlink:type="simple"/></inline-formula> states and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e450" xlink:type="simple"/></inline-formula> transitions suggested in “The composition algorithm”. Nonetheless, the extreme complexity of the ensemble model, despite the simplicity of the underlying model of RNA structure, makes clear the necessity for automated procedures for model construction. <xref ref-type="supplementary-material" rid="pcbi.1000483.s005">Dataset S1</xref> gives the state space of the ensemble model constructed by the search algorithm and <xref ref-type="supplementary-material" rid="pcbi.1000483.s006">Dataset S2</xref> the reduced model after eliminating windback states; both are in Graphviz format for visualization and show the state of the singlet transducer generating ancestral sequence as well as the states of the branch transducers generating observed sequences.</p>
<p>We implemented constrained maximum-likelihood inference of the structural alignment and ancestral structure of three extant sequences in a C++ program (Indiegram). For tractability, Indiegram uses the concept of fold envelopes described earlier to limit the fold space considered by the CYK algorithm, permitting structural information for the three extant sequences to be (optionally) supplied as input. If no structural information is supplied, then Indiegram uses a single-sequence SCFG to estimate a set of plausible folds <xref ref-type="bibr" rid="pcbi.1000483-Holmes1">[18]</xref>, which are used to constrain the CYK algorithm.</p>
<p>The inference algorithms in Indiegram could be further constrained to enforce, for example, a fixed multiple alignment or a consensus structure for extant sequences. While experimentally-determined structures of individual RNAs are relatively rare, curated deep sequence alignments, such as those constructed for ribosomal RNAs <xref ref-type="bibr" rid="pcbi.1000483-Gutell1">[50]</xref>, are frequently available for characterized RNA families. By constraining the inference algorithms with such sequence alignments, the memory and time complexity of the algorithms could be dramatically reduced. Such constraints can be naturally expressed with “alignment envelopes,” the alignment-space analogue of fold envelopes <xref ref-type="bibr" rid="pcbi.1000483-Holmes1">[18]</xref>. However, in this paper we focus on model construction and inference algorithms and postpone exploration of heuristics and constraints of these algorithms for future work.</p>
</sec><sec id="s3e">
<title>Reconstructing small RNAs with the TKFST model</title>
<p>While reconstructing large RNAs such as ribosomal subunits is currently computationally-inaccessible without further heuristics to constrain our algorithms, reconstructing small RNAs of biological interest will soon be feasible. <xref ref-type="table" rid="pcbi-1000483-t007">Table 7</xref> shows estimates of the memory and time required to reconstruct biologically-interesting subunits of the <italic>nanos</italic> 3′ translational control element and tRNAs, as well as two small RNAs which show significant structural divergence, the Y RNAs and Group II introns, and therefore promise to be interesting candidates for ancestral reconstruction. The reconstructed structures for three <italic>nanos</italic> 3′ translational control elements (TCEs) and three tRNAs, which could be analyzed given current computational limitations, can be found at <ext-link ext-link-type="uri" xlink:href="http://biowiki.org/IndieGram" xlink:type="simple">http://biowiki.org/IndieGram</ext-link>; however, the phylogenetic trees relating the tested sequences have short branch lengths, making the reconstruction problem easy by forcing the reconstructed structures to be essentially-identical to those of one of the extant RNAs.</p>
<table-wrap id="pcbi-1000483-t007" position="float"><object-id pub-id-type="doi">10.1371/journal.pcbi.1000483.t007</object-id><label>Table 7</label><caption>
<title>Estimates of the memory and time required to reconstruct ancestral structures of three RNAs from several families of biological interest (as reported by Indiegram).</title>
</caption><!--===== Grouping alternate versions of objects =====--><alternatives><graphic id="pcbi-1000483-t007-7" mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.t007" xlink:type="simple"/><table><colgroup span="1"><col align="left" span="1"/><col align="center" span="1"/><col align="center" span="1"/><col align="center" span="1"/></colgroup>
<thead>
<tr>
<td align="left" colspan="1" rowspan="1">Family</td>
<td align="left" colspan="1" rowspan="1">Sequence lengths</td>
<td align="left" colspan="1" rowspan="1">Memory</td>
<td align="left" colspan="1" rowspan="1">Time</td>
</tr>
</thead>
<tbody>
<tr>
<td align="left" colspan="1" rowspan="1"><italic>nanos</italic> 3′ TCE</td>
<td align="left" colspan="1" rowspan="1">61–64 nt</td>
<td align="left" colspan="1" rowspan="1">3 Gb</td>
<td align="left" colspan="1" rowspan="1">3 min</td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1">tRNA</td>
<td align="left" colspan="1" rowspan="1">69–73 nt</td>
<td align="left" colspan="1" rowspan="1">11 Gb</td>
<td align="left" colspan="1" rowspan="1">19 min</td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1">Y RNA</td>
<td align="left" colspan="1" rowspan="1">47–81 nt</td>
<td align="left" colspan="1" rowspan="1">33 Gb</td>
<td align="left" colspan="1" rowspan="1">70 min</td>
</tr>
<tr>
<td align="left" colspan="1" rowspan="1">Group II intron (domains V and VI)</td>
<td align="left" colspan="1" rowspan="1">76–91 nt</td>
<td align="left" colspan="1" rowspan="1">122 Gb</td>
<td align="left" colspan="1" rowspan="1">90 min</td>
</tr>
</tbody>
</table></alternatives><table-wrap-foot><fn id="nt107"><label/><p>The <italic>nanos</italic> 3′ translational control element (TCE) sequences are the seed sequences of the corresponding RFAM family <xref ref-type="bibr" rid="pcbi.1000483-GriffithsJones1">[5]</xref> and the three tRNA sequences are from the BRalibaseII database <xref ref-type="bibr" rid="pcbi.1000483-Gardner1">[55]</xref> (identifiers AB042432.1-14140_14072, Z82044.1-16031_16103 and AC008670.6-83725_83795). The group II intron sequences (identifiers Z00044.1-87253_87177, X57546.1-2817_2907 and X04465.1-2700_2775) are from BralibaseII <xref ref-type="bibr" rid="pcbi.1000483-Gardner1">[55]</xref>. The Y RNAs are hY1, hY4, and hY5 from <xref ref-type="bibr" rid="pcbi.1000483-Teunissen1">[104]</xref>; sequence lengths exclude the conserved stem S1. The time estimates are for a 2.2 GHz AMD Opteron 848 CPU.</p></fn></table-wrap-foot></table-wrap></sec><sec id="s3f">
<title>Comparison of alignment methods</title>
<p>Guided by our experience with the <italic>nanos</italic> 3′ TCE and tRNA, where the reconstruction problem was made easy by the presence of a close outgroup, we conducted a simulation study of the dependence of reconstruction accuracy on outgroup branch length, with the further goal of comparing the performance of our reconstruction method (when simulating directly from the model) to simpler reconstruction methods that ignore either structure or phylogeny. (We here use the term “outgroup” loosely to denote the variable-length branch in our three-taxon study, where the other two branches are held at unit length.)</p>
<p>We simulated the evolution of RNAs under the TKFST model along three-taxon phylogenies (with one internal node), where we kept the branch lengths of two sibling species constant and varied the branch length of the outgroup between <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e451" xlink:type="simple"/></inline-formula> at steps of size <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e452" xlink:type="simple"/></inline-formula>. Parameters used in the simulation were <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e453" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e454" xlink:type="simple"/></inline-formula> for loop sequence and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e455" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e456" xlink:type="simple"/></inline-formula> for stem sequence; the probability of a stem insertion was <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e457" xlink:type="simple"/></inline-formula>. These yielded a mean loop length of 5 bp and a mean stem length of 2.33 bp, with <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e458" xlink:type="simple"/></inline-formula> substructure indels per alignment. We selected alignments to reconstruct by requiring that there be at least two ancestral stems, loops of <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e459" xlink:type="simple"/></inline-formula> and stems of <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e460" xlink:type="simple"/></inline-formula>; to reduce the complexity of our algorithms we additionally required that the sequences have <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e461" xlink:type="simple"/></inline-formula>.</p>
<p>We then attempted three-way multiple alignment (and, in some cases, reconstruction of the ancestor) using a variety of statistical inference algorithms. We sought insight as to the relative importance of the following factors in reconstructing ancestral RNA: (i) modeling the secondary structure; (ii) modeling the phylogenetic topology &amp; branch lengths; (iii) using posterior-decoding algorithms to maximize the expected alignment <italic>accuracy</italic>, rather than picking the single <italic>most likely</italic> alignment <xref ref-type="bibr" rid="pcbi.1000483-Bradley1">[20]</xref>,<xref ref-type="bibr" rid="pcbi.1000483-Holmes8">[51]</xref>,<xref ref-type="bibr" rid="pcbi.1000483-Schwartz1">[52]</xref>.</p>
<p>The alignment programs we used in this benchmark were Indiegram (exact ML inference of alignment and ancestral structure, given phylogeny, descendant structures and correct model); Stemloc (a greedy ML heuristic, ignoring phylogeny in favor of a single-linkage clustering of the descendant structures); Stemloc-AMA (a posterior-decoding heuristic, maximizing the alignment's <italic>expected accuracy</italic> rather than its <italic>likelihood</italic>); and Handel (ML alignment under various indel models that ignore secondary structure completely). In detail, the reconstruction methods were</p>
<p>Stemloc : the Stemloc program was used to align the three sequences via single-linkage clustering with a Pair SCFG <xref ref-type="bibr" rid="pcbi.1000483-Holmes1">[18]</xref>. The structures of the leaf sequences were provided, but not the phylogenetic branch lengths. Instead of modeling a true phylogeny by introducing unobserved ancestral sequences, it just does single-linkage clustering of the observed sequences.</p>
<p>Stemloc-AMA : the Stemloc program was used to align the three sequences in “sequence annealing” mode, a posterior decoding method that attempts to optimize AMA, a sum-over-pairs alignment accuracy metric <xref ref-type="bibr" rid="pcbi.1000483-Bradley1">[20]</xref>. The structures of the leaf sequences were provided, but not the phylogenetic branch lengths. This program uses the same underlying pair SCFG as Stemloc, but instead of maximizing likelihood, it attempts to maximize an alignment accuracy metric.</p>
<p>TKF91: with the TKF91 model <xref ref-type="bibr" rid="pcbi.1000483-Thorne1">[44]</xref>, the Handel package <xref ref-type="bibr" rid="pcbi.1000483-Holmes4">[30]</xref>,<xref ref-type="bibr" rid="pcbi.1000483-Holmes5">[39]</xref>,<xref ref-type="bibr" rid="pcbi.1000483-Holmes6">[40]</xref> was used to align the three extant sequences and reconstruct the ancestor. The correct phylogenetic tree and branch lengths were supplied (as they were for the Indiegram benchmark). The insertion, deletion and substitution rates for the TKF91 model were set equal to those of the loop submodel of TKFST. This may be understood as a naive sequence-only reconstruction that completely ignores basepair structure (i.e. the stem sub-model of TKFST).</p>
<p>Long Indel: with a single-event trajectory approximation to the long indel model <xref ref-type="bibr" rid="pcbi.1000483-Mikls1">[53]</xref>, the Handel package was used to align the three extant sequences and reconstruct the ancestor. The correct phylogenetic tree and branch lengths were supplied. The deletion and substitution rates were set equal to those of the loop submodel of TKFST. The mean indel length was set equal to <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e462" xlink:type="simple"/></inline-formula>, the mean number of bases that are created/removed by an insertion/deletion in the loop submodel of TKFST; the mean equilibrium sequence length (and thereby the insertion rate) was equal to <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e463" xlink:type="simple"/></inline-formula>, the mean number of bases in TKFST at equilibrium (“A simple model of RNA structural evolution” has formulae for these quantities in terms of the TKFST rate parameters). This model improves on the previous model (TKF91) by introducing affine gap penalties.</p>
<p>We measured alignment accuracy, under the simplifying assumption that this correlates well with ancestral reconstruction accuracy.</p>
<p>We first consider the <italic>perfect alignment rate</italic>; that is, the number of times each method gets the alignment exactly correct. Theory predicts that Maximum Likelihood inference, using the correct model and parameters, should be asymptotically optimal (if one only counts perfect guesses). Inspecting <xref ref-type="fig" rid="pcbi-1000483-g010">Figure 10</xref>, we find this to be almost the case; the exception is when the outgroup is very distant and the bins may be undersampled (the departure from prediction that we observe for low-identity alignments is not statistically significant: when the optimal success rate drops below <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e464" xlink:type="simple"/></inline-formula>, then 125 trials are probably insufficient to compare two near-optimal methods). We also note that the ML version of Stemloc is near-optimal, despite the Stemloc pair-SCFG being slightly different from the TKFST pair-SCFG in parameterization and structure (e.g. Stemloc 's grammar does not allow insertion/deletion of entire substructures). The ML version of Stemloc is also observed to have a slightly higher perfect alignment rate than the posterior-decoding version (Stemloc -AMA). Finally, we note that the structure-blind models (TKF91 and Long Indel) perform consistently worse than the structure-aware methods; furthermore, both linear (TKF91) and affine (Long Indel) gap-penalties perform equally bad in this test (note that the TKFST model, from which the true alignments were simulated, does not allow long-indel events, which may partly explain why affine gap-penalties do not help in this benchmark).</p>
<fig id="pcbi-1000483-g010" position="float"><object-id pub-id-type="doi">10.1371/journal.pcbi.1000483.g010</object-id><label>Figure 10</label><caption>
<title>Dependence of perfect alignment rate on alignment method and outgroup branch length.</title>
<p>Perfect alignment is when a given alignment program estimates the alignment 100% correctly, with no errors. Simulating the evolution of three structural RNAs under the TKFST model, we investigated the dependency of perfect alignment rate on outgroup branch length. The simulation included two sister species at unit distance from the ancestral sequence, plus one “outgroup” whose branch length <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e465" xlink:type="simple"/></inline-formula> was varied between <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e466" xlink:type="simple"/></inline-formula> by selecting 25 equally spaced values of <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e467" xlink:type="simple"/></inline-formula> in this range, spaced <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e468" xlink:type="simple"/></inline-formula> apart. (A unit-length branch here corresponds to one expected substitution per site in loop sequence.) We simulated 25 alignments for each value of <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e469" xlink:type="simple"/></inline-formula>, using TKFST model parameters described in the text. Since the perfect alignment rate is rather low, we further aggregated the <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e470" xlink:type="simple"/></inline-formula> into bins of five; thus, for example, the bin named “<inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e471" xlink:type="simple"/></inline-formula>” includes <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e472" xlink:type="simple"/></inline-formula> and represents <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e473" xlink:type="simple"/></inline-formula> trials in total. The perfect alignment rate was measured for various statistical alignment inference procedures. These procedures are described in the text, but may be summarized very briefly as ML under the true model (“Indiegram”); greedy approximate-ML progressive alignment by single-linkage clustering with pair SCFGs (“Stemloc”); sequence annealing, a form of posterior decoding to maximize a sum-over-pairs accuracy metric, using pair SCFGs to get the posterior probabilities (“Stemloc-AMA”); statistical alignment using the TKF91 model, i.e. linear gap-penalties (“TKF91”); and statistical alignment using a long-indel model, i.e. affine gap-penalties (“Long Indel”).</p>
</caption><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.g010" xlink:type="simple"/></fig>
<p>A subtly different ranking emerges from consideration of the <italic>alignment accuracy</italic>. In <xref ref-type="fig" rid="pcbi-1000483-g011">Figure 11</xref>, we abandon the all-or-nothing metric of counting only perfect alignments, instead using a metric that shows what proportion of the alignment is correct. Specifically, we plot the <italic>Alignment Metric Accuracy</italic> (AMA) as a function of outgroup branch length. AMA measures the proportion of residues which are correctly aligned, averaged over all pairs of sequences <xref ref-type="bibr" rid="pcbi.1000483-Schwartz2">[54]</xref>. <xref ref-type="fig" rid="pcbi-1000483-g004">Figure 4</xref> reveals that Stemloc-AMA (which attempts to find the alignment with the maximum expected AMA) edges out both Indiegram and the ML version of Stemloc (both of which attempt to find the alignment with the maximum likelihood). These results, compared to the subtly different story told by the perfect alignment rate, underscore the point that benchmark results for alignment methods can depend exquisitely on the choice of accuracy metric. The superiority of ML methods is only assured in terms of perfect alignment rate, and not necessarily other accuracy metrics.</p>
<fig id="pcbi-1000483-g011" position="float"><object-id pub-id-type="doi">10.1371/journal.pcbi.1000483.g011</object-id><label>Figure 11</label><caption>
<title>Dependence of alignment metric accuracy on alignment method and outgroup branch length.</title>
<p>We simulated the evolution of three structural RNAs under the TKFST model. The simulation included two sister species at unit distance from the ancestral sequence, plus one “outgroup” whose branch length <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e474" xlink:type="simple"/></inline-formula> was varied between <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e475" xlink:type="simple"/></inline-formula> by selecting 25 equally spaced values of <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e476" xlink:type="simple"/></inline-formula> in this range, spaced <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e477" xlink:type="simple"/></inline-formula> apart. We then simulated 25 alignments for each value of <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e478" xlink:type="simple"/></inline-formula>, using TKFST model parameters described in the text. The Alignment Metric Accuracy (AMA) is, roughly, the proportion of residues that are correctly aligned, averaged over all pairs of sequences (see <xref ref-type="bibr" rid="pcbi.1000483-Schwartz2">[54]</xref> for a precise definition; we set the AMA Gap Factor to 1). The AMA between the true alignment and the inferred alignment was measured for various statistical alignment inference procedures. These procedures are described in the text, but may be summarized very briefly as ML under the true model (“Indiegram”); greedy approximate-ML progressive alignment by single-linkage clustering with pair SCFGs (“Stemloc”); sequence annealing, a form of posterior decoding to maximize a sum-over-pairs accuracy metric, using pair SCFGs to get the posterior probabilities (“Stemloc-AMA”); statistical alignment using the TKF91 model, i.e. linear gap-penalties (“TKF91”); and statistical alignment using a long-indel model, i.e. affine gap-penalties (“Long Indel”).</p>
</caption><graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.g011" xlink:type="simple"/></fig>
<p>Taken together, these results suggest that the most important factor distinguishing the various models we have examined is the incorporation of some form of basepair structure: structure-blind Handel (regardless of linear <italic>vs</italic> affine gap penalty) performs much worse than the structure-aware SCFG methods. Intuitively, this is to be expected: whenever a basepair-aware method aligns one half of a basepair, it gets the other nucleotide correctly aligned for free. In benchmarks of RNA multiple alignment programs, structure-aware scoring schemes routinely outperform structure-blind scoring schemes <xref ref-type="bibr" rid="pcbi.1000483-Gardner1">[55]</xref>,<xref ref-type="bibr" rid="pcbi.1000483-Wilm1">[56]</xref>. Since we know that modeling structure is very important, it's not too surprising that it turns out to be the most important of the factors we considered.</p>
<p>The second most important, amongst the factors we have considered in this experiment, is selection of the most appropriate objective function for the task at hand (c.f. perfect alignment rate <italic>vs</italic> AMA), followed by use of the correct posterior-decoding algorithm for the chosen objective function (c.f. Stemloc <italic>vs</italic> Stemloc-AMA). This is a subtle but important point: before deciding exactly what inference algorithm we're going to use to reconstruct ancestral sequences, we need to decide whether we want to maximize (a) the probability that our reconstructed sequence is 100% correct, (b) the expected number of nucleotides that are correctly reconstructed, (c) the expected number of base-pairs that are correctly reconstructed, (d) the expected number of stems that are correctly reconstructed, (e) some other metric. Each of these metrics would require a slightly different inference algorithm.</p>
<p>Lastly, the fine details of the scoring scheme—including branch lengths, substitution scores, gap penalties and so forth—appear to be the least important of the factors we considered, yielding observable differences only when all other aspects of the inference procedure were more-or-less equal. While such details of the model may affect reconstruction quality, they appear to have very minor influence on alignment quality.</p>
</sec></sec><sec id="s4">
<title>Discussion</title>
<p>Following the conception of paleogenetics <xref ref-type="bibr" rid="pcbi.1000483-Pauling1">[57]</xref>, a large number of synthetic reconstructions of ancestral protein sequences have been reported in the literature <xref ref-type="bibr" rid="pcbi.1000483-Malcolm1">[58]</xref>–<xref ref-type="bibr" rid="pcbi.1000483-Ortlund1">[65]</xref>. There is also scientific interest in reconstructing DNA sequences <xref ref-type="bibr" rid="pcbi.1000483-Paten1">[33]</xref>, <xref ref-type="bibr" rid="pcbi.1000483-Ivics1">[66]</xref>–<xref ref-type="bibr" rid="pcbi.1000483-Elias1">[71]</xref>. Given the importance of the RNA world hypothesis to current discussions of the origin of life <xref ref-type="bibr" rid="pcbi.1000483-Marintchev1">[72]</xref>–<xref ref-type="bibr" rid="pcbi.1000483-Danchin1">[78]</xref>, the many modern-day relics of this world <xref ref-type="bibr" rid="pcbi.1000483-Lee1">[79]</xref>–<xref ref-type="bibr" rid="pcbi.1000483-Mandal1">[82]</xref> and the recent proposal of a structural model for the primordial ribosome <xref ref-type="bibr" rid="pcbi.1000483-Smith1">[2]</xref>, we believe that phylogenetic reconstruction of ancient RNA is a significant problem, deserving of strong bioinformatics support.</p>
<p>The work reported in this paper builds on extensive prior art in the areas of evolutionary modeling and ancestral reconstruction. Reviewing all of this would take several books, but we can note some key references. The reconstruction of ancient sequences was first proposed in 1963 by Pauling and Zuckerkandl <xref ref-type="bibr" rid="pcbi.1000483-Pauling1">[57]</xref>; current applications of this idea, mostly using substitution models, are surveyed in the book edited by Liberles <xref ref-type="bibr" rid="pcbi.1000483-Liberles1">[83]</xref>. Many algorithms in phylogenetics implicitly reconstruct substitution histories, whether by parsimony <xref ref-type="bibr" rid="pcbi.1000483-Edwards1">[84]</xref>,<xref ref-type="bibr" rid="pcbi.1000483-Hendy1">[85]</xref> or likelihood <xref ref-type="bibr" rid="pcbi.1000483-Felsenstein2">[22]</xref>. There is a substantial body of work to model indels on phylogenies <xref ref-type="bibr" rid="pcbi.1000483-Holmes4">[30]</xref>, <xref ref-type="bibr" rid="pcbi.1000483-Bradley2">[35]</xref>, <xref ref-type="bibr" rid="pcbi.1000483-Holmes5">[39]</xref>, <xref ref-type="bibr" rid="pcbi.1000483-Thorne1">[44]</xref>, <xref ref-type="bibr" rid="pcbi.1000483-Mikls1">[53]</xref>, <xref ref-type="bibr" rid="pcbi.1000483-Hein1">[86]</xref>–<xref ref-type="bibr" rid="pcbi.1000483-Satija1">[92]</xref>. Recent work has extended these ideas to the reconstruction of indel histories <xref ref-type="bibr" rid="pcbi.1000483-Kim1">[93]</xref>,<xref ref-type="bibr" rid="pcbi.1000483-Diallo1">[94]</xref>, particularly at the genomic scale <xref ref-type="bibr" rid="pcbi.1000483-Paten1">[33]</xref>,<xref ref-type="bibr" rid="pcbi.1000483-Ma1">[95]</xref>. There is also prior work in computational linguistics on the theory of transducers for sequences <xref ref-type="bibr" rid="pcbi.1000483-Mohri1">[96]</xref> and parse trees <xref ref-type="bibr" rid="pcbi.1000483-Comon1">[36]</xref>,<xref ref-type="bibr" rid="pcbi.1000483-Gecseg1">[37]</xref>,<xref ref-type="bibr" rid="pcbi.1000483-Rounds1">[97]</xref>,<xref ref-type="bibr" rid="pcbi.1000483-Thatcher1">[98]</xref> (from which we take the terms “string transducer” and “parse-tree transducer”). We draw on the bioinformatics literature for SCFGs <xref ref-type="bibr" rid="pcbi.1000483-Eddy1">[10]</xref>,<xref ref-type="bibr" rid="pcbi.1000483-Durbin1">[11]</xref>,<xref ref-type="bibr" rid="pcbi.1000483-Sakakibara1">[99]</xref>, especially Pair SCFGs <xref ref-type="bibr" rid="pcbi.1000483-Rivas1">[14]</xref>,<xref ref-type="bibr" rid="pcbi.1000483-Holmes1">[18]</xref>,<xref ref-type="bibr" rid="pcbi.1000483-Dowell2">[19]</xref> and phylogenetic SCFGs <xref ref-type="bibr" rid="pcbi.1000483-Knudsen1">[16]</xref>. In particular, an early example of a pairwise conditional model <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e479" xlink:type="simple"/></inline-formula> for structure-dependent RNA evolution was given by Eddy <italic>et al</italic> <xref ref-type="bibr" rid="pcbi.1000483-Klein1">[12]</xref>. A conditional framework similar to ours in some respects is described by Sakakibara <italic>et al</italic> <xref ref-type="bibr" rid="pcbi.1000483-Sakakibara2">[100]</xref>. The dynamic programming inference algorithms for multiple-sequence SCFGs are closely related to the protosequence algorithm of Sankoff <xref ref-type="bibr" rid="pcbi.1000483-Sankoff1">[42]</xref>.</p>
<p>While we have focused on the TKF Structure Tree model in our <xref ref-type="sec" rid="s3">Results</xref>, our model-construction algorithm is applicable to any model of the evolution of secondary structure which can be expressed as a Pair SCFG. Realistic structural and thermodynamic effects—such as base-stacking or loop length distributions—can, in principle, be incorporated. Other phenomena of RNA evolution may prove more difficult: modeling helix slippage with a branch transducer is awkward, let alone more radical changes in structure; pseudoknots, too, are impossible with the models we have described here. Even so, variants of our models could be used for proposing candidate alignments for more accurate scoring by such models.</p>
<p>An implementation of inference algorithms for models on the three-taxon phylogeny is sufficient to construct a MCMC sampling algorithm over many sequences on an arbitrary phylogeny. A sketch of such a sampling algorithm is as follows: at each step of the sampling algorithm, we re-sample the sequence and structure of the ancestral node <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e480" xlink:type="simple"/></inline-formula>, conditioned on the sequences and structures of <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e481" xlink:type="simple"/></inline-formula>, <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e482" xlink:type="simple"/></inline-formula> and <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e483" xlink:type="simple"/></inline-formula>. The structural alignment of all four sequences can change at each step, providing for fast mixing and guaranteeing ergodicity. This move is similar to the sampler proposed by <xref ref-type="bibr" rid="pcbi.1000483-Jensen1">[31]</xref> for models with a HMM structure. Note that this, in principle, permits construction of a crude sampler to simultaneously infer phylogeny as well, by proposing and accepting or rejecting changes to the underlying tree as well as the implied structural alignment.</p>
<p>Reconstructing structural changes of large RNAs using the three-way sampling kernel which we have described would require resources far in excess of those currently available; barring the availability of supercomputers with terabytes of memory, such algorithms will only be feasible for short RNAs (<xref ref-type="table" rid="pcbi-1000483-t007">Table 7</xref>). A promising direction is to consider variations on the three-way sampling kernel, such as the importance-sampling approach described for the TKF model by <xref ref-type="bibr" rid="pcbi.1000483-Redelings1">[32]</xref>. This approach first proposes an ancestor <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e484" xlink:type="simple"/></inline-formula> by aligning extant sequence <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e485" xlink:type="simple"/></inline-formula> to <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e486" xlink:type="simple"/></inline-formula> (ignoring <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e487" xlink:type="simple"/></inline-formula>); then, in a second step, the proposed <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e488" xlink:type="simple"/></inline-formula> is independently aligned to <inline-formula><inline-graphic mimetype="image" xlink:href="info:doi/10.1371/journal.pcbi.1000483.e489" xlink:type="simple"/></inline-formula>. The proposed three-way alignment and reconstruction is then randomly accepted (or rejected) using a Hastings ratio based on the three-way transducer composition. The complexity of this kernel is the same as the pairwise case; with suitable constraints, this is feasible for RNA grammars on present hardware, at least for ribosomal domains (if not yet whole subunits—although pairwise alignment of those should also be possible soon). The approach of Redelings and Suchard therefore merits future consideration in the context of modeling the evolution of RNAs on a tree.</p>
<p>An alternative MCMC scheme for sampling RNA phylogeny, structure and alignment was developed for the SimulFold program <xref ref-type="bibr" rid="pcbi.1000483-Meyer1">[101]</xref>. SimulFold does not use a strictly normalized probabilistic model, resulting in some oddities in the ways that structure and indels interact (for example, it does not penalize deletion of one half of a basepair). Currently, it is not clear how appropriate SimulFold would be for ancestral reconstruction, although it has several advantages (e.g., explicit treatment of pseudoknots). Of course, MCMC kernels are inherently adaptable to other purposes: the MCMC moves developed for SimulFold may be useful for inference under different models.</p>
<p>This paper focuses on the case where the tree topology is known, but many of the methods which we have described can be extended to the more general case where none of the possible constraints (phylogeny, structure or alignment) are final. For example, the probabilistic framework readily allows us to compare likelihoods of two different phylogenetic trees by constructing a composite transducer for each tree. Thus, the MCMC samplers described above for alignments could, in principal, be extended to phylogenies (albeit at a computational cost).</p>
<p>While MCMC provides the most information about the posterior distribution of evolutionary histories, in practice a maximum likelihood inference may be adequate (and typically much faster). The progressive profiling used by the Ortheus program for reconstructing ancestral genomes is promising <xref ref-type="bibr" rid="pcbi.1000483-Paten1">[33]</xref>. This approach is similar to a progressive multiple alignment algorithm, in that it proceeds via a single postorder (leaf-to-root) traversal of the phylogeny. As each node is visited, a profile is generated for that node, by aligning the profiles of its children to a composite transducer using DP, then sampling a finite number of traceback paths through the DP matrix. The profile is not linear: the sampled paths instead form a reticulate network, a.k.a. a partial order graph <xref ref-type="bibr" rid="pcbi.1000483-Lee2">[102]</xref>. An equivalent of Ortheus for RNA reconstruction should be possible, representing the intermediate profiles using transducers.</p>
<p>Given the excellent performance of Stemloc-AMA 's sequence annealing, particularly when measured using its own scoring metric (AMA), such posterior-decoding methods should also be considered for reconstruction.</p>
<p>In summary, the evolutionary models and algorithms we have described form a systematic theoretical platform on which we can test different optimization and sampling strategies for studying the structural evolution of RNA gene families in detail. Stochastic grammars are powerful tools for this task, although they will not be the only tools we need, particularly as we move towards modeling RNA evolution in greater detail. Our hope is that these algorithms will allow us to test and refine our understanding of RNA evolution by computational reconstruction and (eventually) direct experimental investigation of early ribonucleic machines.</p>
</sec><sec id="s5">
<title>Supporting Information</title>
<supplementary-material id="pcbi.1000483.s001" mimetype="application/pdf" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.s001" xlink:type="simple"><label>Text S1</label><caption>
<p>Formal description of transducer composition algorithm yielding phylogenetic grammar rules</p>
<p>(0.15 MB PDF)</p>
</caption></supplementary-material><supplementary-material id="pcbi.1000483.s002" mimetype="application/pdf" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.s002" xlink:type="simple"><label>Text S2</label><caption>
<p>Algorithm for elimination of null cycles and empty bifurcations from general SCFGs</p>
<p>(0.13 MB PDF)</p>
</caption></supplementary-material><supplementary-material id="pcbi.1000483.s003" mimetype="application/pdf" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.s003" xlink:type="simple"><label>Text S3</label><caption>
<p>Description of software tools</p>
<p>(0.09 MB PDF)</p>
</caption></supplementary-material><supplementary-material id="pcbi.1000483.s004" mimetype="application/pdf" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.s004" xlink:type="simple"><label>Text S4</label><caption>
<p>Example presentation of TKFST inference grammars in Indiegram format</p>
<p>(0.14 MB PDF)</p>
</caption></supplementary-material><supplementary-material id="pcbi.1000483.s005" mimetype="text/plain" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.s005" xlink:type="simple"><label>Dataset S1</label><caption>
<p>Grammar for three-taxon TKFST model returned by transducer composition algorithm (graphviz dot format)</p>
<p>(0.03 MB TXT)</p>
</caption></supplementary-material><supplementary-material id="pcbi.1000483.s006" mimetype="text/plain" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1000483.s006" xlink:type="simple"><label>Dataset S2</label><caption>
<p>Grammar for three-taxon TKFST model returned by transducer composition algorithm, after eliminating windback states (graphviz dot format)</p>
<p>(0.06 MB TXT)</p>
</caption></supplementary-material></sec></body>
<back>
<ack>
<p>We thank Jeff Thorne, Jamie Cate, Jennifer Doudna, Jotun Hein, David Haussler, Sean Eddy, Elena Rivas and Eric Westhof for inspirational discussions. We are grateful to Ben Redelings and one anonymous referee for illuminating criticism.</p>
</ack>
<ref-list>
<title>References</title>
<ref id="pcbi.1000483-Crick1"><label>1</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Crick</surname><given-names>FH</given-names></name>
</person-group>             <year>1968</year>             <article-title>The origin of the genetic code.</article-title>             <source>Journal of Molecular Biology</source>             <volume>38</volume>             <fpage>367</fpage>             <lpage>379</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Smith1"><label>2</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Smith</surname><given-names>TF</given-names></name>
<name name-style="western"><surname>Lee</surname><given-names>JC</given-names></name>
<name name-style="western"><surname>Gutell</surname><given-names>RR</given-names></name>
<name name-style="western"><surname>Hartman</surname><given-names>H</given-names></name>
</person-group>             <year>2008</year>             <article-title>The origin and evolution of the ribosome.</article-title>             <source>Biology Direct</source>             <volume>3</volume>             <fpage>16</fpage>          </element-citation></ref>
<ref id="pcbi.1000483-Lehmann1"><label>3</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Lehmann</surname><given-names>K</given-names></name>
<name name-style="western"><surname>Schmidt</surname><given-names>U</given-names></name>
</person-group>             <year>2003</year>             <article-title>Group II introns: structure and catalytic versatility of large natural ribozymes.</article-title>             <source>Critical Reviews in Biochemistry and Molecular Biology</source>             <volume>38</volume>             <fpage>249</fpage>             <lpage>303</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Antal1"><label>4</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Antal</surname><given-names>M</given-names></name>
<name name-style="western"><surname>Boros</surname><given-names>E</given-names></name>
<name name-style="western"><surname>Solymosy</surname><given-names>F</given-names></name>
<name name-style="western"><surname>Kiss</surname><given-names>T</given-names></name>
</person-group>             <year>2002</year>             <article-title>Analysis of the structure of human telomerase RNA in vivo.</article-title>             <source>Nucleic Acids Research</source>             <volume>30</volume>             <fpage>912</fpage>             <lpage>920</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-GriffithsJones1"><label>5</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Griffiths-Jones</surname><given-names>S</given-names></name>
<name name-style="western"><surname>Bateman</surname><given-names>A</given-names></name>
<name name-style="western"><surname>Marshall</surname><given-names>M</given-names></name>
<name name-style="western"><surname>Khanna</surname><given-names>A</given-names></name>
<name name-style="western"><surname>Eddy</surname><given-names>SR</given-names></name>
</person-group>             <year>2003</year>             <article-title>Rfam: an RNA family database.</article-title>             <source>Nucleic Acids Research</source>             <volume>31</volume>             <fpage>439</fpage>             <lpage>441</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Hancock1"><label>6</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Hancock</surname><given-names>JM</given-names></name>
<name name-style="western"><surname>Tautz</surname><given-names>D</given-names></name>
<name name-style="western"><surname>Dover</surname><given-names>GA</given-names></name>
</person-group>             <year>1988</year>             <article-title>Evolution of the secondary structures and compensatory mutations of the ribosomal RNAs of Drosophila melanogaster.</article-title>             <source>Molecular Biology and Evolution</source>             <volume>5</volume>             <fpage>393</fpage>             <lpage>414</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Leontis1"><label>7</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Leontis</surname><given-names>NB</given-names></name>
<name name-style="western"><surname>Stombaugh</surname><given-names>J</given-names></name>
<name name-style="western"><surname>Westhof</surname><given-names>E</given-names></name>
</person-group>             <year>2002</year>             <article-title>Motif prediction in ribosomal RNAs: Lessons and prospects for automated motif prediction in homologous RNA molecules.</article-title>             <source>Biochimie</source>             <volume>84</volume>             <fpage>961</fpage>             <lpage>973</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Yokoyama1"><label>8</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Yokoyama</surname><given-names>T</given-names></name>
<name name-style="western"><surname>Suzuki</surname><given-names>T</given-names></name>
</person-group>             <year>2008</year>             <article-title>Ribosomal RNAs are tolerant toward genetic insertions: evolutionary origin of the expansion segments.</article-title>             <source>Nucleic Acids Research</source>             <volume>36</volume>             <fpage>3539</fpage>             <lpage>3551</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Hancock2"><label>9</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Hancock</surname><given-names>JM</given-names></name>
<name name-style="western"><surname>Dover</surname><given-names>GA</given-names></name>
</person-group>             <year>1990</year>             <article-title>‘compensatory slippage’ in the evolution of ribosomal RNA genes.</article-title>             <source>Nucleic Acids Research</source>             <volume>18</volume>             <fpage>5949</fpage>             <lpage>5954</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Eddy1"><label>10</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Eddy</surname><given-names>SR</given-names></name>
<name name-style="western"><surname>Durbin</surname><given-names>R</given-names></name>
</person-group>             <year>1994</year>             <article-title>RNA sequence analysis using covariance models.</article-title>             <source>Nucleic Acids Research</source>             <volume>22</volume>             <fpage>2079</fpage>             <lpage>2088</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Durbin1"><label>11</label><element-citation publication-type="other" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Durbin</surname><given-names>R</given-names></name>
<name name-style="western"><surname>Eddy</surname><given-names>S</given-names></name>
<name name-style="western"><surname>Krogh</surname><given-names>A</given-names></name>
<name name-style="western"><surname>Mitchison</surname><given-names>G</given-names></name>
</person-group>             <year>1998</year>             <source>Biological Sequence Analysis: Probabilistic Models of Proteins and Nucleic Acids</source>             <publisher-loc>Cambridge, UK</publisher-loc>             <publisher-name>Cambridge University Press</publisher-name>          </element-citation></ref>
<ref id="pcbi.1000483-Klein1"><label>12</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Klein</surname><given-names>R</given-names></name>
<name name-style="western"><surname>Eddy</surname><given-names>SR</given-names></name>
</person-group>             <year>2003</year>             <article-title>Noncoding RNA gene detection using comparative sequence analysis.</article-title>             <source>BMC Bioinformatics</source>             <volume>4</volume>          </element-citation></ref>
<ref id="pcbi.1000483-Nawrocki1"><label>13</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Nawrocki</surname><given-names>E</given-names></name>
<name name-style="western"><surname>Eddy</surname><given-names>S</given-names></name>
</person-group>             <year>2007</year>             <article-title>Query-dependent banding (QDB) for faster RNA similarity searches.</article-title>             <source>PLoS Computational Biology</source>             <volume>3</volume>             <fpage>e56</fpage>          </element-citation></ref>
<ref id="pcbi.1000483-Rivas1"><label>14</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Rivas</surname><given-names>E</given-names></name>
<name name-style="western"><surname>Eddy</surname><given-names>SR</given-names></name>
</person-group>             <year>1999</year>             <article-title>A dynamic programming algorithm for RNA structure prediction including pseudoknots.</article-title>             <source>Journal of Molecular Biology</source>             <volume>285</volume>             <fpage>2053</fpage>             <lpage>2068</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Pedersen1"><label>15</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Pedersen</surname><given-names>JS</given-names></name>
<name name-style="western"><surname>Bejerano</surname><given-names>G</given-names></name>
<name name-style="western"><surname>Siepel</surname><given-names>A</given-names></name>
<name name-style="western"><surname>Rosenbloom</surname><given-names>K</given-names></name>
<name name-style="western"><surname>Lindblad-Toh</surname><given-names>K</given-names></name>
<etal/></person-group>             <year>2006</year>             <article-title>Identification and classification of conserved RNA secondary structures in the human genome.</article-title>             <source>PLoS Computational Biology</source>             <volume>2</volume>             <fpage>e33</fpage>          </element-citation></ref>
<ref id="pcbi.1000483-Knudsen1"><label>16</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Knudsen</surname><given-names>B</given-names></name>
<name name-style="western"><surname>Hein</surname><given-names>J</given-names></name>
</person-group>             <year>2003</year>             <article-title>Pfold: RNA secondary structure prediction using stochastic contextfree grammars.</article-title>             <source>Nucleic Acids Research</source>             <volume>31</volume>             <fpage>3423</fpage>             <lpage>3428</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Dowell1"><label>17</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Dowell</surname><given-names>RD</given-names></name>
<name name-style="western"><surname>Eddy</surname><given-names>SR</given-names></name>
</person-group>             <year>2004</year>             <article-title>Evaluation of several lightweight stochastic context-free grammars for RNA secondary structure prediction.</article-title>             <source>BMC Bioinformatics</source>             <volume>5</volume>          </element-citation></ref>
<ref id="pcbi.1000483-Holmes1"><label>18</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Holmes</surname><given-names>I</given-names></name>
</person-group>             <year>2005</year>             <article-title>Accelerated probabilistic inference of RNA structure evolution.</article-title>             <source>BMC Bioinformatics</source>             <volume>6</volume>          </element-citation></ref>
<ref id="pcbi.1000483-Dowell2"><label>19</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Dowell</surname><given-names>RD</given-names></name>
<name name-style="western"><surname>Eddy</surname><given-names>SR</given-names></name>
</person-group>             <year>2006</year>             <article-title>Efficient pairwise RNA structure prediction and alignment using sequence alignment constraints.</article-title>             <source>BMC Bioinformatics</source>             <volume>7</volume>          </element-citation></ref>
<ref id="pcbi.1000483-Bradley1"><label>20</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Bradley</surname><given-names>RK</given-names></name>
<name name-style="western"><surname>Pachter</surname><given-names>L</given-names></name>
<name name-style="western"><surname>Holmes</surname><given-names>I</given-names></name>
</person-group>             <year>2008</year>             <article-title>Specific alignment of structured RNA: Stochastic grammars and sequence annealing.</article-title>             <source>Bioinformatics</source>             <volume>24</volume>             <fpage>2677</fpage>             <lpage>2683</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Felsenstein1"><label>21</label><element-citation publication-type="other" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Felsenstein</surname><given-names>J</given-names></name>
</person-group>             <year>2003</year>             <source>Inferring Phylogenies.</source>             <publisher-name>Sinauer Associates, Inc.</publisher-name>             <comment>ISBN 0878931775</comment>          </element-citation></ref>
<ref id="pcbi.1000483-Felsenstein2"><label>22</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Felsenstein</surname><given-names>J</given-names></name>
</person-group>             <year>1981</year>             <article-title>Evolutionary trees from DNA sequences: a maximum likelihood approach.</article-title>             <source>Journal of Molecular Evolution</source>             <volume>17</volume>             <fpage>368</fpage>             <lpage>376</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Elston1"><label>23</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Elston</surname><given-names>RC</given-names></name>
<name name-style="western"><surname>Stewart</surname><given-names>J</given-names></name>
</person-group>             <year>1971</year>             <article-title>A general model for the genetic analysis of pedigree data.</article-title>             <source>Human Heredity</source>             <volume>21</volume>             <fpage>523</fpage>             <lpage>542</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Holmes2"><label>24</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Holmes</surname><given-names>I</given-names></name>
<name name-style="western"><surname>Rubin</surname><given-names>GM</given-names></name>
</person-group>             <year>2002</year>             <article-title>An Expectation Maximization algorithm for training hidden substitution models.</article-title>             <source>Journal of Molecular Biology</source>             <volume>317</volume>             <fpage>757</fpage>             <lpage>768</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Nielsen1"><label>25</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Nielsen</surname><given-names>R</given-names></name>
</person-group>             <year>2001</year>             <article-title>Mutations as missing data: inferences on the ages and distributions of nonsynonymous and synonymous mutations.</article-title>             <source>Genetics</source>             <volume>159</volume>             <fpage>401</fpage>             <lpage>411</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Pearl1"><label>26</label><element-citation publication-type="other" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Pearl</surname><given-names>J</given-names></name>
</person-group>             <year>1982</year>             <article-title>Reverend Bayes on inference engines: A distributed hierarchical approach.</article-title>             <source>Proceedings American Association of Artificial Intelligence National Conference on AI</source>             <publisher-loc>Pittsburgh, PA. </publisher-loc>             <fpage>133</fpage>             <lpage>136</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Yang1"><label>27</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Yang</surname><given-names>Z</given-names></name>
</person-group>             <year>1994</year>             <article-title>Estimating the pattern of nucleotide substitution.</article-title>             <source>Journal of Molecular Evolution</source>             <volume>39</volume>             <fpage>105</fpage>             <lpage>111</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Whelan1"><label>28</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Whelan</surname><given-names>S</given-names></name>
<name name-style="western"><surname>Goldman</surname><given-names>N</given-names></name>
</person-group>             <year>2001</year>             <article-title>A general empirical model of protein evolution derived from multiple protein families using a maximum-likelihood approach.</article-title>             <source>Molecular Biology and Evolution</source>             <volume>18</volume>             <fpage>691</fpage>             <lpage>699</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Holmes3"><label>29</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Holmes</surname><given-names>I</given-names></name>
</person-group>             <year>2004</year>             <article-title>A probabilistic model for the evolution of RNA structure.</article-title>             <source>BMC Bioinformatics</source>             <volume>5</volume>          </element-citation></ref>
<ref id="pcbi.1000483-Holmes4"><label>30</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Holmes</surname><given-names>I</given-names></name>
<name name-style="western"><surname>Bruno</surname><given-names>WJ</given-names></name>
</person-group>             <year>2001</year>             <article-title>Evolutionary HMMs: a Bayesian approach to multiple alignment.</article-title>             <source>Bioinformatics</source>             <volume>17</volume>             <fpage>803</fpage>             <lpage>820</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Jensen1"><label>31</label><element-citation publication-type="other" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Jensen</surname><given-names>J</given-names></name>
<name name-style="western"><surname>Hein</surname><given-names>J</given-names></name>
</person-group>             <year>2002</year>             <source>Gibbs sampler for statistical multiple alignment</source>             <publisher-loc>Aarhus, Denmark</publisher-loc>             <publisher-name>Dept. of Theoretical Statistics, University of Aarhus</publisher-name>             <comment>Technical Report No. 429</comment>          </element-citation></ref>
<ref id="pcbi.1000483-Redelings1"><label>32</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Redelings</surname><given-names>BD</given-names></name>
<name name-style="western"><surname>Suchard</surname><given-names>MA</given-names></name>
</person-group>             <year>2005</year>             <article-title>Joint bayesian estimation of alignment and phylogeny.</article-title>             <source>Systematic Biology</source>             <volume>54</volume>             <fpage>401</fpage>             <lpage>418</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Paten1"><label>33</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Paten</surname><given-names>B</given-names></name>
<name name-style="western"><surname>Herrero</surname><given-names>J</given-names></name>
<name name-style="western"><surname>Fitzgerald</surname><given-names>S</given-names></name>
<name name-style="western"><surname>Flicek</surname><given-names>P</given-names></name>
<name name-style="western"><surname>Holmes</surname><given-names>I</given-names></name>
<etal/></person-group>             <year>2008</year>             <article-title>Genome-wide nucleotide level mammalian ancestor reconstruction.</article-title>             <source>Genome Research</source>             <volume>18</volume>             <fpage>1829</fpage>             <lpage>1843</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Rivas2"><label>34</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Rivas</surname><given-names>E</given-names></name>
<name name-style="western"><surname>Eddy</surname><given-names>SR</given-names></name>
</person-group>             <year>2001</year>             <article-title>Noncoding RNA gene detection using comparative sequence analysis.</article-title>             <source>BMC Bioinformatics</source>             <volume>2</volume>          </element-citation></ref>
<ref id="pcbi.1000483-Bradley2"><label>35</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Bradley</surname><given-names>RK</given-names></name>
<name name-style="western"><surname>Holmes</surname><given-names>I</given-names></name>
</person-group>             <year>2007</year>             <article-title>Transducers: an emerging probabilistic framework for modeling indels on trees.</article-title>             <source>Bioinformatics</source>             <volume>23</volume>             <fpage>3258</fpage>             <lpage>3262</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Comon1"><label>36</label><element-citation publication-type="other" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Comon</surname><given-names>H</given-names></name>
<name name-style="western"><surname>Dauchet</surname><given-names>M</given-names></name>
<name name-style="western"><surname>Gilleron</surname><given-names>R</given-names></name>
<name name-style="western"><surname>L¨oding</surname><given-names>C</given-names></name>
<name name-style="western"><surname>Jacquemard</surname><given-names>F</given-names></name>
<etal/></person-group>             <year>2007</year>             <article-title>Tree Automata Techniques and Applications,</article-title>             <fpage>161</fpage>             <lpage>182</lpage>             <comment>Available from: <ext-link ext-link-type="uri" xlink:href="http://tata.gforge.inria.fr/" xlink:type="simple">http://tata.gforge.inria.fr/</ext-link>, chapter 6 (“Tree Transducers”)</comment>             <comment>Release October, 12th 2007</comment>          </element-citation></ref>
<ref id="pcbi.1000483-Gecseg1"><label>37</label><element-citation publication-type="other" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>G'ecseg</surname><given-names>F</given-names></name>
<name name-style="western"><surname>Steinby</surname><given-names>M</given-names></name>
</person-group>             <year>1997</year>             <fpage>1</fpage>             <lpage>61</lpage>             <comment>Handbook of formal languages, Volume 3: Beyond Words, Springer-Verlag, chapter Tree languages</comment>          </element-citation></ref>
<ref id="pcbi.1000483-Rivas3"><label>38</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Rivas</surname><given-names>E</given-names></name>
<name name-style="western"><surname>Eddy</surname><given-names>S</given-names></name>
</person-group>             <year>2008</year>             <article-title>Probabilistic phylogenetic inference with insertions and deletions.</article-title>             <source>PLoS Computational Biology</source>             <volume>4</volume>             <fpage>e1000172</fpage>          </element-citation></ref>
<ref id="pcbi.1000483-Holmes5"><label>39</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Holmes</surname><given-names>I</given-names></name>
</person-group>             <year>2003</year>             <article-title>Using guide trees to construct multiple-sequence evolutionary HMMs.</article-title>             <source>Bioinformatics</source>             <volume>19</volume>             <supplement>Suppl. 1</supplement>             <fpage>i147</fpage>             <lpage>157</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Holmes6"><label>40</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Holmes</surname><given-names>I</given-names></name>
</person-group>             <year>2007</year>             <article-title>Phylocomposer and Phylodirector: Analysis and Visualization of Transducer Indel Models.</article-title>             <source>Bioinformatics</source>             <volume>23</volume>             <fpage>3263</fpage>             <lpage>3264</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Lunter1"><label>41</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Lunter</surname><given-names>G</given-names></name>
</person-group>             <year>2007</year>             <article-title>HMMoC–a compiler for hidden Markov models.</article-title>             <source>Bioinformatics</source>             <volume>23</volume>             <fpage>2485</fpage>             <lpage>2487</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Sankoff1"><label>42</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Sankoff</surname><given-names>D</given-names></name>
</person-group>             <year>1985</year>             <article-title>Simultaneous solution of the RNA folding, alignment, and protosequence problems.</article-title>             <source>SIAM Journal of Applied Mathematics</source>             <volume>45</volume>             <fpage>810</fpage>             <lpage>825</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Holmes7"><label>43</label><element-citation publication-type="other" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Holmes</surname><given-names>I</given-names></name>
<name name-style="western"><surname>Rubin</surname><given-names>GM</given-names></name>
</person-group>             <year>2002</year>             <article-title>Pairwise RNA structure comparison using stochastic context-free grammars.</article-title>             <comment>Pacific Symposium on Biocomputing, 2002</comment>          </element-citation></ref>
<ref id="pcbi.1000483-Thorne1"><label>44</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Thorne</surname><given-names>JL</given-names></name>
<name name-style="western"><surname>Kishino</surname><given-names>H</given-names></name>
<name name-style="western"><surname>Felsenstein</surname><given-names>J</given-names></name>
</person-group>             <year>1991</year>             <article-title>An evolutionary model for maximum likelihood alignment of DNA sequences.</article-title>             <source>Journal of Molecular Evolution</source>             <volume>33</volume>             <fpage>114</fpage>             <lpage>124</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Kendall1"><label>45</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Kendall</surname><given-names>DG</given-names></name>
</person-group>             <year>1948</year>             <article-title>On the generalized birth-and-death process.</article-title>             <source>Annals of Mathematical Statistics</source>             <volume>19</volume>             <fpage>1</fpage>             <lpage>15</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Feller1"><label>46</label><element-citation publication-type="other" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Feller</surname><given-names>W</given-names></name>
</person-group>             <year>1971</year>             <source>An Introduction to Probability Theory and its Applications, Vol II</source>             <publisher-loc>New York</publisher-loc>             <publisher-name>John Wiley and Sons</publisher-name>          </element-citation></ref>
<ref id="pcbi.1000483-Bradley3"><label>47</label><element-citation publication-type="other" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Bradley</surname><given-names>RK</given-names></name>
<name name-style="western"><surname>Uzilov</surname><given-names>AV</given-names></name>
<name name-style="western"><surname>Skinner</surname><given-names>M</given-names></name>
<name name-style="western"><surname>Bendana</surname><given-names>YR</given-names></name>
<name name-style="western"><surname>Varadarajan</surname><given-names>A</given-names></name>
<etal/></person-group>             <year>2008</year>             <article-title>Non-coding RNA gene predictors in Drosophila.</article-title>             <comment>Submitted</comment>          </element-citation></ref>
<ref id="pcbi.1000483-Sprinzl1"><label>48</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Sprinzl</surname><given-names>M</given-names></name>
<name name-style="western"><surname>Horn</surname><given-names>C</given-names></name>
<name name-style="western"><surname>Brown</surname><given-names>M</given-names></name>
<name name-style="western"><surname>Ioudovitch</surname><given-names>A</given-names></name>
<name name-style="western"><surname>Steinberg</surname><given-names>S</given-names></name>
</person-group>             <year>1998</year>             <article-title>Compilation of tRNA sequences and sequences of tRNA genes.</article-title>             <source>Nucleic Acids Research</source>             <volume>26</volume>             <fpage>148</fpage>             <lpage>53</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Rijk1"><label>49</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Rijk</surname><given-names>PD</given-names></name>
<name name-style="western"><surname>Caers</surname><given-names>A</given-names></name>
<name name-style="western"><surname>Peer</surname><given-names>YVd</given-names></name>
<name name-style="western"><surname>Wachter</surname><given-names>RD</given-names></name>
</person-group>             <year>1998</year>             <article-title>Database on the structure of large ribosomal subunit RNA.</article-title>             <source>Nucleic Acids Research</source>             <volume>26</volume>             <fpage>183</fpage>             <lpage>6</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Gutell1"><label>50</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Gutell</surname><given-names>RR</given-names></name>
</person-group>             <year>1993</year>             <article-title>Collection of small subunit (16S and 16S-like) ribosomal RNA structures.</article-title>             <source>Nucleic Acids Research</source>             <volume>21</volume>             <fpage>3051</fpage>             <lpage>3054</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Holmes8"><label>51</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Holmes</surname><given-names>I</given-names></name>
<name name-style="western"><surname>Durbin</surname><given-names>R</given-names></name>
</person-group>             <year>1998</year>             <article-title>Dynamic programming alignment accuracy.</article-title>             <source>Journal of Computational Biology</source>             <volume>5</volume>             <fpage>493</fpage>             <lpage>504</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Schwartz1"><label>52</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Schwartz</surname><given-names>AS</given-names></name>
<name name-style="western"><surname>Pachter</surname><given-names>L</given-names></name>
</person-group>             <year>2007</year>             <article-title>Multiple alignment by sequence annealing.</article-title>             <source>Bioinformatics</source>             <volume>23</volume>             <fpage>e24</fpage>             <lpage>9</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Mikls1"><label>53</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Miklós</surname><given-names>I</given-names></name>
<name name-style="western"><surname>Lunter</surname><given-names>G</given-names></name>
<name name-style="western"><surname>Holmes</surname><given-names>I</given-names></name>
</person-group>             <year>2004</year>             <article-title>A long indel model for evolutionary sequence alignment.</article-title>             <source>Molecular Biology and Evolution</source>             <volume>21</volume>             <fpage>529</fpage>             <lpage>540</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Schwartz2"><label>54</label><element-citation publication-type="other" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Schwartz</surname><given-names>AS</given-names></name>
<name name-style="western"><surname>Myers</surname><given-names>EW</given-names></name>
<name name-style="western"><surname>Pachter</surname><given-names>L</given-names></name>
</person-group>             <year>2006</year>             <article-title>Alignment metric accuracy.</article-title>             <comment><ext-link ext-link-type="uri" xlink:href="http://arxiv.org/abs/qbio/0510052" xlink:type="simple">http://arxiv.org/abs/qbio/0510052</ext-link></comment>          </element-citation></ref>
<ref id="pcbi.1000483-Gardner1"><label>55</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Gardner</surname><given-names>PP</given-names></name>
<name name-style="western"><surname>Wilm</surname><given-names>A</given-names></name>
<name name-style="western"><surname>Washietl</surname><given-names>S</given-names></name>
</person-group>             <year>2005</year>             <article-title>A benchmark of multiple sequence alignment programs upon structural RNAs.</article-title>             <source>Nucleic Acids Research</source>             <volume>33</volume>             <fpage>2433</fpage>             <lpage>2439</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Wilm1"><label>56</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Wilm</surname><given-names>A</given-names></name>
<name name-style="western"><surname>Mainz</surname><given-names>I</given-names></name>
<name name-style="western"><surname>Steger</surname><given-names>G</given-names></name>
</person-group>             <year>2006</year>             <article-title>An enhanced RNA alignment benchmark for sequence alignment programs.</article-title>             <source>Algorithms for Molecular Biology</source>             <volume>1</volume>             <fpage>19</fpage>          </element-citation></ref>
<ref id="pcbi.1000483-Pauling1"><label>57</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Pauling</surname><given-names>L</given-names></name>
<name name-style="western"><surname>Zuckerkandl</surname><given-names>E</given-names></name>
</person-group>             <year>1963</year>             <article-title>Chemical paleogenetics, molecular “restoration studies” of extinct forms of life.</article-title>             <source>Acta Chemica Scandinavica</source>             <volume>17</volume>             <fpage>S9</fpage>             <lpage>S16</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Malcolm1"><label>58</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Malcolm</surname><given-names>BA</given-names></name>
<name name-style="western"><surname>Wilson</surname><given-names>KP</given-names></name>
<name name-style="western"><surname>Matthews</surname><given-names>BW</given-names></name>
<name name-style="western"><surname>Kirsch</surname><given-names>JF</given-names></name>
<name name-style="western"><surname>Wilson</surname><given-names>AC</given-names></name>
</person-group>             <year>1990</year>             <article-title>Ancestral lysozymes reconstructed, neutrality tested, and thermostability linked to hydrocarbon packing.</article-title>             <source>Nature</source>             <volume>345</volume>             <fpage>86</fpage>             <lpage>89</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Stackhouse1"><label>59</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Stackhouse</surname><given-names>J</given-names></name>
<name name-style="western"><surname>Presnell</surname><given-names>SR</given-names></name>
<name name-style="western"><surname>McGeehan</surname><given-names>GM</given-names></name>
<name name-style="western"><surname>Nambiar</surname><given-names>KP</given-names></name>
<name name-style="western"><surname>Benner</surname><given-names>SA</given-names></name>
</person-group>             <year>1990</year>             <article-title>The ribonuclease from an extinct bovid ruminant.</article-title>             <source>FEBS letters</source>             <volume>262</volume>             <fpage>104</fpage>             <lpage>106</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Zhang1"><label>60</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Zhang</surname><given-names>J</given-names></name>
<name name-style="western"><surname>Rosenberg</surname><given-names>HF</given-names></name>
</person-group>             <year>2002</year>             <article-title>Complementary advantageous substitutions in the evolution of an antiviral RNase of higher primates.</article-title>             <source>Proceedings of the National Academy of Sciences of the United States of America</source>             <volume>99</volume>             <fpage>5486</fpage>             <lpage>5491</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Gaucher1"><label>61</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Gaucher</surname><given-names>EA</given-names></name>
<name name-style="western"><surname>Thomson</surname><given-names>JM</given-names></name>
<name name-style="western"><surname>Burgan</surname><given-names>MF</given-names></name>
<name name-style="western"><surname>Benner</surname><given-names>SA</given-names></name>
</person-group>             <year>2003</year>             <article-title>Inferring the palaeoenvironment of ancient bacteria on the basis of resurrected proteins.</article-title>             <source>Nature</source>             <volume>425</volume>             <fpage>285</fpage>             <lpage>288</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Thomson1"><label>62</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Thomson</surname><given-names>JM</given-names></name>
<name name-style="western"><surname>Gaucher</surname><given-names>EA</given-names></name>
<name name-style="western"><surname>Burgan</surname><given-names>MF</given-names></name>
<name name-style="western"><surname>De Kee</surname><given-names>DW</given-names></name>
<name name-style="western"><surname>Li</surname><given-names>T</given-names></name>
<etal/></person-group>             <year>2005</year>             <article-title>Resurrecting ancestral alcohol dehydrogenases from yeast.</article-title>             <source>Nature Genetics</source>             <volume>37</volume>             <fpage>630</fpage>             <lpage>635</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Chang1"><label>63</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Chang</surname><given-names>BSW</given-names></name>
<name name-style="western"><surname>Jönsson</surname><given-names>K</given-names></name>
<name name-style="western"><surname>Kazmi</surname><given-names>MA</given-names></name>
<name name-style="western"><surname>Donoghue</surname><given-names>MJ</given-names></name>
<name name-style="western"><surname>Sakmar</surname><given-names>TP</given-names></name>
</person-group>             <year>2002</year>             <article-title>Recreating a functional ancestral archosaur visual pigment.</article-title>             <source>Molecular biology and evolution</source>             <volume>19</volume>             <fpage>1483</fpage>             <lpage>1489</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Sun1"><label>64</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Sun</surname><given-names>H</given-names></name>
<name name-style="western"><surname>Merugu</surname><given-names>S</given-names></name>
<name name-style="western"><surname>Gu</surname><given-names>X</given-names></name>
<name name-style="western"><surname>Kang</surname><given-names>YY</given-names></name>
<name name-style="western"><surname>Dickinson</surname><given-names>DP</given-names></name>
<etal/></person-group>             <year>2002</year>             <article-title>Identification of essential amino acid changes in paired domain evolution using a novel combination of evolutionary analysis and in vitro and in vivo studies.</article-title>             <source>Molecular Biology and Evolution</source>             <volume>19</volume>             <fpage>1490</fpage>             <lpage>1500</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Ortlund1"><label>65</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Ortlund</surname><given-names>EA</given-names></name>
<name name-style="western"><surname>Bridgham</surname><given-names>JT</given-names></name>
<name name-style="western"><surname>Redinbo</surname><given-names>MR</given-names></name>
<name name-style="western"><surname>Thornton</surname><given-names>JW</given-names></name>
</person-group>             <year>2007</year>             <article-title>Crystal structure of an ancient protein: evolution by conformational epistasis.</article-title>             <source>Science</source>             <volume>317</volume>             <fpage>1544</fpage>             <lpage>8</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Ivics1"><label>66</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Ivics</surname><given-names>Z</given-names></name>
<name name-style="western"><surname>Hackett</surname><given-names>PB</given-names></name>
<name name-style="western"><surname>Plasterk</surname><given-names>RH</given-names></name>
<name name-style="western"><surname>Izsvak</surname><given-names>Z</given-names></name>
</person-group>             <year>1997</year>             <article-title>Molecular reconstruction of Sleeping Beauty, a Tc1-like transposon from fish, and its transposition in human cells.</article-title>             <source>Cell</source>             <volume>91</volume>             <fpage>501</fpage>             <lpage>10</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Adey1"><label>67</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Adey</surname><given-names>NB</given-names></name>
<name name-style="western"><surname>Tollefsbol</surname><given-names>TO</given-names></name>
<name name-style="western"><surname>Sparks</surname><given-names>AB</given-names></name>
<name name-style="western"><surname>Edgell</surname><given-names>MH</given-names></name>
<name name-style="western"><surname>Hutchison</surname><given-names>CA</given-names></name>
</person-group>             <year>1994</year>             <article-title>Molecular resurrection of an extinct ancestral promoter for mouse l1.</article-title>             <source>Proceedings of the National Academy of Sciences of the United States of America</source>             <volume>91</volume>             <fpage>1569</fpage>             <lpage>1573</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Blanchette1"><label>68</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Blanchette</surname><given-names>M</given-names></name>
<name name-style="western"><surname>Green</surname><given-names>ED</given-names></name>
<name name-style="western"><surname>Miller</surname><given-names>W</given-names></name>
<name name-style="western"><surname>Haussler</surname><given-names>D</given-names></name>
</person-group>             <year>2004</year>             <article-title>Reconstructing large regions of an ancestral mammalian genome in silico.</article-title>             <source>Genome Research</source>             <volume>14</volume>             <fpage>2412</fpage>             <lpage>2423</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Noonan1"><label>69</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Noonan</surname><given-names>JP</given-names></name>
<name name-style="western"><surname>Coop</surname><given-names>G</given-names></name>
<name name-style="western"><surname>Kudaravalli</surname><given-names>S</given-names></name>
<name name-style="western"><surname>Smith</surname><given-names>D</given-names></name>
<name name-style="western"><surname>Krause</surname><given-names>J</given-names></name>
<etal/></person-group>             <year>2006</year>             <article-title>Sequencing and analysis of Neanderthal genomic DNA.</article-title>             <source>Science</source>             <volume>314</volume>             <fpage>1113</fpage>             <lpage>1118</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Gaucher2"><label>70</label><element-citation publication-type="other" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Gaucher</surname><given-names>EA</given-names></name>
</person-group>             <year>2007</year>             <article-title>Ancestral sequence reconstruction as a tool to understand natural history and guide synthetic biology: realizing and extending the vision of Zuckerkandl and Pauling.</article-title>             <fpage>20</fpage>             <lpage>33</lpage>             <comment>In: Liberles [83], chapter 2</comment>          </element-citation></ref>
<ref id="pcbi.1000483-Elias1"><label>71</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Elias</surname><given-names>I</given-names></name>
<name name-style="western"><surname>Tuller</surname><given-names>T</given-names></name>
</person-group>             <year>2007</year>             <article-title>Reconstruction of ancestral genomic sequences using likelihood.</article-title>             <source>Journal of Computational Biology</source>             <volume>14</volume>             <fpage>216</fpage>             <lpage>37</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Marintchev1"><label>72</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Marintchev</surname><given-names>A</given-names></name>
<name name-style="western"><surname>Wagner</surname><given-names>G</given-names></name>
</person-group>             <year>2004</year>             <article-title>Translation initiation: structures, mechanisms and evolution.</article-title>             <source>Quarterly reviews of biophysics</source>             <volume>37</volume>             <fpage>197</fpage>             <lpage>284</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Muller1"><label>73</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Muller</surname><given-names>AWJ</given-names></name>
</person-group>             <year>2005</year>             <article-title>Thermosynthesis as energy source for the RNA world: a model for the bioenergetics of the origin of life.</article-title>             <source>Bio Systems</source>             <volume>82</volume>             <fpage>93</fpage>             <lpage>102</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-CavalierSmith1"><label>74</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Cavalier-Smith</surname><given-names>T</given-names></name>
</person-group>             <year>2006</year>             <article-title>Rooting the tree of life by transition analyses.</article-title>             <source>Biology Direct</source>             <volume>1</volume>             <fpage>19</fpage>          </element-citation></ref>
<ref id="pcbi.1000483-Martin1"><label>75</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Martin</surname><given-names>W</given-names></name>
<name name-style="western"><surname>Koonin</surname><given-names>EV</given-names></name>
</person-group>             <year>2006</year>             <article-title>Introns and the origin of nucleus-cytosol compartmentalization.</article-title>             <source>Nature</source>             <volume>440</volume>             <fpage>41</fpage>             <lpage>45</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Forterre1"><label>76</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Forterre</surname><given-names>P</given-names></name>
</person-group>             <year>2006</year>             <article-title>Three RNA cells for ribosomal lineages and three DNA viruses to replicate their genomes: a hypothesis for the origin of cellular domain.</article-title>             <source>Proceedings of the National Academy of Sciences of the USA</source>             <volume>103</volume>             <fpage>3669</fpage>             <lpage>3674</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Yakhnin1"><label>77</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Yakhnin</surname><given-names>AV</given-names></name>
</person-group>             <year>2007</year>             <article-title>A model for the origin of protein synthesis as coreplicational scanning of nascent RNA.</article-title>             <source>Origins of life and evolution of the biosphere : the journal of the International Society for the Study of the Origin of Life</source>             <volume>37</volume>             <fpage>523</fpage>             <lpage>536</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Danchin1"><label>78</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Danchin</surname><given-names>A</given-names></name>
<name name-style="western"><surname>Fang</surname><given-names>G</given-names></name>
<name name-style="western"><surname>Noria</surname><given-names>S</given-names></name>
</person-group>             <year>2007</year>             <article-title>The extant core bacterial proteome is an archive of the origin of life.</article-title>             <source>Proteomics</source>             <volume>7</volume>             <fpage>875</fpage>             <lpage>889</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Lee1"><label>79</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Lee</surname><given-names>RC</given-names></name>
<name name-style="western"><surname>Feinbaum</surname><given-names>RL</given-names></name>
<name name-style="western"><surname>Ambros</surname><given-names>V</given-names></name>
</person-group>             <year>1993</year>             <article-title>The C. elegans heterochronic gene lin-4 encodes small RNAs with antisense complementarity to lin-14.</article-title>             <source>Cell</source>             <volume>75</volume>             <fpage>843</fpage>             <lpage>854</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Lowe1"><label>80</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Lowe</surname><given-names>TM</given-names></name>
<name name-style="western"><surname>Eddy</surname><given-names>SR</given-names></name>
</person-group>             <year>1999</year>             <article-title>A computational screen for methylation guide snoRNAs in yeast.</article-title>             <source>Science</source>             <volume>283</volume>             <fpage>1168</fpage>             <lpage>1171</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Eddy2"><label>81</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Eddy</surname><given-names>SR</given-names></name>
</person-group>             <year>2001</year>             <article-title>Non-coding RNA genes and the modern RNA world.</article-title>             <source>Nature Reviews Genetics</source>             <volume>2</volume>             <fpage>919</fpage>             <lpage>929</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Mandal1"><label>82</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Mandal</surname><given-names>M</given-names></name>
<name name-style="western"><surname>Boese</surname><given-names>B</given-names></name>
<name name-style="western"><surname>Barrick</surname><given-names>JE</given-names></name>
<name name-style="western"><surname>Winkler</surname><given-names>WC</given-names></name>
<name name-style="western"><surname>Breaker</surname><given-names>RR</given-names></name>
</person-group>             <year>2003</year>             <article-title>Riboswitches control fundamental biochemical pathways in Bacillus subtilis and other bacteria.</article-title>             <source>Cell</source>             <volume>113</volume>             <fpage>577</fpage>             <lpage>586</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Liberles1"><label>83</label><element-citation publication-type="other" xlink:type="simple">             <person-group person-group-type="editor">
<name name-style="western"><surname>Liberles</surname><given-names>DA</given-names></name>
</person-group>             <year>2007</year>             <source>Ancestral Sequence Reconstruction.</source>             <publisher-name>Oxford University Press</publisher-name>          </element-citation></ref>
<ref id="pcbi.1000483-Edwards1"><label>84</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Edwards</surname><given-names>AWF</given-names></name>
<name name-style="western"><surname>Cavalli-Sforza</surname><given-names>L</given-names></name>
</person-group>             <year>1963</year>             <article-title>The reconstruction of evolution.</article-title>             <source>Annals of Human Genetics</source>             <volume>27</volume>             <fpage>105</fpage>          </element-citation></ref>
<ref id="pcbi.1000483-Hendy1"><label>85</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Hendy</surname><given-names>MD</given-names></name>
<name name-style="western"><surname>Penny</surname><given-names>D</given-names></name>
</person-group>             <year>1982</year>             <article-title>Branch and bound algorithms to determine minimal evolutionary trees.</article-title>             <source>Mathematical Biosciences</source>             <volume>59</volume>             <fpage>277</fpage>             <lpage>290</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Hein1"><label>86</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Hein</surname><given-names>J</given-names></name>
<name name-style="western"><surname>Wiuf</surname><given-names>C</given-names></name>
<name name-style="western"><surname>Knudsen</surname><given-names>B</given-names></name>
<name name-style="western"><surname>Moller</surname><given-names>MB</given-names></name>
<name name-style="western"><surname>Wibling</surname><given-names>G</given-names></name>
</person-group>             <year>2000</year>             <article-title>Statistical alignment: computational properties, homology testing and goodness-of-fit.</article-title>             <source>Journal of Molecular Biology</source>             <volume>302</volume>             <fpage>265</fpage>             <lpage>279</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Hein2"><label>87</label><element-citation publication-type="other" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Hein</surname><given-names>J</given-names></name>
</person-group>             <year>2001</year>             <article-title>An algorithm for statistical alignment of sequences related by a binary tree.</article-title>             <person-group person-group-type="editor">
<name name-style="western"><surname>Altman</surname><given-names>RB</given-names></name>
<name name-style="western"><surname>Dunker</surname><given-names>AK</given-names></name>
<name name-style="western"><surname>Hunter</surname><given-names>L</given-names></name>
<name name-style="western"><surname>Lauderdale</surname><given-names>K</given-names></name>
<name name-style="western"><surname>Klein</surname><given-names>TE</given-names></name>
</person-group>             <source>Pacific Symposium on Biocomputing</source>             <publisher-loc>Singapore</publisher-loc>             <publisher-name>World Scientific</publisher-name>             <fpage>179</fpage>             <lpage>190</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Steel1"><label>88</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Steel</surname><given-names>M</given-names></name>
<name name-style="western"><surname>Hein</surname><given-names>J</given-names></name>
</person-group>             <year>2001</year>             <article-title>Applying the Thorne-Kishino-Felsenstein model to sequence evolution on a star-shaped tree.</article-title>             <source>Applied Mathematics Letters</source>             <volume>14</volume>             <fpage>679</fpage>             <lpage>684</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Knudsen2"><label>89</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Knudsen</surname><given-names>B</given-names></name>
<name name-style="western"><surname>Miyamoto</surname><given-names>M</given-names></name>
</person-group>             <year>2003</year>             <article-title>Sequence alignments and pair hidden Markov models using evolutionary history.</article-title>             <source>Journal of Molecular Biology</source>             <volume>333</volume>             <fpage>453</fpage>             <lpage>460</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Lunter2"><label>90</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Lunter</surname><given-names>GA</given-names></name>
<name name-style="western"><surname>Miklós</surname><given-names>I</given-names></name>
<name name-style="western"><surname>Song</surname><given-names>YS</given-names></name>
<name name-style="western"><surname>Hein</surname><given-names>J</given-names></name>
</person-group>             <year>2003</year>             <article-title>An efficient algorithm for statistical multiple alignment on arbitrary phylogenetic trees.</article-title>             <source>Journal of Computational Biology</source>             <volume>10</volume>             <fpage>869</fpage>             <lpage>889</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Lunter3"><label>91</label><element-citation publication-type="other" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Lunter</surname><given-names>GA</given-names></name>
<name name-style="western"><surname>Drummond</surname><given-names>AJ</given-names></name>
<name name-style="western"><surname>Miklós</surname><given-names>I</given-names></name>
<name name-style="western"><surname>Hein</surname><given-names>J</given-names></name>
</person-group>             <year>2004</year>             <article-title>Statistical alignment: Recent progress, new applications, and challenges.</article-title>             <person-group person-group-type="editor">
<name name-style="western"><surname>Nielsen</surname><given-names>R</given-names></name>
</person-group>             <source>Statistical methods in Molecular Evolution, Springer Verlag, Series in Statistics in Health and Medicine, chapter 14</source>             <fpage>375</fpage>             <lpage>406</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Satija1"><label>92</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Satija</surname><given-names>R</given-names></name>
<name name-style="western"><surname>Pachter</surname><given-names>L</given-names></name>
<name name-style="western"><surname>Hein</surname><given-names>J</given-names></name>
</person-group>             <year>2008</year>             <article-title>Combining statistical alignment and phylogenetic footprinting to detect regulatory elements.</article-title>             <source>Bioinformatics</source>             <volume>24</volume>             <fpage>1236</fpage>             <lpage>1242</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Kim1"><label>93</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Kim</surname><given-names>J</given-names></name>
<name name-style="western"><surname>Sinha</surname><given-names>S</given-names></name>
</person-group>             <year>2007</year>             <article-title>Indelign: a probabilistic framework for annotation of insertions and deletions in a multiple alignment.</article-title>             <source>Bioinformatics</source>             <volume>23</volume>             <fpage>289</fpage>             <lpage>297</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Diallo1"><label>94</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Diallo</surname><given-names>AB</given-names></name>
<name name-style="western"><surname>Makarenkov</surname><given-names>V</given-names></name>
<name name-style="western"><surname>Blanchette</surname><given-names>M</given-names></name>
</person-group>             <year>2007</year>             <article-title>Exact and heuristic algorithms for the indel maximum likelihood problem.</article-title>             <source>Journal of Computational Biology</source>             <volume>14</volume>             <fpage>446</fpage>             <lpage>461</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Ma1"><label>95</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Ma</surname><given-names>J</given-names></name>
<name name-style="western"><surname>Zhang</surname><given-names>L</given-names></name>
<name name-style="western"><surname>Suh</surname><given-names>BB</given-names></name>
<name name-style="western"><surname>Raney</surname><given-names>BJ</given-names></name>
<name name-style="western"><surname>Brian</surname><given-names>J</given-names></name>
<etal/></person-group>             <year>2006</year>             <article-title>Reconstructing contiguous regions of an ancestral genome.</article-title>             <source>Genome Research</source>             <volume>16</volume>             <fpage>1557</fpage>             <lpage>1565</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Mohri1"><label>96</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Mohri</surname><given-names>M</given-names></name>
<name name-style="western"><surname>Pereira</surname><given-names>F</given-names></name>
<name name-style="western"><surname>Riley</surname><given-names>M</given-names></name>
</person-group>             <year>2002</year>             <article-title>Weighted finite-state transducers in speech recognition.</article-title>             <source>Computer Speech and Language</source>             <volume>16</volume>             <fpage>69</fpage>             <lpage>88</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Rounds1"><label>97</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Rounds</surname><given-names>WC</given-names></name>
</person-group>             <year>1970</year>             <article-title>Mappings and grammars on trees.</article-title>             <source>Mathematical Systems Theory</source>             <volume>4</volume>             <fpage>257</fpage>             <lpage>287</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Thatcher1"><label>98</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Thatcher</surname><given-names>JW</given-names></name>
</person-group>             <year>1970</year>             <article-title>Generalized sequential machine maps.</article-title>             <source>Journal of Computer and System Sciences</source>             <volume>4</volume>             <fpage>339</fpage>             <lpage>367</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Sakakibara1"><label>99</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Sakakibara</surname><given-names>Y</given-names></name>
<name name-style="western"><surname>Brown</surname><given-names>M</given-names></name>
<name name-style="western"><surname>Hughey</surname><given-names>R</given-names></name>
<name name-style="western"><surname>Mian</surname><given-names>IS</given-names></name>
<name name-style="western"><surname>Sjölander</surname><given-names>K</given-names></name>
<etal/></person-group>             <year>1994</year>             <article-title>Stochastic context-free grammars for tRNA modeling.</article-title>             <source>Nucleic Acids Research</source>             <volume>22</volume>             <fpage>5112</fpage>             <lpage>5120</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Sakakibara2"><label>100</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Sakakibara</surname><given-names>Y</given-names></name>
</person-group>             <year>2003</year>             <article-title>Pair hidden Markov models on tree structures.</article-title>             <source>Bioinformatics</source>             <volume>19</volume>             <supplement>Suppl 1</supplement>             <fpage>i232</fpage>             <lpage>240</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Meyer1"><label>101</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Meyer</surname><given-names>IM</given-names></name>
<name name-style="western"><surname>Miklós</surname><given-names>I</given-names></name>
</person-group>             <year>2007</year>             <article-title>SimulFold: simultaneously inferring rna structures including pseudoknots, alignments, and trees using a Bayesian MCMC framework.</article-title>             <source>PLoS Computational Biology</source>             <volume>3</volume>             <fpage>e149</fpage>          </element-citation></ref>
<ref id="pcbi.1000483-Lee2"><label>102</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Lee</surname><given-names>C</given-names></name>
<name name-style="western"><surname>Grasso</surname><given-names>C</given-names></name>
<name name-style="western"><surname>Sharlow</surname><given-names>M</given-names></name>
</person-group>             <year>2002</year>             <article-title>Multiple sequence alignment using partial order graphs.</article-title>             <source>Bioinformatics</source>             <volume>18</volume>             <fpage>452</fpage>             <lpage>464</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Thompson1"><label>103</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Thompson</surname><given-names>JD</given-names></name>
<name name-style="western"><surname>Plewniak</surname><given-names>F</given-names></name>
<name name-style="western"><surname>Poch</surname><given-names>O</given-names></name>
</person-group>             <year>1999</year>             <article-title>A comprehensive comparison of multiple sequence alignment programs.</article-title>             <source>Nucleic Acids Research</source>             <volume>27</volume>             <fpage>2682</fpage>             <lpage>2690</lpage>          </element-citation></ref>
<ref id="pcbi.1000483-Teunissen1"><label>104</label><element-citation publication-type="journal" xlink:type="simple">             <person-group person-group-type="author">
<name name-style="western"><surname>Teunissen</surname><given-names>S</given-names></name>
<name name-style="western"><surname>Kruithof</surname><given-names>M</given-names></name>
<name name-style="western"><surname>Farris</surname><given-names>A</given-names></name>
<name name-style="western"><surname>Harley</surname><given-names>J</given-names></name>
<name name-style="western"><surname>Venrooij</surname><given-names>W</given-names></name>
<etal/></person-group>             <year>2000</year>             <article-title>Conserved features of Y RNAs: a comparison of experimentally derived secondary structures.</article-title>             <source>Nucleic Acids Research</source>             <volume>28</volume>             <fpage>610</fpage>             <lpage>619</lpage>          </element-citation></ref>
</ref-list>

</back>
</article>