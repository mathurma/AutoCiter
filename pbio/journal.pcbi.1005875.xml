<!DOCTYPE article PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Publishing DTD v1.1d3 20150301//EN" "http://jats.nlm.nih.gov/publishing/1.1d3/JATS-journalpublishing1.dtd">
<article xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink" article-type="research-article" dtd-version="1.1d3" xml:lang="en">
<front>
<journal-meta>
<journal-id journal-id-type="nlm-ta">PLoS Comput Biol</journal-id>
<journal-id journal-id-type="publisher-id">plos</journal-id>
<journal-id journal-id-type="pmc">ploscomp</journal-id>
<journal-title-group>
<journal-title>PLOS Computational Biology</journal-title>
</journal-title-group>
<issn pub-type="ppub">1553-734X</issn>
<issn pub-type="epub">1553-7358</issn>
<publisher>
<publisher-name>Public Library of Science</publisher-name>
<publisher-loc>San Francisco, CA USA</publisher-loc>
</publisher>
</journal-meta>
<article-meta>
<article-id pub-id-type="doi">10.1371/journal.pcbi.1005875</article-id>
<article-id pub-id-type="publisher-id">PCOMPBIOL-D-17-00496</article-id>
<article-categories>
<subj-group subj-group-type="heading">
<subject>Research Article</subject>
</subj-group>
<subj-group subj-group-type="Discipline-v3"><subject>Biology and life sciences</subject><subj-group><subject>Cell biology</subject><subj-group><subject>Cytometry</subject></subj-group></subj-group></subj-group><subj-group subj-group-type="Discipline-v3"><subject>Physical sciences</subject><subj-group><subject>Mathematics</subject><subj-group><subject>Probability theory</subject><subj-group><subject>Random variables</subject><subj-group><subject>Covariance</subject></subj-group></subj-group></subj-group></subj-group></subj-group><subj-group subj-group-type="Discipline-v3"><subject>Research and analysis methods</subject><subj-group><subject>Simulation and modeling</subject></subj-group></subj-group><subj-group subj-group-type="Discipline-v3"><subject>Research and analysis methods</subject><subj-group><subject>Computational techniques</subject><subj-group><subject>Split-decomposition method</subject><subj-group><subject>Multiple alignment calculation</subject></subj-group></subj-group></subj-group></subj-group><subj-group subj-group-type="Discipline-v3"><subject>Biology and life sciences</subject><subj-group><subject>Cell biology</subject><subj-group><subject>Cellular types</subject><subj-group><subject>Animal cells</subject><subj-group><subject>Bone marrow cells</subject></subj-group></subj-group></subj-group></subj-group></subj-group><subj-group subj-group-type="Discipline-v3"><subject>Computer and information sciences</subject><subj-group><subject>Data visualization</subject></subj-group></subj-group><subj-group subj-group-type="Discipline-v3"><subject>Research and analysis methods</subject><subj-group><subject>Spectrum analysis techniques</subject><subj-group><subject>Spectrophotometry</subject><subj-group><subject>Cytophotometry</subject><subj-group><subject>Flow cytometry</subject></subj-group></subj-group></subj-group></subj-group></subj-group><subj-group subj-group-type="Discipline-v3"><subject>Biology and life sciences</subject><subj-group><subject>Anatomy</subject><subj-group><subject>Lymphatic system</subject><subj-group><subject>Lymph nodes</subject></subj-group></subj-group></subj-group></subj-group><subj-group subj-group-type="Discipline-v3"><subject>Medicine and health sciences</subject><subj-group><subject>Anatomy</subject><subj-group><subject>Lymphatic system</subject><subj-group><subject>Lymph nodes</subject></subj-group></subj-group></subj-group></subj-group></article-categories>
<title-group>
<article-title>Scalable multi-sample single-cell data analysis by Partition-Assisted Clustering and Multiple Alignments of Networks</article-title>
<alt-title alt-title-type="running-head">Scalable multi-sample analysis of single-cell data</alt-title>
</title-group>
<contrib-group>
<contrib contrib-type="author" equal-contrib="yes" xlink:type="simple">
<contrib-id authenticated="true" contrib-id-type="orcid">http://orcid.org/0000-0001-9611-5707</contrib-id>
<name name-style="western">
<surname>Li</surname>
<given-names>Ye Henry</given-names>
</name>
<role content-type="http://credit.casrai.org/">Conceptualization</role>
<role content-type="http://credit.casrai.org/">Data curation</role>
<role content-type="http://credit.casrai.org/">Formal analysis</role>
<role content-type="http://credit.casrai.org/">Investigation</role>
<role content-type="http://credit.casrai.org/">Methodology</role>
<role content-type="http://credit.casrai.org/">Project administration</role>
<role content-type="http://credit.casrai.org/">Resources</role>
<role content-type="http://credit.casrai.org/">Software</role>
<role content-type="http://credit.casrai.org/">Supervision</role>
<role content-type="http://credit.casrai.org/">Validation</role>
<role content-type="http://credit.casrai.org/">Visualization</role>
<role content-type="http://credit.casrai.org/">Writing – original draft</role>
<role content-type="http://credit.casrai.org/">Writing – review &amp; editing</role>
<xref ref-type="aff" rid="aff001"><sup>1</sup></xref>
</contrib>
<contrib contrib-type="author" equal-contrib="yes" xlink:type="simple">
<name name-style="western">
<surname>Li</surname>
<given-names>Dangna</given-names>
</name>
<role content-type="http://credit.casrai.org/">Conceptualization</role>
<role content-type="http://credit.casrai.org/">Data curation</role>
<role content-type="http://credit.casrai.org/">Formal analysis</role>
<role content-type="http://credit.casrai.org/">Investigation</role>
<role content-type="http://credit.casrai.org/">Methodology</role>
<role content-type="http://credit.casrai.org/">Resources</role>
<role content-type="http://credit.casrai.org/">Software</role>
<role content-type="http://credit.casrai.org/">Validation</role>
<role content-type="http://credit.casrai.org/">Visualization</role>
<role content-type="http://credit.casrai.org/">Writing – original draft</role>
<role content-type="http://credit.casrai.org/">Writing – review &amp; editing</role>
<xref ref-type="aff" rid="aff002"><sup>2</sup></xref>
</contrib>
<contrib contrib-type="author" xlink:type="simple">
<name name-style="western">
<surname>Samusik</surname>
<given-names>Nikolay</given-names>
</name>
<role content-type="http://credit.casrai.org/">Data curation</role>
<role content-type="http://credit.casrai.org/">Formal analysis</role>
<role content-type="http://credit.casrai.org/">Investigation</role>
<role content-type="http://credit.casrai.org/">Resources</role>
<role content-type="http://credit.casrai.org/">Validation</role>
<xref ref-type="aff" rid="aff003"><sup>3</sup></xref>
</contrib>
<contrib contrib-type="author" xlink:type="simple">
<name name-style="western">
<surname>Wang</surname>
<given-names>Xiaowei</given-names>
</name>
<role content-type="http://credit.casrai.org/">Conceptualization</role>
<role content-type="http://credit.casrai.org/">Data curation</role>
<role content-type="http://credit.casrai.org/">Formal analysis</role>
<role content-type="http://credit.casrai.org/">Investigation</role>
<role content-type="http://credit.casrai.org/">Writing – original draft</role>
<xref ref-type="aff" rid="aff004"><sup>4</sup></xref>
</contrib>
<contrib contrib-type="author" xlink:type="simple">
<name name-style="western">
<surname>Guan</surname>
<given-names>Leying</given-names>
</name>
<role content-type="http://credit.casrai.org/">Conceptualization</role>
<role content-type="http://credit.casrai.org/">Investigation</role>
<xref ref-type="aff" rid="aff004"><sup>4</sup></xref>
</contrib>
<contrib contrib-type="author" xlink:type="simple">
<name name-style="western">
<surname>Nolan</surname>
<given-names>Garry P.</given-names>
</name>
<role content-type="http://credit.casrai.org/">Project administration</role>
<role content-type="http://credit.casrai.org/">Supervision</role>
<xref ref-type="aff" rid="aff003"><sup>3</sup></xref>
</contrib>
<contrib contrib-type="author" corresp="yes" xlink:type="simple">
<contrib-id authenticated="true" contrib-id-type="orcid">http://orcid.org/0000-0001-7466-2339</contrib-id>
<name name-style="western">
<surname>Wong</surname>
<given-names>Wing Hung</given-names>
</name>
<role content-type="http://credit.casrai.org/">Conceptualization</role>
<role content-type="http://credit.casrai.org/">Funding acquisition</role>
<role content-type="http://credit.casrai.org/">Investigation</role>
<role content-type="http://credit.casrai.org/">Methodology</role>
<role content-type="http://credit.casrai.org/">Project administration</role>
<role content-type="http://credit.casrai.org/">Supervision</role>
<role content-type="http://credit.casrai.org/">Writing – original draft</role>
<role content-type="http://credit.casrai.org/">Writing – review &amp; editing</role>
<xref ref-type="aff" rid="aff004"><sup>4</sup></xref>
<xref ref-type="aff" rid="aff005"><sup>5</sup></xref>
<xref ref-type="corresp" rid="cor001">*</xref>
</contrib>
</contrib-group>
<aff id="aff001"><label>1</label> <addr-line>Structural Biology Department and Public Policy Program, Stanford University, Stanford, United States of America</addr-line></aff>
<aff id="aff002"><label>2</label> <addr-line>Institute for Computational and Mathematical Engineering, Stanford University, Stanford, United States of America</addr-line></aff>
<aff id="aff003"><label>3</label> <addr-line>Department of Microbiology and Immunology, Baxter Laboratory, Stanford University, Stanford, United States of America</addr-line></aff>
<aff id="aff004"><label>4</label> <addr-line>Statistics Department, Stanford University, Stanford, United States of America</addr-line></aff>
<aff id="aff005"><label>5</label> <addr-line>Department of Biomedical Data Science, Stanford University, Stanford, United States of America</addr-line></aff>
<contrib-group>
<contrib contrib-type="editor" xlink:type="simple">
<name name-style="western">
<surname>Markowetz</surname>
<given-names>Florian</given-names>
</name>
<role>Editor</role>
<xref ref-type="aff" rid="edit1"/>
</contrib>
</contrib-group>
<aff id="edit1"><addr-line>University of Cambridge, UNITED KINGDOM</addr-line></aff>
<author-notes>
<fn fn-type="conflict" id="coi001">
<p>The authors have declared that no competing interests exist.</p>
</fn>
<corresp id="cor001">* E-mail: <email xlink:type="simple">whwong@stanford.edu</email></corresp>
</author-notes>
<pub-date pub-type="epub">
<day>27</day>
<month>12</month>
<year>2017</year>
</pub-date>
<pub-date pub-type="collection">
<month>12</month>
<year>2017</year>
</pub-date>
<volume>13</volume>
<issue>12</issue>
<elocation-id>e1005875</elocation-id>
<history>
<date date-type="received">
<day>28</day>
<month>3</month>
<year>2017</year>
</date>
<date date-type="accepted">
<day>6</day>
<month>11</month>
<year>2017</year>
</date>
</history>
<permissions>
<copyright-year>2017</copyright-year>
<copyright-holder>Li et al</copyright-holder>
<license xlink:href="http://creativecommons.org/licenses/by/4.0/" xlink:type="simple">
<license-p>This is an open access article distributed under the terms of the <ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/" xlink:type="simple">Creative Commons Attribution License</ext-link>, which permits unrestricted use, distribution, and reproduction in any medium, provided the original author and source are credited.</license-p>
</license>
</permissions>
<self-uri content-type="pdf" xlink:href="info:doi/10.1371/journal.pcbi.1005875"/>
<abstract>
<p>Mass cytometry (CyTOF) has greatly expanded the capability of cytometry. It is now easy to generate multiple CyTOF samples in a single study, with each sample containing single-cell measurement on 50 markers for more than hundreds of thousands of cells. Current methods do not adequately address the issues concerning combining multiple samples for subpopulation discovery, and these issues can be quickly and dramatically amplified with increasing number of samples. To overcome this limitation, we developed Partition-Assisted Clustering and Multiple Alignments of Networks (PAC-MAN) for the fast automatic identification of cell populations in CyTOF data closely matching that of expert manual-discovery, and for alignments between subpopulations across samples to define dataset-level cellular states. PAC-MAN is computationally efficient, allowing the management of very large CyTOF datasets, which are increasingly common in clinical studies and cancer studies that monitor various tissue samples for each subject.</p>
</abstract>
<abstract abstract-type="summary">
<title>Author summary</title>
<p>Recently, the cytometry field has experienced rapid advancement in the development of mass cytometry (CyTOF). CyTOF enables a significant increase in the ability to monitor 50 or more cellular markers for millions of cells at the single-cell level. Initial studies with CyTOF focused on few samples, in which expert manual discovery of cell types were acceptable. As the technology matures, it is now feasible to collect more samples, which enables systematic studies of cell types across multiple samples. However, the statistical and computational issues surrounding multi-sample analysis have not been previously examined in detail. Furthermore, it was not clear how the data analysis could be scaled for hundreds of samples, such as those in clinical studies. In this work, we present a scalable analysis pipeline that is grounded in strong statistical foundation. Partition-Assisted Clustering (PAC) offers fast and accurate clustering and Multiple Alignments of Networks (MAN) utilizes network structures learned from each homogeneous cluster to organize the data into data-set level clusters. PAC-MAN thus enables the analysis of a large CyTOF dataset that was previously too large to be analyzed systematically; this pipeline can be extended to the analysis of similarly large or larger datasets.</p>
</abstract>
<funding-group>
<award-group id="award001">
<funding-source>
<institution-wrap>
<institution-id institution-id-type="funder-id">http://dx.doi.org/10.13039/100000002</institution-id>
<institution>National Institutes of Health</institution>
</institution-wrap>
</funding-source>
<award-id>R01GM109836</award-id>
<principal-award-recipient>
<contrib-id authenticated="true" contrib-id-type="orcid">http://orcid.org/0000-0001-7466-2339</contrib-id>
<name name-style="western">
<surname>Wong</surname>
<given-names>Wing Hung</given-names>
</name>
</principal-award-recipient>
</award-group>
<award-group id="award002">
<funding-source>
<institution-wrap>
<institution-id institution-id-type="funder-id">http://dx.doi.org/10.13039/100000001</institution-id>
<institution>National Science Foundation</institution>
</institution-wrap>
</funding-source>
<award-id>DMS1330132</award-id>
<principal-award-recipient>
<contrib-id authenticated="true" contrib-id-type="orcid">http://orcid.org/0000-0001-7466-2339</contrib-id>
<name name-style="western">
<surname>Wong</surname>
<given-names>Wing Hung</given-names>
</name>
</principal-award-recipient>
</award-group>
<award-group id="award003">
<funding-source>
<institution-wrap>
<institution-id institution-id-type="funder-id">http://dx.doi.org/10.13039/100000001</institution-id>
<institution>National Science Foundation</institution>
</institution-wrap>
</funding-source>
<award-id>DMS1407557</award-id>
<principal-award-recipient>
<contrib-id authenticated="true" contrib-id-type="orcid">http://orcid.org/0000-0001-7466-2339</contrib-id>
<name name-style="western">
<surname>Wong</surname>
<given-names>Wing Hung</given-names>
</name>
</principal-award-recipient>
</award-group>
<funding-statement>This research was supported by the Stanford SIGF-BioX fellowship (<ext-link ext-link-type="uri" xlink:href="https://biox.stanford.edu/" xlink:type="simple">https://biox.stanford.edu/</ext-link>) and the NIH T32 GM007276 training grant to YHL and the NIH R01GM109836, NSF-DMS1330132, and NSF-DMS1407557 grants to WHW. The funders had no role in study design, data collection and analysis, decision to publish, or preparation of the manuscript.</funding-statement>
</funding-group>
<counts>
<fig-count count="18"/>
<table-count count="1"/>
<page-count count="37"/>
</counts>
<custom-meta-group>
<custom-meta>
<meta-name>PLOS Publication Stage</meta-name>
<meta-value>vor-update-to-uncorrected-proof</meta-value>
</custom-meta>
<custom-meta>
<meta-name>Publication Update</meta-name>
<meta-value>2018-01-09</meta-value>
</custom-meta>
<custom-meta id="data-availability">
<meta-name>Data Availability</meta-name>
<meta-value>The datasets generated in our study are publicly available on <ext-link ext-link-type="uri" xlink:href="https://community.cytobank.org" xlink:type="simple">https://community.cytobank.org</ext-link> under PAC-MAN Dataset.</meta-value>
</custom-meta>
</custom-meta-group>
</article-meta>
</front>
<body>
<sec id="sec001" sec-type="intro">
<title>Introduction</title>
<p>Analyses of CyTOF data rely on many of the tools and ideas from flow cytometry (FC) data analysis, as CyTOF datasets are essentially higher dimensional versions of flow cytometry datasets. Currently, the most widely used method in FC is still human hand-gating, as other methods often fail to extract meaningful subpopulations of cells automatically. In hand-gating, we draw polygons or other enclosures around pockets of cell events on a two-dimensional scatterplot to define subpopulations and cellular states that are observed in the data. This process is painfully time-consuming and requires advance knowledge of the marker panel design, the quality of the staining reagents, and, most importantly, <italic>a priori</italic> what cell subpopulations to expect to occur in the data. When presented with a new set of marker panels and biological system, the researcher would find it difficult to delineate the cell events, especially in high-dimensional and multi-sample datasets.</p>
<p>The inefficient nature of hand-gating in flow cytometry motivated algorithmic development in automatic gating. Perhaps the most popular is flowMeans[<xref ref-type="bibr" rid="pcbi.1005875.ref001">1</xref>], which is optimized for FC and can learn subpopulations in FC data[<xref ref-type="bibr" rid="pcbi.1005875.ref002">2</xref>] in an automated manner; however, it has not been successfully applied to CyTOF data analysis. Currently, most data analysis tools created for flow cytometry data analyses are not easily applicable for high-dimensional datasets[<xref ref-type="bibr" rid="pcbi.1005875.ref003">3</xref>]. An exception is SPADE, which was developed and optimized specifically for the analysis of CyTOF datasets[<xref ref-type="bibr" rid="pcbi.1005875.ref003">3</xref>]. flowMeans and SPADE constitute the leading computational methods in cytometry, but as shown later in this work, their performance may become sub-optimal when challenged with large and high-dimensional datasets. There are also other recent clustering-based tools that utilize dimensionality reduction and projections of high-dimensional data, however, these tools do not directly learn the subpopulations for all the cell events, and may be too slow to complete data analysis for an increasing amount of samples.</p>
<p>In this study, we address the data analysis challenges in two major steps. First, we propose the partition-assisted clustering (PAC) approach, which produces a partition of the k-dimensional space (k = number of markers) that captures the essential characteristic of the data distribution. This partitioning methodology is grounded in a strong mathematical framework of partition-based high-dimensional density estimation[<xref ref-type="bibr" rid="pcbi.1005875.ref004">4</xref>–<xref ref-type="bibr" rid="pcbi.1005875.ref007">7</xref>]. The mathematical framework offers the guarantee that these partitions approximate the underlying empirical data distribution; this step is faster than the recent k-nearest neighbor-based method [<xref ref-type="bibr" rid="pcbi.1005875.ref008">8</xref>] and is essential to the scalability of our clustering approach to analyze datasets with many samples. The clustering of cells based on recursive partitioning is then refined by a small number of k-means style iterations before a merging step to produce the final clustering.</p>
<p>Secondly, the subpopulations learned separately in multiple different but related datasets can be aligned by marker network structures (multiple alignments of networks, or MAN), making it possible to characterize the relationships of subpopulations across different samples automatically. The ability to do so is critical for monitoring changes in a subpopulation across different conditions. Importantly, in every study, batch effect is present; batch effects shift subpopulation signals so that the means can be different from experiment to experiment. PAC-MAN naturally addresses batch effects in finding the alignments of the same or closely related subpopulations from different samples.</p>
<p>PAC-MAN finds homogeneous clusters efficiently with all data points in a scalable fashion and enables the matching of these clusters across different samples to discover cluster relationships in the form of clades.</p>
</sec>
<sec id="sec002" sec-type="conclusions">
<title>Results/Discussion</title>
<sec id="sec003">
<title>PAC</title>
<p>PAC has two parts: partitioning and post-processing. In the partitioning part of PAC, the data space is recursively divided into smaller hyper-rectangles based on the number of data points in the locality (<xref ref-type="fig" rid="pcbi.1005875.g001">Fig 1A</xref>). The partitioning is accomplished by either Bayesian Sequential Partition (BSP) with limited look-ahead (<xref ref-type="fig" rid="pcbi.1005875.g001">Fig 1A and 1B</xref>) or Discrepancy Sequential Partition (DSP) (<xref ref-type="fig" rid="pcbi.1005875.g001">Fig 1A</xref>); these are two fast variants of partition-based density estimation methods previously developed by our group [<xref ref-type="bibr" rid="pcbi.1005875.ref004">4</xref>–<xref ref-type="bibr" rid="pcbi.1005875.ref007">7</xref>], with DSP being the fastest. BSP and DSP divide the sample space into hyper-rectangles with uniform density value in each of them. The subsetting of cells according to the partitioning provides a principled way of clustering the cells that reflects the characteristics of the underlying distribution. In particular, each significant mode is captured by a number of closely located rectangles with high-density values (<xref ref-type="fig" rid="pcbi.1005875.g001">Fig 1C</xref>). Although this method allows a fast and unbiased localization of the high-density regions of the data space, we should not use the hyper-rectangles directly to define the final cluster boundaries for two reasons. First, real clusters are likely to be shaped elliptically, therefore, the data points in the corners of a hyper-rectangle are likely to be incorrectly clustered. Second, a real cluster is often split into more than one closely located high-density rectangles. We designed post-processing steps to overcome these limitations: 1) a small number of k-means iterations is used to round out the corners of the hyper-rectangles, 2) a merging process is implemented to ameliorate the splitting problem, which is inspired by the flowMeans algorithm. The details of post-processing are given in the Materials and Methods. The resulting method is named b-PAC or d-PAC depending on whether the partition is produced by BSP or DSP.</p>
<fig id="pcbi.1005875.g001" position="float">
<object-id pub-id-type="doi">10.1371/journal.pcbi.1005875.g001</object-id>
<label>Fig 1</label>
<caption>
<title>PAC recursively partitions the data space to obtain rational initialization structure.</title>
<p>Partition-based methods estimate data density by cutting the data space into smaller rectangles recursively. Shown in parts a-b are three clusters of points, the data marginal densities, and several partition scenarios. The data space (box) is partitioned in sequential steps denoted by numbers on the cut lines. Only the first three partition cuts are shown in parts a and b. (a) Bayesian Sequential Partition (BSP) is a Bayesian procedure that maximizes the posterior of the density estimation by dividing the data space via binary partitions; these partitions occur in the middle of the bounded region. On the other hand, Discrepancy Sequential Partition (DSP) performs division other than the mid-point; here, the division is guided by the discrepancy score through a series of tests of uniformity in point distribution, and the procedure stops when discrepancies are smaller than a set threshold. (b) In the (one-step) look-ahead version of BSP partition, the algorithm cuts the data space for all potential cuts plus one step more (steps 2 and 3), and it finds the optimal future scenario (after step 3). In comparison to the (sub-optimal) BSP scenario (one of many scenarios) illustrated in part (a), the scenario in (b) segregates the gold cluster much better, and it is a preferred cut to make in the continuation of partitioning procedure. In theory, BSP can produce sequential partitions for a pre-set number of steps ahead; however, to maintain computational feasibility, we implemented the one-step look-ahead BSP for this work. (c) The partitioning of simulated data space containing five subpopulations; the hyper-rectangles surround high-density areas, approximating the underlying distribution.</p>
</caption>
<graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.g001" xlink:type="simple"/>
</fig>
</sec>
<sec id="sec004">
<title>MAN</title>
<p>An approach to analyze multiple related samples of CyTOF data is to pool all samples into a combined sample before detection of subpopulations. This is a natural approach under the assumptions that there are no significant batch effects or systematic shifts in cell subpopulations across the different samples. However, such assumptions may not hold due to one or more of the following reasons:</p>
<list list-type="order">
<list-item><p><bold>Dataset size and instruments used.</bold> Large number of samples usually means the samples were collected on different days with different experimental preparations. Many steps can introduce significant shifts in measurement levels.</p></list-item>
<list-item><p><bold>Staining reagents.</bold> Reagents such as antibodies, purchased from different vendors and batch preparations can affect the overall signal. While saturation of reagents in the protocol could help eliminate the batch effects in the staining procedure, this approach is costly and might not work for all antibodies, especially those with poor specificity.</p></list-item>
<list-item><p><bold>Normalization beads stock.</bold> While normalization beads[<xref ref-type="bibr" rid="pcbi.1005875.ref009">9</xref>] help to control for the signal level, especially within one experiment, the age of the beads stock and their preparation could lead to significant batch effects. In addition, there are different types of normalization beads and normalization calculations.</p></list-item>
<list-item><p><bold>Human work variation.</bold> While many researchers are studying the same system (e.g., immune system), different protocols and implementation by different researchers, who sometimes perform experimental steps slightly differently, can lead to batch effects.</p></list-item>
<list-item><p><bold>Subpopulation dynamics.</bold> The subpopulation centers can move from sample to sample due to treatments on the cells in treatment-control studies or perturbation studies. General practice is to cluster by phenotypic markers.</p></list-item>
<list-item><p><bold>Sample background.</bold> If the data came from different cell lines or individuals in a clinical study, the measurement levels and proportions of cell subpopulations would be expected to change from sample to sample. Without expert scrutiny, it would be difficult to make sense of the data with current data analysis tools.</p></list-item>
</list>
<p>Could we extract shared information that allows us to interpret cross-sample similarities and differences? We note that efforts were made to analyze cross-sample relationships in a previous publication [<xref ref-type="bibr" rid="pcbi.1005875.ref010">10</xref>], in which the data was carefully collected with barcode reagents in uniform staining, which enable pooling of the data for downstream analysis. Experimentally, it would be difficult to up-scale the barcoding and uniform staining control to a larger number of samples. Furthermore, previous efforts were dependent on down-sampling of the data points, which would significantly affect the clustering results. While it is possible, through careful experimental design and cross-sample controls, to establish uniform staining for a small pooled sample data analysis, there is a need to resolve the above batch effect difficulties for studies that require scalability, such as in the clinical setting in which hundreds of patient blood samples are collected at different times.</p>
<p>To ameliorate the difficulties of potential high-dimensional cluster shifts and scalability, we have designed an alternative approach that is effective in the presence of substantial systematic between-sample variation. In this approach, each sample is analyzed separately (by PAC) to discover within-sample subpopulations. As an exploration step, we over-partition to capture both large and small subpopulations in high-dimension. The subpopulations from all samples are then compared to each other based on a pairwise dissimilarity measure designed to capture the differences in within-sample distributions (among the markers) across two subpopulations. Using this dissimilarity, we perform bottom-up hierarchical clustering of the subpopulations to represent the relationship among the subpopulations. The resulting tree of subpopulations is then used to guide the merging of subpopulations from the same sample, and to establish linkage of related subpopulations from different samples. We note that the design of a dissimilarity measure (Materials and Methods) that is not sensitive to systematic sample-to-sample variation is a novel aspect of our approach. The merging of subpopulations from the same sample is also important, as it offers a way to consolidate any over-partitioning that may have occurred during the initial PAC analysis of each sample. We emphasize that, as with the usage of all statistical methods, the user must utilize samples or datasets that are considered as good as possible and that the sample comparisons make biological sense; interpretation of the analysis results rely on the researchers to collect data with validated reagents for all samples. In general, sensible data would come from 1) samples that are carefully prepared to not include contamination of cells from other tissues, 2) cytometry panel with validated markers that enable the observation of known, coherent cell subpopulations in the tissue samples (important for determining the number of PAC clusters to explore in the partition step to control for aggressive over-partitioning), 3) successful execution of standard cytometry experiment protocol, and 4) collection of data to achieve enough cell events (important for building stable network structures). These steps would ensure the reproducibility of PAC-MAN data analysis. In addition, any novel subpopulation discovery or difference between samples observed should be validated with downstream experiments (perhaps using low-dimensional flow cytometry and sorting methods).</p>
</sec>
<sec id="sec005">
<title>Rational initialization for PAC increases clustering effectiveness</title>
<p>Appropriate initialization of clustering is very important for eventually finding the optimal clustering labels; PAC works well because the implicit density estimation procedure yields rational centers to learn the modes of sample subpopulations. When tested on the hand-gated CyTOF data on the bone marrow sample in [<xref ref-type="bibr" rid="pcbi.1005875.ref011">11</xref>], compared to kmeans alone, PAC gives lower total sums of squares and higher F-measures in the subpopulations (<xref ref-type="fig" rid="pcbi.1005875.g002">Fig 2A and 2B</xref>). In the comparison to kmeans, we utilized random kmeans initialization by Lloyd (and Forgy), which uses random initialization, and also kmeans++ initialization, which uses a more advanced initialization [<xref ref-type="bibr" rid="pcbi.1005875.ref012">12</xref>,<xref ref-type="bibr" rid="pcbi.1005875.ref013">13</xref>]. The process of rational initialization also helps PAC to converge in 50 iterations (<xref ref-type="fig" rid="pcbi.1005875.g003">Fig 3</xref>) in post-processing, whereas k-means performs very poorly even after 5000 iterations (<xref ref-type="fig" rid="pcbi.1005875.g004">Fig 4</xref>). Through the lens of t-SNE plots (<xref ref-type="fig" rid="pcbi.1005875.g004">Fig 4</xref>), the PAC results are more similar to the hand-gating results, while the k-means, flowMeans, and SPADE clustering results perform poorly. In flowMeans, several large subpopulations are merged. SPADE’s separation of points is inconsistent and highly heterogeneous, probably due to its down-sampling nature. On the other hand, by inspection, PAC obtains similar separation for both the major and minor subpopulations as the hand-gating results.</p>
<fig id="pcbi.1005875.g002" position="float">
<object-id pub-id-type="doi">10.1371/journal.pcbi.1005875.g002</object-id>
<label>Fig 2</label>
<caption>
<title>Rational initialization is better than random initialization.</title>
<p>The hand-gated CyTOF data (see <xref ref-type="supplementary-material" rid="pcbi.1005875.s001">S1 Fig</xref>) is used for illustration. Commonly, kmeans algorithms utilize initialization via the Lloyd’s algorithm or kmeans++ algorithm. In comparison, (a) the overall sum of squares error is lower and (b) the F-measure is higher for DSP with kmeans versus the classic kmeans initialization algorithms. The rational initialization helps anchor the cluster starting points, and become very important for the fast convergence of PAC (<xref ref-type="fig" rid="pcbi.1005875.g003">Fig 3</xref>).</p>
</caption>
<graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.g002" xlink:type="simple"/>
</fig>
<fig id="pcbi.1005875.g003" position="float">
<object-id pub-id-type="doi">10.1371/journal.pcbi.1005875.g003</object-id>
<label>Fig 3</label>
<caption>
<title>Rational initialization, minimal kmeans post-processing iterations, and merging give fast convergence.</title>
<p>We use the hand-gated CyTOF data for illustration. The data space is first partitioned into 50 hyperrectangles, which is about twice (recommended setting) the expected number of subpopulations (24). Next, the number of kmeans iterations was varied followed by flowMeans style merging. The convergence of PAC toward the hand-gated results, or ground truth, is fast due to the informative anchoring of cluster centers around high-density regions by the rational initialization. It takes less than 50 post-processing kmeans iterations for the PAC to achieve convergence. This efficiency allows the PAC method to scale to handle the clustering of large samples.</p>
</caption>
<graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.g003" xlink:type="simple"/>
</fig>
<fig id="pcbi.1005875.g004" position="float">
<object-id pub-id-type="doi">10.1371/journal.pcbi.1005875.g004</object-id>
<label>Fig 4</label>
<caption>
<title>t-SNE visualization of clustering methods.</title>
<p>We compare the clustering results between hand-gate, (Lloyd’s) kmeans, SPADE, flowMeans, bPAC, and dPAC labels. Each t-SNE plot contains all gated cell events from the hand-gated CyTOF data with different set of colored labels. The colored labels denote different subpopulations within each plot; however, the colors do not have cross-plot meaning. The subpopulation numbers for all methods were set to be the same as that of hand-gated results (24 subpopulations). PAC methods achieve a significantly better convergence to the hand-gate labels than alternative methods.</p>
</caption>
<graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.g004" xlink:type="simple"/>
</fig>
</sec>
<sec id="sec006">
<title>PAC is consistently better than flowMeans and SPADE for simulated datasets and hand-gated cytometry datasets</title>
<p>In the systematic simulation study, we challenged the methods with different datasets with varying number of dimensions, number of subpopulations, and separation between the subpopulations. The F-measure and p-measures for the PAC methods are consistently equal or higher than that of flowMeans and SPADE (<xref ref-type="table" rid="pcbi.1005875.t001">Table 1</xref> and <xref ref-type="supplementary-material" rid="pcbi.1005875.s002">S2A Fig</xref>). For some higher dimension cases in which the subpopulation separation is relatively small, SPADE failed to cluster. In addition, we observe that flowMeans gives inconsistent F-measures for similar datasets (<xref ref-type="table" rid="pcbi.1005875.t001">Table 1</xref>), which may be due to the convergence of k-means to a local minimum without a rational initialization.</p>
<table-wrap id="pcbi.1005875.t001" position="float">
<object-id pub-id-type="doi">10.1371/journal.pcbi.1005875.t001</object-id>
<label>Table 1</label> <caption><title>F-measure comparisons of methods on simulated and hand-gated cytometry datasets<xref ref-type="table-fn" rid="t001fn003">**</xref>.</title></caption>
<alternatives>
<graphic id="pcbi.1005875.t001g" mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.t001" xlink:type="simple"/>
<table>
<colgroup>
<col align="left" valign="middle"/>
<col align="left" valign="middle"/>
<col align="left" valign="middle"/>
<col align="left" valign="middle"/>
<col align="left" valign="middle"/>
</colgroup>
<thead>
<tr>
<th align="center" rowspan="2">Data</th>
<th align="center" colspan="4">Analysis Methods</th>
</tr>
<tr>
<th align="center">flowMeans</th>
<th align="center">SPADE</th>
<th align="center">d-PAC</th>
<th align="center">b-PAC</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><bold>5_10_40_100k</bold></td>
<td align="center">0.79</td>
<td align="center">0.64</td>
<td align="center">0.94</td>
<td align="center">0.94</td>
</tr>
<tr>
<td align="center"><bold>5_20_40_100k</bold></td>
<td align="center">0.9</td>
<td align="center">0.73</td>
<td align="center">0.94</td>
<td align="center">0.94</td>
</tr>
<tr>
<td align="center"><bold>10_5_30_100k</bold></td>
<td align="center">0.74</td>
<td align="center">0.93</td>
<td align="center">0.93</td>
<td align="center">0.97</td>
</tr>
<tr>
<td align="center"><bold>10_10_30_100k</bold></td>
<td align="center">0.97</td>
<td align="center">0.88</td>
<td align="center">0.98</td>
<td align="center">0.98</td>
</tr>
<tr>
<td align="center"><bold>10_10_40_100k</bold></td>
<td align="center">0.92</td>
<td align="center">0.95</td>
<td align="center">0.98</td>
<td align="center">0.98</td>
</tr>
<tr>
<td align="center"><bold>10_20_30_100k</bold></td>
<td align="center">0.88</td>
<td align="center">0.76</td>
<td align="center">0.9</td>
<td align="center">0.91</td>
</tr>
<tr>
<td align="center"><bold>10_20_40_100k</bold></td>
<td align="center">0.94</td>
<td align="center">0.93</td>
<td align="center">0.95</td>
<td align="center">0.95</td>
</tr>
<tr>
<td align="center"><bold>10_40_30_100k</bold></td>
<td align="center">0.42</td>
<td align="center">0.55</td>
<td align="center">0.7</td>
<td align="center">0.7</td>
</tr>
<tr>
<td align="center"><bold>20_5_20_100k</bold></td>
<td align="center">0.75</td>
<td align="center">0.71</td>
<td align="center">0.91</td>
<td align="center">0.9</td>
</tr>
<tr>
<td align="center"><bold>20_5_30_100k</bold></td>
<td align="center">0.76</td>
<td align="center">0.98</td>
<td align="center">0.99</td>
<td align="center">0.99</td>
</tr>
<tr>
<td align="center"><bold>20_5_40_100k</bold></td>
<td align="center">0.72</td>
<td align="center">0.85</td>
<td align="center">1.00</td>
<td align="center">1.00</td>
</tr>
<tr>
<td align="center"><bold>20_10_40_100k</bold></td>
<td align="center">0.25</td>
<td align="center">0.96</td>
<td align="center">0.97</td>
<td align="center">0.97</td>
</tr>
<tr>
<td align="center"><bold>20_20_40_100k</bold></td>
<td align="center">0.93</td>
<td align="center">0.91</td>
<td align="center">0.92</td>
<td align="center">0.93</td>
</tr>
<tr>
<td align="center"><bold>35_10_10_100k</bold></td>
<td align="center">0.77</td>
<td align="center">N/A</td>
<td align="center">0.82</td>
<td align="center">0.83</td>
</tr>
<tr>
<td align="center"><bold>35_10_10_200k</bold></td>
<td align="center">0.56</td>
<td align="center">N/A</td>
<td align="center">0.88</td>
<td align="center">0.88</td>
</tr>
<tr>
<td align="center"><bold>35_20_10_100k</bold></td>
<td align="center">0.60</td>
<td align="center">N/A</td>
<td align="center">0.70</td>
<td align="center">0.70</td>
</tr>
<tr>
<td align="center"><bold>35_20_10_200k</bold></td>
<td align="center">0.60</td>
<td align="center">N/A</td>
<td align="center">0.67</td>
<td align="center">0.72</td>
</tr>
<tr>
<td align="center"><bold>35_10_30_100k</bold></td>
<td align="center">1.00</td>
<td align="center">0.93</td>
<td align="center">1.00</td>
<td align="center">1.00</td>
</tr>
<tr>
<td align="center"><bold>35_20_30_100k</bold></td>
<td align="center">0.94</td>
<td align="center">N/A</td>
<td align="center">1.00</td>
<td align="center">1.00</td>
</tr>
<tr>
<td align="center"><bold>35_5_40_200k</bold></td>
<td align="center">0.96</td>
<td align="center">0.89</td>
<td align="center">0.99</td>
<td align="center">0.99</td>
</tr>
<tr>
<td align="center"><bold>35_10_20_200k</bold></td>
<td align="center">0.96</td>
<td align="center">0.93</td>
<td align="center">1.00</td>
<td align="center">1.00</td>
</tr>
<tr>
<td align="center"><bold>35_10_40_200k</bold></td>
<td align="center">0.93</td>
<td align="center">0.79</td>
<td align="center">0.96</td>
<td align="center">0.96</td>
</tr>
<tr>
<td align="center"><bold>40_10_10_100k</bold></td>
<td align="center">0.81</td>
<td align="center">N/A</td>
<td align="center">0.85</td>
<td align="center">0.87</td>
</tr>
<tr>
<td align="center"><bold>40_10_10_200k</bold></td>
<td align="center">0.73</td>
<td align="center">N/A</td>
<td align="center">0.90</td>
<td align="center">0.90</td>
</tr>
<tr>
<td align="center"><bold>40_20_10_100k</bold></td>
<td align="center">0.61</td>
<td align="center">N/A</td>
<td align="center">0.71</td>
<td align="center">0.69</td>
</tr>
<tr>
<td align="center"><bold>40_20_10_200k</bold></td>
<td align="center">0.60</td>
<td align="center">N/A</td>
<td align="center">0.69</td>
<td align="center">0.67</td>
</tr>
<tr>
<td align="center"><bold>40_10_20_100k</bold></td>
<td align="center">1.00</td>
<td align="center">0.90</td>
<td align="center">1.00</td>
<td align="center">1.00</td>
</tr>
<tr>
<td align="center"><bold>40_10_20_200k</bold></td>
<td align="center">1.00</td>
<td align="center">0.93</td>
<td align="center">1.00</td>
<td align="center">1.00</td>
</tr>
<tr>
<td align="center"><bold>40_10_25_100k</bold></td>
<td align="center">0.94</td>
<td align="center">0.94</td>
<td align="center">1.00</td>
<td align="center">1.00</td>
</tr>
<tr>
<td align="center"><bold>40_20_30_100k</bold></td>
<td align="center">0.95</td>
<td align="center">0.92</td>
<td align="center">1.00</td>
<td align="center">1.00</td>
</tr>
<tr>
<td align="center"><bold>40_10_25_200k</bold></td>
<td align="center">0.96</td>
<td align="center">0.94</td>
<td align="center">0.99</td>
<td align="center">0.99</td>
</tr>
<tr>
<td align="center"><bold>50_10_10_100k</bold></td>
<td align="center">0.78</td>
<td align="center">N/A</td>
<td align="center">0.88</td>
<td align="center">0.88</td>
</tr>
<tr>
<td align="center"><bold>50_10_10_200k</bold></td>
<td align="center">0.80</td>
<td align="center">N/A</td>
<td align="center">0.89</td>
<td align="center">0.88</td>
</tr>
<tr>
<td align="center"><bold>50_20_10_100k</bold></td>
<td align="center">0.63</td>
<td align="center">N/A</td>
<td align="center">0.73</td>
<td align="center">0.71</td>
</tr>
<tr>
<td align="center"><bold>50_20_10_200k</bold></td>
<td align="center">0.63</td>
<td align="center">N/A</td>
<td align="center">0.71</td>
<td align="center">0.72</td>
</tr>
<tr>
<td align="center"><bold>50_10_30_100k</bold></td>
<td align="center">0.96</td>
<td align="center">0.94</td>
<td align="center">1.00</td>
<td align="center">1.00</td>
</tr>
<tr>
<td align="center"><bold>50_20_20_200k</bold></td>
<td align="center">0.97</td>
<td align="center">N/A</td>
<td align="center">0.98</td>
<td align="center">0.98</td>
</tr>
<tr>
<td align="center" style="border-bottom:dotted"><bold>50_20_30_200k</bold></td>
<td align="center" style="border-bottom:dotted">0.95</td>
<td align="center" style="border-bottom:dotted">N/A</td>
<td align="center" style="border-bottom:dotted">1.00</td>
<td align="center" style="border-bottom:dotted">1.00</td>
</tr>
<tr>
<td align="center"><bold>Stem Cell</bold></td>
<td align="center" rowspan="2">0.98</td>
<td align="center" rowspan="2">0.41</td>
<td align="center" rowspan="2">0.98</td>
<td align="center" rowspan="2">0.91</td>
</tr>
<tr>
<td align="center"><bold>(6 dimensions, 5 subpopulations)</bold></td>
</tr>
<tr>
<td align="center"><bold>NDD</bold></td>
<td align="center" rowspan="2">0.8</td>
<td align="center" rowspan="2">0.77</td>
<td align="center" rowspan="2">0.79</td>
<td align="center" rowspan="2">0.8</td>
</tr>
<tr>
<td align="center"><bold>(12 dimensions, 8 subpopulations)</bold></td>
</tr>
<tr>
<td align="center"><bold>CyTOF</bold></td>
<td align="center" rowspan="2">0.59</td>
<td align="center" rowspan="2">0.53</td>
<td align="center" rowspan="2">0.84</td>
<td align="center" rowspan="2">0.82</td>
</tr>
<tr>
<td align="center"><bold>(39 dimensions, 24 subpopulations)</bold></td>
</tr>
</tbody>
</table>
</alternatives>
<table-wrap-foot>
<fn id="t001fn001"><p>F-measure is calculated using the original hand-gate labels and the estimated labels generated by each analysis method. The true-positives are found if the methods assign the same labels to points belonging to the same subpopulation in the hand-gated data. The more true-positives found, the higher the F-measure, which ranges from 0 to 1, with 1 being the highest. Partition-based methods perform consistently well on data ranging from 5 to 50 dimensions. In the simulations, d-PAC and b-PAC perform just as well or better than flowMeans and SPADE. flowMeans gives drastically different F-measures for the cases 20_10_40_100k and 20_20_40_100k: 0.25386 vs. 0.92518; this large difference is likely due to the random initiation of cluster centers. In the hand-gated datasets, SPADE has the worst performance. Ultimately, the performance of flowMeans and SPADE deteriorate for the 39-dimensional real CyTOF data, while d-PAC and b-PAC perform consistently well.</p></fn>
<fn id="t001fn002"><p>In this table, simulated data have the following convention: a_b_c_d, where a denotes the number of dimensions/markers, b denotes the number of subpopulations, c denotes the edge size of the hypercube for data generation, and d denotes the number of cells. The clustering problem becomes harder as the number of subpopulations increases and the data space volume decreases. We report the results for simulated cases that worked for all methods, except for higher-dimension cases in which the clusters are nearby and SPADE failed to cluster; these SPADE results are denoted with N/A.</p></fn>
<fn id="t001fn003"><p>** In this table, 1.00 means a number which rounds up to 1.00.</p></fn>
</table-wrap-foot>
</table-wrap>
<p>Next, we tested the methods based on published hand-gated cytometry datasets to see how similar the estimated subpopulations are to those obtained by human experts. We applied the methods on the hematopoietic stem cell transplant and Normal Donors datasets from the FlowCAP challenges[<xref ref-type="bibr" rid="pcbi.1005875.ref002">2</xref>] and on the subset of gated mouse bone marrow CyTOF dataset (Dataset 9) recently published[<xref ref-type="bibr" rid="pcbi.1005875.ref011">11</xref>]. The gating strategy of the CyTOF dataset is provided in <xref ref-type="supplementary-material" rid="pcbi.1005875.s001">S1 Fig</xref>. The dataset and expert gating strategy are the same as described earlier[<xref ref-type="bibr" rid="pcbi.1005875.ref014">14</xref>]. Note that in the flow cytometry data, the computed F-measures are slightly lower than that reported in FlowCAP; this is due to the difference in the definition of F-measures. Overall, the PAC outperforms flowMeans and SPADE by consistently obtaining higher F-measures (<xref ref-type="table" rid="pcbi.1005875.t001">Table 1</xref>). In particular, in the CyTOF data example, PAC generated significantly higher F-measures (greater than 0.82) than flowMeans and SPADE (0.59 and 0.53, respectively). In addition, PAC gives higher overall subpopulation-specific purities (<xref ref-type="supplementary-material" rid="pcbi.1005875.s016">S2B Fig</xref> and <xref ref-type="supplementary-material" rid="pcbi.1005875.s015">S1 Table</xref>). These results indicate that PAC gives consistently good results for both low and high-dimensional datasets. Furthermore, PAC results match human hand-gating results very well. The t-SNE ‘islands’ in the plots are well-colored by the PAC methods, demonstrating that both major and minor/rare subpopulations are captured. The consistency between PAC-MAN results and hand-gating results in this large data set confirms the practical utility of the methodology.</p>
<p>We use t-SNE plots heavily for visualization because t-SNE is a great visualization tool. It is reasonable to ask whether one can obtain good subpopulations by performing cluster analysis on the low-dimensional data points output by t-SNE. Currently, this alternative approach is computationally expensive and not scalable as existing t-SNE implementations cannot be scaled to millions of high-dimensional points, restricting this analysis approach to only hundred of thousands of points in practice. In the downstream, hierarchical clustering or kmeans clustering could be applied; however, hierarchical clustering is very expensive due to the maintenance of a distance matrix during calculations (cannot be easily performed for data with more than thousands of points), while kmeans clustering does not give satisfactory results (<xref ref-type="supplementary-material" rid="pcbi.1005875.s007">S7 Fig</xref>) due to the ‘flattened’ geometry of the high-dimensional points in the t-SNE embedding. Thus, embedding is good for visualization but it is not supposed to capture all information of clusters efficiently. In CyTOF data analysis, we recommend performing PAC methods on the dataset, and utilize t-SNE plots to visualize the clustering results with a subset of points for confirmation.</p>
</sec>
<sec id="sec007">
<title>Separate-then-combine outperforms pool approach when batch effect is present</title>
<p>It is natural to analyze samples separately then combine the subpopulation features for downstream analysis in the multiple samples setting. However, we need to resolve the batch effects. Two distinct subpopulations could overlap in the combined/pooled sample, such as in the case when the data came from two generations of CyTOF instruments (newer instrument elevates the signals). On the other hand, in cases with changing means, two subpopulations can evolve together such that their means change slightly, but enough to shadow each other when samples are merged prior to clustering.</p>
<p>We introduce Multiple Alignments of Networks to resolve the management issue surrounding the organization of homogeneous clusters found in the PAC step (<xref ref-type="fig" rid="pcbi.1005875.g005">Fig 5</xref>). First, we consider the overlapping scenario (<xref ref-type="fig" rid="pcbi.1005875.g006">Fig 6A</xref>). When viewed together in the merged sample, the right subpopulation from sample 1 overlaps with the left subpopulation in sample 2 (<xref ref-type="fig" rid="pcbi.1005875.g006">Fig 6B</xref> left panel). There is no way to use expression level alone to delineate the two overlapping subpopulations (<xref ref-type="fig" rid="pcbi.1005875.g006">Fig 6B</xref> right panel). By learning more subpopulations using PAC, there are some hints that multiple subpopulations are present (<xref ref-type="fig" rid="pcbi.1005875.g006">Fig 6C</xref>). Despite these hints, it would not be possible to say whether the shadowed subpopulations relate in any way to other distinct subpopulations.</p>
<fig id="pcbi.1005875.g005" position="float">
<object-id pub-id-type="doi">10.1371/journal.pcbi.1005875.g005</object-id>
<label>Fig 5</label>
<caption>
<title>Schematic analogy of MAN.</title>
<p>Consider a deck of networks (in analogy to cards), with each “suit” representing a sample and each “rank” representing a unique network structure. The networks are aligned by similarity and organized on a dendrogram. The tree is cut (red line) at the optimal level (by elbow point analysis, see <xref ref-type="supplementary-material" rid="pcbi.1005875.s008">S8 Fig</xref>) to output <italic>k</italic> clades. Within each clade, the network structures are similar or the same. If the same sample has multiple networks in the same clade, then these networks are merged (black box around same cards).</p>
</caption>
<graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.g005" xlink:type="simple"/>
</fig>
<fig id="pcbi.1005875.g006" position="float">
<object-id pub-id-type="doi">10.1371/journal.pcbi.1005875.g006</object-id>
<label>Fig 6</label>
<caption>
<title>Simple batch effect scenario.</title>
<p>A simple batch effect dataset was simulated and visualized. This data has 5 dimensions, with 2 informative dimensions for visualization. (a) Two simulated data samples with the same subpopulations. The means shifted (up in sample 2) due to measurement batch effect. (b) When the samples are combined, as in the case of analyzing/pooling all samples together, two different subpopulations overlap (left panel). The overlapped subpopulations cannot be distinguished by clustering (right panel). (c) PAC could be used to discover more subpopulations, however, the hints of the present of another subpopulation do not help to resolve the batch effect. Thus, in this case, it is necessary to analyze the samples separately and then find relationships between the subpopulations across the samples.</p>
</caption>
<graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.g006" xlink:type="simple"/>
</fig>
<p>PAC-MAN resolves the overlapping issue by analyzing the samples separately (<xref ref-type="fig" rid="pcbi.1005875.g007">Fig 7</xref>). In the case in which we do not know <italic>a priori</italic> the number of true subpopulations, we learn three subpopulations per sample (<xref ref-type="fig" rid="pcbi.1005875.g007">Fig 7A</xref>). The network structures of the subpopulations discovered are presented in <xref ref-type="fig" rid="pcbi.1005875.g007">Fig 7B and 7C</xref> and we see that the third subpopulations from the two samples share the same network structures, while the first two subpopulations of the two samples differ by only one edge; these respective networks are clustered together in the dendrogram (<xref ref-type="fig" rid="pcbi.1005875.g008">Fig 8A</xref> right panel; subpopulation indexes are suffixes on the dendrogram). By utilizing the networks, the clades that represent the same and/or similar subpopulations of cells can be established. Clustering by network structures alone resolves the points in the data (<xref ref-type="fig" rid="pcbi.1005875.g008">Fig 8A</xref>, left panel). In contrast, alignment by marker (gene expression) levels cannot resolve the batch effect (<xref ref-type="fig" rid="pcbi.1005875.g008">Fig 8B</xref>).</p>
<fig id="pcbi.1005875.g007" position="float">
<object-id pub-id-type="doi">10.1371/journal.pcbi.1005875.g007</object-id>
<label>Fig 7</label>
<caption>
<title>Calculation of sample clusters and their underlying network structures.</title>
<p>(a) In the batch effect simulation data, PAC was used to discover several subpopulations per sample without advanced knowledge of the exact number of subpopulations. Here, the colors denote the different clusters within each sample. Panels (b)-(c) show the networks of the subpopulations in both samples 1 and 2, respectively, that are discovered in (a). In these networks, the nodes denote the markers (or genes) measured (in this simulation data, the dimensions are named V1, V2,…, V5). The edges denote correlative relationship in terms of mutual information. These networks can be grouped by similarities to organize the subpopulations across samples. In the PAC-MAN implementation, the alignment is based on Jaccard dissimilarity network structure, and we organize the networks with hierarchical clustering of the Jaccard scores.</p>
</caption>
<graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.g007" xlink:type="simple"/>
</fig>
<fig id="pcbi.1005875.g008" position="float">
<object-id pub-id-type="doi">10.1371/journal.pcbi.1005875.g008</object-id>
<label>Fig 8</label>
<caption>
<title>Resolution of batch effects for simple batch effect scenario.</title>
<p>Network alignments allow the resolution of mean shift batch effect. (a) Resolution of batch effect by networks of all subpopulations discovered. In the left panel, the colors denote subpopulations that are aligned by network structures. The overlapped subpopulations are correctly labeled. The right panel shows the hierarchical clustering of the subpopulations’ networks via Jaccard dissimilarities. These subpopulations are the same as those in <xref ref-type="fig" rid="pcbi.1005875.g007">Fig 7</xref>. (b) Resolution of batch effect by marker levels. Alternative to alignment by network, marker levels (subpopulation centroids) can be used. However, the overlap of the different subpopulations from the two samples makes it impossible to resolve the mean shift in this simulated data. The hierarchical clustering of the centroids organize the subpopulations differently than that in part (a).</p>
</caption>
<graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.g008" xlink:type="simple"/>
</fig>
<p>Next we consider the case with dynamic evolution of subpopulations that models the treatment-control and perturbation studies. The interesting information is in tracking how subpopulations change over the course of the experiment. In the simulation, we have generated two subpopulations that nearly converge in mean expression profile over the time course (<xref ref-type="fig" rid="pcbi.1005875.g009">Fig 9</xref>). The researcher could lose the dynamic information if they were to combine the samples for clustering analysis. As in the previous case, we could use PAC to learn several subpopulations per sample (<xref ref-type="fig" rid="pcbi.1005875.g010">Fig 10</xref>). Then, with the assumption that there are two evolving clusters from data exploration, we align the subpopulations to construct clades of same and/or similar subpopulations (<xref ref-type="fig" rid="pcbi.1005875.g011">Fig 11</xref> left panel) based on the network structural information (<xref ref-type="supplementary-material" rid="pcbi.1005875.s003">S3 Fig</xref>). With network and expression level information in the alignment process, the two subpopulations or clades can be resolved naturally (<xref ref-type="fig" rid="pcbi.1005875.g011">Fig 11</xref> right panel).</p>
<fig id="pcbi.1005875.g009" position="float">
<object-id pub-id-type="doi">10.1371/journal.pcbi.1005875.g009</object-id>
<label>Fig 9</label>
<caption>
<title>Dynamic batch effect scenario.</title>
<p>Two subpopulations, in blue color, migrate in a time series fashion (begins in sample 1, and progresses through samples 2, 3, 4, and 5). In this simulation data, the dimensions are named V1, V2,…, V5, and V1 and V2 are the informative dimensions. The two sample subpopulations almost converge by mean shifts through the time series. The bottom right panel shows the subpopulations pooled into one figure; the colors denote subpopulations.</p>
</caption>
<graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.g009" xlink:type="simple"/>
</fig>
<fig id="pcbi.1005875.g010" position="float">
<object-id pub-id-type="doi">10.1371/journal.pcbi.1005875.g010</object-id>
<label>Fig 10</label>
<caption>
<title>PAC clustering on dynamic batch effect scenario samples.</title>
<p>We used PAC to discover several subpopulations per sample without advanced knowledge of the number of subpopulations present. The colors within each sample denote a distinct PAC subpopulation, but the colors have no meaning across samples.</p>
</caption>
<graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.g010" xlink:type="simple"/>
</fig>
<fig id="pcbi.1005875.g011" position="float">
<object-id pub-id-type="doi">10.1371/journal.pcbi.1005875.g011</object-id>
<label>Fig 11</label>
<caption>
<title>Resolution of dynamic batch effects scenario.</title>
<p>Comparison of PAC-MAN results between representative clades (number of clades set to 2). Using network structures (left panel) or expression information (middle panel) alone does not resolve the dynamic information. On the other hand, the dynamic information is resolved first by alignments of networks of larger subpopulations and then by merging smaller subpopulations (with unstable network structures) by expression into the aligned clades (right panel).</p>
</caption>
<graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.g011" xlink:type="simple"/>
</fig>
</sec>
<sec id="sec008">
<title>Network and expression alignment is better than network or expression alignment alone</title>
<p>With networks in hand, we could further characterize the relationships between subpopulations across samples. However, the alignment process needs to work well for true linkage to be established. We could align by network alone, by expression (or marker) means, or both. <xref ref-type="fig" rid="pcbi.1005875.g011">Fig 11</xref> presents these alternatives in comparison. By using all the subpopulation networks, the results still contain subsets of misplaced cells (11 left panel). This is because small clusters of cells have noisy underlying covariance structure; therefore, the networks cannot be accurately inferred. These structural inaccuracies negatively impact the network clustering. The (mean) marker level approach also does not work well (<xref ref-type="fig" rid="pcbi.1005875.g011">Fig 11</xref> center panel) due to the subpopulation mean shifts across samples. On the other hand, the sequential approach works well (<xref ref-type="fig" rid="pcbi.1005875.g011">Fig 11</xref> right panel). In the sequential approach, larger (&gt;1000) subpopulations’ networks are utilized for the initial alignment process. Next, the smaller subpopulations, which have noisy covariance, are merged with the closest larger, aligned subpopulations. Thus, more subpopulations could be discovered upstream (in PAC), and the network alignment would work similarly as the smaller subpopulations, which could be fragments of a distribution, do not impact the alignment process (<xref ref-type="supplementary-material" rid="pcbi.1005875.s004">S4A and S4B Fig</xref>). Moreover, in the network inference step, unimportant edges can negatively impact the alignment process (<xref ref-type="supplementary-material" rid="pcbi.1005875.s004">S4C Fig</xref>) in the network-alone case. Biologically, this means that edges that do not constrain or define the cellular state should not be utilized in the alignment of cellular states. Effectively, the threshold placed on the number of edges in the network inference controls for the importance of the edges. Thus, the combined alignment approach works well and allows moderate over-saturation of cellular states to be discovered in the PAC step so that no advance knowledge of the exact number of subpopulations is necessary. It is important to note that we have not utilized high-dimensional mutual information for network structure inference, which is computationally intensive. It may be possible that there exist complex relationships between more than two markers that could yield different network structures for two subpopulations that otherwise would have the same network structure. However, in our analysis of cytometry data, pairwise mutual information with downstream processing yields robust characterization of the cellular state relationships between subpopulations.</p>
</sec>
<sec id="sec009">
<title>PAC-MAN efficiently outputs meaningful data-level subpopulations for mouse tissue dataset</title>
<p>We use the recently published mouse tissue dataset [<xref ref-type="bibr" rid="pcbi.1005875.ref011">11</xref>] to illustrate the multi-sample data analysis pipeline. The processed dataset contains a total of more than 13 million cell events in 10 different tissue samples, and 39 markers per event (<xref ref-type="supplementary-material" rid="pcbi.1005875.s016">S2 Table</xref>). The original research results centered on subpopulations discovered from hand-gating the bone marrow tissue data to find ‘landmark’ subpopulations; the rest of the data points were clustered to the most similar landmark subpopulations. While this enables the exploration of the overall landscape from the perspective of bone marrow cell types within an acceptable time frame, a significant amount of useful information from the data remains hidden; a larger dataset would make it infeasible to analyze by manual gating and existing computational tools to learn the relationships of the cellular states among all samples. In addition, a natural question is how well do the bone marrow cell types represent the whole immune system?</p>
<p>In contrast to the one-sample perspective, using d-PAC-MAN, the fastest approach by our comparison results, we can perform subpopulation discovery for each sample automatically and then align the subpopulations across samples to establish dataset-level cellular states. On a standard Core i7-44880 3.40GHz PC computer, the single-thread data analysis process with all data points and optimization takes about two hours to complete, which is much faster than alternative methods. With multi-threading and parallel processing, the data analysis procedure can be completed very quickly. As mentioned earlier, PAC results for the bone marrow subsetted data from this dataset matches closely to that of the hand-gated results. This accuracy provides confidence for applying PAC to the rest of the dataset.</p>
<p>Figs <xref ref-type="fig" rid="pcbi.1005875.g012">12</xref> and <xref ref-type="fig" rid="pcbi.1005875.g013">13</xref> show the t-SNE plots for subpopulation discovered (top panel of each sample) and the representative subpopulation established (bottom panel of each sample) for the entire dataset. In the PAC discovery step, we learn 50 subpopulations per sample without advance knowledge of how many subpopulations are present. This moderate over-partitioning of the data samples leads to a moderate heterogeneity in the t-SNE plots. From tests, we have found that learning 2–3 times the expected number of subpopulations in the sample works well; it is important to emphasize that aggressive over-partitioning is suboptimal because it creates very small subpopulations that have unstable covariance structures, which removes these small clusters data points from network alignment. Next, the networks are inferred for the larger subpopulations (with number of cell events greater than 1000), and the networks are aligned for all the tissue samples. To choose the optimal number of total subpopulations to output, we perform the elbow point test at this step, in which we calculated the within cluster standard deviations while varying the number of subpopulations outputted for the entire dataset. The elbow point rests at 130 clusters (<xref ref-type="supplementary-material" rid="pcbi.1005875.s008">S8 Fig</xref>), and we outputted 130 representative subpopulations, also called clades, for the entire dataset to account for the traditional immunological cellular states and sample-specific cellular states present. Within samples, the subpopulations that cluster together by network structure are aggregated. The smaller subpopulations (&lt;1,000 cells each, not involved in network alignment) are either merged to the closest larger subpopulation or establish their own sample-specific subpopulation by expression alignment. We attempt to assign these very small subpopulations back with larger clades by grouping all subpopulations within each sample into 5 expression-level clusters (using cluster centroids), and thus we kept the larger subpopulations and a maximum of 4 minor sample-specific subpopulations for each tissue sample. Subpopulations with less than 100 cell events were discarded. The representative subpopulations (143 total including sample-specific minor subpopulations) follow the approximate distribution of the cell events on the t-SNE plots and the aggregating effect cleans up the heterogeneities due to over-partitioning in the PAC step.</p>
<fig id="pcbi.1005875.g012" position="float">
<object-id pub-id-type="doi">10.1371/journal.pcbi.1005875.g012</object-id>
<label>Fig 12</label>
<caption>
<title>Visualization of PAC vs. PAC-MAN results for blood, bone marrow, colon, inguinal lymph node, and liver samples.</title>
<p>The PAC (explorative clustering) and PAC-MAN (data-level cellular states) results are presented for each sample in column-wise fashion. Each tissue sample’s t-SNE plots were generated using 100,000 randomly drawn cell events for that sample. The results from PAC (top panel) and PAC-MAN (bottom panel) steps are presented in pairs. Initial PAC discovery was set to 50 subpopulations without advanced knowledge of the number of subpopulations in each sample. In MAN, 130 network clades (optimal number from elbow point analysis) were outputted, and the cellular states are defined by expression (marker signal), network structure, and dataset-level variation. This composite definition of cellular state naturally aggregates the PAC clusters to yield smaller number of subpopulations in less variable samples. <xref ref-type="supplementary-material" rid="pcbi.1005875.s011">S11 Fig</xref> is a higher resolution version of Fig 12 with subpopulation and clade labels.</p>
</caption>
<graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.g012" xlink:type="simple"/>
</fig>
<fig id="pcbi.1005875.g013" position="float">
<object-id pub-id-type="doi">10.1371/journal.pcbi.1005875.g013</object-id>
<label>Fig 13</label>
<caption>
<title>Visualization of PAC vs. PAC-MAN results for lung, mesenteric lymph node, spleen, thymus, and small intestine samples.</title>
<p>The settings and descriptions are the same as those in <xref ref-type="fig" rid="pcbi.1005875.g012">Fig 12</xref>. Continuation of visualization of PAC-MAN results for the mouse tissue data. <xref ref-type="supplementary-material" rid="pcbi.1005875.s012">S12 Fig</xref> is a higher resolution version of Fig 13 with subpopulation and clade labels.</p>
</caption>
<graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.g013" xlink:type="simple"/>
</fig>
<p>The cell type clades are the representative subpopulations for the entire dataset, and they could either be present across samples or in one sample alone. Their distribution is visualized by a heatmap (<xref ref-type="fig" rid="pcbi.1005875.g014">Fig 14</xref>). While the bone marrow sample contains many cell types, only a subset of them are directly aligned to cell types in other samples, which means using the bone marrow data as the reference point leaves much information unlocked in the dataset. Therefore, the data suggests that the bone marrow cell types are not adequate in representing all cell types in the immune system. The cell types in the blood and spleen samples have various alignments with cell types in other samples. The lymph node samples share many clades likely due to the connection through the lymphatic vessels; the small intestine and colon samples also share many clades, probably due to closeness in location and biological function. Nevertheless, the results show that the tissue samples do not share exactly the same clades, suggesting that the immune system cells have different states in different organs. On the other hand, the thymus sample has few clades shared with other samples, which may be due to its functional specificity.</p>
<fig id="pcbi.1005875.g014" position="float">
<object-id pub-id-type="doi">10.1371/journal.pcbi.1005875.g014</object-id>
<label>Fig 14</label>
<caption>
<title>Heatmap of clade proportions across the tissue samples.</title>
<p>Sample-specific clades have a value of 1, while shared clades have proportions spread across different samples. Physiologically similar samples share more clades. <xref ref-type="supplementary-material" rid="pcbi.1005875.s013">S13 Fig</xref> is a higher resolution version of Fig 14 with clade labels.</p>
</caption>
<graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.g014" xlink:type="simple"/>
</fig>
<p>PAC-MAN style analysis can be applied to align the tissue subpopulations by their means instead of network similarities (<xref ref-type="supplementary-material" rid="pcbi.1005875.s005">S5 Fig</xref>). As done previously, 143 overall representative clades (130 network clades + 13 minor sample-specific subpopulations) were outputted. The same aggregating effect is observed (<xref ref-type="supplementary-material" rid="pcbi.1005875.s005">S5A Fig</xref>), and this is due to the organization from dataset-level variation in the means. Comparing to the network alignment, the means linkage approach has more subpopulations per sample; the subpopulation proportion heatmap (<xref ref-type="supplementary-material" rid="pcbi.1005875.s005">S5B Fig</xref>) shows more linking. Although the bone marrow sample subpopulations co-occur in the same clades slightly more with other sample subpopulations, this sample does not co-occur with many clades in the dataset. Thus, a PAC-MAN style analysis with means linkage also harvests additional information from the entire dataset.</p>
<p>In general, the means alignment approach gives many more clades per sample than that of the network alignment PAC-MAN approach. In fact, the network approach has 88 linkages while the means approach has 270 linkages. The linkage plot (<xref ref-type="supplementary-material" rid="pcbi.1005875.s006">S6A Fig</xref>) shows that the low linkages occur slightly more frequently for the network approach. One consequence is that the network approach aggregates PAC subpopulations within sample more frequently; for instance, in the thymus sample, the network approach yields 13 clades (and 2 minor sample-specific subpopulations) while the means approach yields 39 clades.</p>
<p>After aggregating, the clade sizes (with unique participants per sample) are plotted (<xref ref-type="supplementary-material" rid="pcbi.1005875.s006">S6B Fig</xref>). The network approach tends to find fewer linkages, as more clades have sizes of less than 4, while the means approach has more clades than the network approach with clade sizes greater than 4. The network approach is more conservative due to the additional constraints from network structures. Conventionally, in the cytometry field, only the means are considered in the definition of cellular states. The network alignment is more stringent in the establishment of linkages; the network PAC-MAN approach defines cellular states with the additional information from network structures, and it has the effect of constraining the number of linkages between samples while finding linkages for subpopulations that are distant in their means.</p>
<p>Further studies are needed to combine the information from both the marker level and network structures to organize the cellular states discovered in cytometry datasets, for example, through a weighted score based on the means and network alignments. In this study, we demonstrated that the covariance and network structures built from subpopulations are valuable and can be utilized to organize data-level cellular state relationships.</p>
</sec>
<sec id="sec010">
<title>Network hubs provide useful annotations</title>
<p>To further characterize the cell types, we annotate the clades within each sample using the top network hub markers, which constrain the cellular states. The full network structure annotation, along with average expression profiles, is presented in <xref ref-type="supplementary-material" rid="pcbi.1005875.s017">S3 Table</xref>. The clade information is presented in the ClusterID column. The annotations for cells across different samples but within the same clades share hub markers. For example, in clade 1 for the blood and bone marrow samples, the cells share the hub markers Ly6C and CD11b. In the bone marrow sample, one important set of subpopulations is the hematopoietic stem cell subpopulations. One such subpopulation is present as clade 33 with the annotation F4/80.CD16/32.Sca1.cKit and is about 1.18 percent in the bone marrow sample. Clade 33 is only present in the bone marrow sample, indicating that the PAC-MAN pipeline defines this as a sample-specific and coherent subpopulation using dataset-level variation. The thymus contains a large subpopulation clade 124 (84.07 percent) that is characterized as CD5.CD43.CD3.CD4, suggesting it to be the maturing T-cell subpopulation.</p>
</sec>
<sec id="sec011">
<title>Constellation plot combines clade and signal information</title>
<p>PAC-MAN generates both the clade and subpopulation signal (or expression) information. <xref ref-type="fig" rid="pcbi.1005875.g014">Fig 14</xref> visualizes the occurrence and proportions of representative subpopulations in the dataset. To understand the expression levels of the markers for the subpopulation, a heatmap is constructed (<xref ref-type="fig" rid="pcbi.1005875.g015">Fig 15</xref> and <xref ref-type="supplementary-material" rid="pcbi.1005875.s014">S14 Fig</xref>). In high-dimension, the subpopulations can form regions in which similar cellular states are next to each other. Do subpopulations belonging to the same clade occupy the same region? In addition, what is the spatial spread of subpopulations belonging to the same clade? To visualize the clade relationships between subpopulations in the dataset, we construct the constellation plot (<xref ref-type="fig" rid="pcbi.1005875.g016">Fig 16</xref>). First, the centroids of the discovered subpopulations are inputted into a t-SNE visualization processing, which projects and separates the centroids onto a 2D plane. Next, the clades are color-coded such that 1) grey color indicates sample-specific clade and 2) non-grey colors indicate clades with multiple sample representation. Finally, we group the subpopulations in each clade by drawing lines to connect the closest clade subpopulation on the 2D plane, analogous to the visualization of stars by constellation nomenclature.</p>
<fig id="pcbi.1005875.g015" position="float">
<object-id pub-id-type="doi">10.1371/journal.pcbi.1005875.g015</object-id>
<label>Fig 15</label>
<caption>
<title>Heatmap of average subpopulation expression levels in all tissue samples.</title>
<p>The expression heatmap illustrates the average expression of PAC-MAN-discovered subpopulations. The subpopulations are grouped by hierarchical clustering, and subpopulations close in expression space are organized into blocks. <xref ref-type="supplementary-material" rid="pcbi.1005875.s014">S14 Fig</xref> is a higher resolution version of Fig 15 with clade labels.</p>
</caption>
<graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.g015" xlink:type="simple"/>
</fig>
<fig id="pcbi.1005875.g016" position="float">
<object-id pub-id-type="doi">10.1371/journal.pcbi.1005875.g016</object-id>
<label>Fig 16</label>
<caption>
<title>Constellation plot of clades.</title>
<p>The constellation plot is designed to visualize both the expression and clade information of discovered subpopulations. Here, the centroids (average expression) of PAC-MAN-discovered subpopulations in the example tissue dataset are projected onto a t-SNE 2D space. Clades that only occur in one sample are colored grey. The non-grey clades occur in at least two samples, with unique colors and clade identification denoting each clade. On the constellation plot, the closest multi-sample clade subpopulations are connected by a straight line.</p>
</caption>
<graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.g016" xlink:type="simple"/>
</fig>
<p>The constellation plot is useful in looking at the spread of the clades in relation to other subpopulations. For example, clade 10, which contains subpopulations that are CD45+CD3+CD5+CD8+, and clade 8, which contains subpopulations that are CD45+CD3+CD5+CD4+, are T cells (<xref ref-type="supplementary-material" rid="pcbi.1005875.s014">S14 Fig</xref>); these two clade groups exist next to each other in the constellation plot, but they do not overlap. Clade 2 is in a region that contains CD45+CD19+B220+ subpopulations, which signify B cells. Furthermore, within each clade, the subpopulation networks are similar and contain similar hub genes. For instances, clades 2 and 8 represent data-level subsets of T cells and B cells, respectively; clades 2 and 8’s networks are presented in Figs <xref ref-type="fig" rid="pcbi.1005875.g017">17</xref> and <xref ref-type="fig" rid="pcbi.1005875.g018">18</xref>. Each clade has its unique network structures and a set of hub markers. Overall, in this analysis, we observe that clades defined by signal levels and network structures tend to occupy defined regions in high-dimensional space. Certainly, not all cell types are present in all tissue samples, and those immune cell subsets that are similar enough to be in the same clade may differ due to their tissue-specific, local environmental factors.</p>
<fig id="pcbi.1005875.g017" position="float">
<object-id pub-id-type="doi">10.1371/journal.pcbi.1005875.g017</object-id>
<label>Fig 17</label>
<caption>
<title>Network structures of Clade 2: B cells.</title>
<p>In each network figure, the markers are denoted by nodes of different colors. These networks show the top edges that define the network structures for subpopulations in clade 2. The subpopulation network structures for each subpopulation in clade 2 show that certain markers, such as B220 and MHCII, are hubs across most, if not all, networks in this clade. This hub combination is consistent and unique to clade 2 (see <xref ref-type="fig" rid="pcbi.1005875.g018">Fig 18</xref>).</p>
</caption>
<graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.g017" xlink:type="simple"/>
</fig>
<fig id="pcbi.1005875.g018" position="float">
<object-id pub-id-type="doi">10.1371/journal.pcbi.1005875.g018</object-id>
<label>Fig 18</label>
<caption>
<title>Network structures of Clade 8: CD4+ T cells.</title>
<p>The set up is the same as in <xref ref-type="fig" rid="pcbi.1005875.g017">Fig 17</xref>. The subpopulation network structures for each subpopulation in clade 8 show that certain markers, such as CD3 and CD4, are hubs across most, if not all, networks in this clade. This hub combination is consistent and unique to clade 8.</p>
</caption>
<graphic mimetype="image" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.g018" xlink:type="simple"/>
</fig>
</sec>
<sec id="sec012" sec-type="conclusions">
<title>Conclusion</title>
<p>We have presented the PAC-MAN data analysis pipeline. This pipeline was designed to remove major roadblocks in the utilization of existing and future CyTOF datasets. First, we established a quick and accurate clustering method that closely matches expert gating results; second, we demonstrated the management of multiple samples by handling mean shifts and batch effects across samples. We demonstrated that the inter-marker relationship in the form of mutual information networks is extremely useful in defining cellular states. The alignment of network structures allows researchers to find relationships between cells across samples without resorting to pooling of all data points. PAC-MAN allows the cytometry field to harvest information from the increasing amount of CyTOF data available. It is important to standardize multi-sample data analysis with automation so that discoveries based on multi-sample CyTOF datasets from different laboratories do not depend on the experts’ manual gating strategies and the grouping of subpopulations that is constrained by non-systematic computations. Furthermore, due to PAC-MAN’s generality, this pipeline can be utilized to analyze large datasets of high-dimension beyond the cytometry field.</p>
</sec>
</sec>
<sec id="sec013" sec-type="materials|methods">
<title>Materials and methods</title>
<sec id="sec014">
<title>Partition-assisted clustering has two parts</title>
<list list-type="order">
<list-item><p>Partitioning: a partition method (BSP[<xref ref-type="bibr" rid="pcbi.1005875.ref005">5</xref>] or DSP[<xref ref-type="bibr" rid="pcbi.1005875.ref007">7</xref>]) is used to learn N initial cluster centers from the original data.</p></list-item>
<list-item><p>Post-processing: A small number (m) of k-mean iterations is applied to the rectangle-based clusters from the partitioning, where m is a user-specified number. We used m = 50 in our examples. After this k-means refinement, we merge the N clusters hierarchically until the desired number of clusters (this number is user-specified) is reached. The merging is based on a given distance metric for clusters. In the current implementation, we use the same distant metric as in flowMeans[<xref ref-type="bibr" rid="pcbi.1005875.ref001">1</xref>]. That is, for two clusters X and Y, their distance D(X,Y) is defined as:
<disp-formula id="pcbi.1005875.e001">
<alternatives>
<graphic id="pcbi.1005875.e001g" mimetype="image" position="anchor" xlink:href="info:doi/10.1371/journal.pcbi.1005875.e001" xlink:type="simple"/>
<mml:math display="block" id="M1">
<mml:mi mathvariant="normal">D</mml:mi><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="normal">X</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="normal">Y</mml:mi></mml:mrow><mml:mo>)</mml:mo><mml:mo>=</mml:mo><mml:mi mathvariant="normal">m</mml:mi><mml:mi mathvariant="normal">i</mml:mi><mml:mi mathvariant="normal">n</mml:mi><mml:mo>⁡</mml:mo><mml:mo>{</mml:mo><mml:msup><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover><mml:mo>−</mml:mo><mml:mover accent="true"><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mrow><mml:mi>T</mml:mi></mml:mrow></mml:msup><mml:msubsup><mml:mrow><mml:mi>S</mml:mi></mml:mrow><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msubsup><mml:mo>(</mml:mo><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover><mml:mo>−</mml:mo><mml:mover accent="true"><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover></mml:mrow><mml:mo>)</mml:mo><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover><mml:mo>−</mml:mo><mml:mover accent="true"><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mrow><mml:mi>T</mml:mi></mml:mrow></mml:msup><mml:msubsup><mml:mrow><mml:mi>S</mml:mi></mml:mrow><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msubsup><mml:mo>(</mml:mo><mml:mover accent="true"><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover><mml:mo>−</mml:mo><mml:mover accent="true"><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover><mml:mo>)</mml:mo><mml:mo>}</mml:mo>
</mml:math>
</alternatives>
<label>(1)</label>
</disp-formula>
where <inline-formula id="pcbi.1005875.e002"><alternatives><graphic id="pcbi.1005875.e002g" mimetype="image" position="anchor" xlink:href="info:doi/10.1371/journal.pcbi.1005875.e002" xlink:type="simple"/><mml:math display="inline" id="M2"><mml:mover accent="true"><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover><mml:mo>,</mml:mo><mml:mover accent="true"><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover></mml:math></alternatives></inline-formula> are the sample mean of cluster X and Y, respectively. <inline-formula id="pcbi.1005875.e003"><alternatives><graphic id="pcbi.1005875.e003g" mimetype="image" position="anchor" xlink:href="info:doi/10.1371/journal.pcbi.1005875.e003" xlink:type="simple"/><mml:math display="inline" id="M3"><mml:msubsup><mml:mrow><mml:mi mathvariant="normal">S</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">x</mml:mi></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msubsup></mml:math></alternatives></inline-formula> is the inverse of the sample covariance matrix of cluster X. <inline-formula id="pcbi.1005875.e004"><alternatives><graphic id="pcbi.1005875.e004g" mimetype="image" position="anchor" xlink:href="info:doi/10.1371/journal.pcbi.1005875.e004" xlink:type="simple"/><mml:math display="inline" id="M4"><mml:msubsup><mml:mrow><mml:mi>S</mml:mi></mml:mrow><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msubsup></mml:math></alternatives></inline-formula> is defined similarly. In each step of the merging process, the two clusters having the smallest pairwise distance will be merged together into one cluster.</p></list-item>
</list>
</sec>
<sec id="sec015">
<title>Partition methods</title>
<p>There are two partition methods implemented in the comparison study: d-PAC and b-PAC. The results are similar, with d-PAC being the faster algorithm. <xref ref-type="fig" rid="pcbi.1005875.g001">Fig 1A</xref> illustrates this recursive process.</p>
<p>d-PAC is based on the discrepancy density estimation (DSP)[<xref ref-type="bibr" rid="pcbi.1005875.ref007">7</xref>]. Discrepancy, which is widely used in the analysis of Quasi-Monte Carlo methods, is a metric for the uniformity of points within a rectangle. DSP partitions the density space recursively until the uniformity of points within each rectangle is higher than some pre-specified threshold. The dimension and the cut point of each partition are chosen to approximately maximize the gap in uniformity of two adjacent rectangles.</p>
<p>BSP + LL is an approximation inference algorithm for Bayesian sequential partitioning density estimation (BSP)[<xref ref-type="bibr" rid="pcbi.1005875.ref005">5</xref>]. It borrows ideas from Limited-Look-ahead Optional Pólya Tree (LL-OPT), an approximate inference algorithm for Optional Pólya Tree[<xref ref-type="bibr" rid="pcbi.1005875.ref006">6</xref>]. The original inference algorithm for BSP looks at one level ahead (i.e. looking at the possible cut points one level deeper) when computing the sampling probability for the next partition. It then uses resampling to prune away bad samples. Instead of looking at one level ahead, BSP + LL looks at h levels ahead (h &gt; 1) when computing the sampling probabilities for the next partition and does not do resampling (<xref ref-type="fig" rid="pcbi.1005875.g001">Fig 1B</xref>). In other words, it compensates the loss from not performing resampling with more accurate sampling probabilities. For simplicity, ‘BSP + LL’ is shortened to ‘BSP’ in the rest of the article.</p>
</sec>
<sec id="sec016">
<title>F-measure</title>
<p>We use the F-measure for comparison of clustering results to ground truth (known in simulated data, or provided by hand-gating in real data). This measure is computed by regarding a clustering result as a series of decisions, one for each pair of data points. A true positive decision assigns two points that are in the same class (i.e. same class according to ground truth) to the same cluster, while a true negative decision assigns two points in different classes to different clusters. The F-measure is defined as the harmonic mean of the precision and recall. Precision P and recall R are defined as:
<disp-formula id="pcbi.1005875.e005">
<alternatives>
<graphic id="pcbi.1005875.e005g" mimetype="image" position="anchor" xlink:href="info:doi/10.1371/journal.pcbi.1005875.e005" xlink:type="simple"/>
<mml:math display="block" id="M5">
<mml:mi mathvariant="normal">P</mml:mi><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mi>T</mml:mi><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>T</mml:mi><mml:mi>P</mml:mi><mml:mo>+</mml:mo><mml:mi>F</mml:mi><mml:mi>P</mml:mi></mml:mrow></mml:mfrac>
</mml:math>
</alternatives>
<label>(2)</label>
</disp-formula>
<disp-formula id="pcbi.1005875.e006">
<alternatives>
<graphic id="pcbi.1005875.e006g" mimetype="image" position="anchor" xlink:href="info:doi/10.1371/journal.pcbi.1005875.e006" xlink:type="simple"/>
<mml:math display="block" id="M6">
<mml:mi mathvariant="normal">R</mml:mi><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mi>T</mml:mi><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>T</mml:mi><mml:mi>P</mml:mi><mml:mo>+</mml:mo><mml:mi>F</mml:mi><mml:mi>N</mml:mi></mml:mrow></mml:mfrac>
</mml:math>
</alternatives>
<label>(3)</label>
</disp-formula>
where TP is the total number of true positives, FP is the total number of false positives and FN is the total number of false negatives.</p>
<p>F-measure ranges from 0 to 1. The higher the measure, the more similar the estimated cluster result is to the ground truth. This definition of F-measure is different than that of FlowCAP challenge[<xref ref-type="bibr" rid="pcbi.1005875.ref002">2</xref>]. The use of co-assignment of labels in this definition is a more accurate way to compute the true positives and negatives.</p>
</sec>
<sec id="sec017">
<title>Purity-measure (p-measure)</title>
<p>Most of the existing measurements for clustering accuracy aim at measuring the overall accuracy of the entire datasets, i.e. comparing with the ground truth over all clusters. However, we are also interested in analyzing how well a clustering result matches the ground truth within a certain class. Specifically, consider a population with K classes in the ground truth: {C<sub>1</sub>,C<sub>2</sub>,…,C<sub>K</sub>}. We construct a class-specific index called the purity measure, or p-measure for short, to measure how well our clustering result matches the ground truth. This index is computed as follows:</p>
<list list-type="order">
<list-item><p>For each class C<sub>k</sub>, look for the cluster that has the maximum number of overlapping points with this class, denoted by <inline-formula id="pcbi.1005875.e007"><alternatives><graphic id="pcbi.1005875.e007g" mimetype="image" position="anchor" xlink:href="info:doi/10.1371/journal.pcbi.1005875.e007" xlink:type="simple"/><mml:math display="inline" id="M7"><mml:msub><mml:mrow><mml:mi mathvariant="normal">L</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">i</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:msub></mml:math></alternatives></inline-formula>.</p></list-item>
<list-item><p>Define
<disp-formula id="pcbi.1005875.e008">
<alternatives>
<graphic id="pcbi.1005875.e008g" mimetype="image" position="anchor" xlink:href="info:doi/10.1371/journal.pcbi.1005875.e008" xlink:type="simple"/>
<mml:math display="block" id="M8">
<mml:mrow><mml:msub><mml:mi mathvariant="normal">S</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mo>|</mml:mo><mml:msub><mml:mi>C</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo>∩</mml:mo><mml:msub><mml:mi mathvariant="normal">L</mml:mi><mml:mrow><mml:msub><mml:mi mathvariant="normal">i</mml:mi><mml:mi mathvariant="normal">k</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mo>|</mml:mo></mml:mrow><mml:mrow><mml:mo>|</mml:mo><mml:msub><mml:mi mathvariant="normal">L</mml:mi><mml:mrow><mml:msub><mml:mi mathvariant="normal">i</mml:mi><mml:mi mathvariant="normal">k</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mo>|</mml:mo></mml:mrow></mml:mfrac></mml:mrow><mml:mo>,</mml:mo><mml:mspace width="0.25em"/><mml:mrow><mml:msub><mml:mi mathvariant="normal">S</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mo>|</mml:mo><mml:msub><mml:mi>C</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo>∩</mml:mo><mml:msub><mml:mi mathvariant="normal">L</mml:mi><mml:mrow><mml:msub><mml:mi mathvariant="normal">i</mml:mi><mml:mi mathvariant="normal">k</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mo>|</mml:mo></mml:mrow><mml:mrow><mml:mo>|</mml:mo><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>|</mml:mo></mml:mrow></mml:mfrac></mml:mrow>
</mml:math>
</alternatives>
<label>(4)</label>
</disp-formula>
where |⋅| denotes the number of points in a set.</p></list-item>
<list-item><p>The final P-index for class C<sub>k</sub> is given by
<disp-formula id="pcbi.1005875.e009">
<alternatives>
<graphic id="pcbi.1005875.e009g" mimetype="image" position="anchor" xlink:href="info:doi/10.1371/journal.pcbi.1005875.e009" xlink:type="simple"/>
<mml:math display="block" id="M9">
<mml:mi mathvariant="normal">P</mml:mi><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mn>2</mml:mn><mml:msub><mml:mrow><mml:mi>S</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:msub><mml:mrow><mml:mi>S</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>S</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mi>S</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mfrac>
</mml:math>
</alternatives>
<label>(5)</label>
</disp-formula></p></list-item>
</list>
<p>If we were to match a big cluster with a small class, even though the overlapping may be large, S<sub>1</sub> would still be low since we have divided the score by the size of the cluster in S<sub>1</sub>. In addition, we are interested in knowing how many points in C<sub>k</sub> are clustered together by <inline-formula id="pcbi.1005875.e010"><alternatives><graphic id="pcbi.1005875.e010g" mimetype="image" position="anchor" xlink:href="info:doi/10.1371/journal.pcbi.1005875.e010" xlink:type="simple"/><mml:math display="inline" id="M10"><mml:msub><mml:mrow><mml:mi mathvariant="normal">L</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">i</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:msub></mml:math></alternatives></inline-formula>, which is measured by S<sub>2</sub>.</p>
</sec>
<sec id="sec018">
<title>Network construction and comparison</title>
<p>After PAC, the discovered subpopulations typically have enough cells for the estimation of mutual information. This enables the construction of networks as the basis for cell type characterization. In these networks, the nodes represent the markers monitored in the experiment, while the edges represent a correlation/mutual information dependence relationship between the marker levels. Computationally, it is not good to directly use the mutual information networks constructed this way to organize the subpopulations downstream. The distance measure used to characterize the networks could potentially give the same score for different network structures. Thus, it is necessary to threshold the network edges based on the strength of mutual information to filter out the noisy and miscellaneous edges. In this work, these subpopulation-specific networks are constructed using the MRNET network inference algorithm in the Parmigene [<xref ref-type="bibr" rid="pcbi.1005875.ref015">15</xref>] R package. The algorithm is based on mutual information ranking, and outputs significant edges connecting the markers. The top <italic>d</italic> edges (<italic>d</italic> is set to be 1x the number of markers in all examples) are used to define a network for the subpopulation. This process enables a careful calculation of the distance measure.</p>
<p>For each pair of subpopulation networks, we calculate a network distance, which is defined as follows. If G<sub>1</sub> and G<sub>2</sub> are two networks, let S be the set of shared edges and A be union of the of the edges in the two networks, then we define
<disp-formula id="pcbi.1005875.e011">
<alternatives>
<graphic id="pcbi.1005875.e011g" mimetype="image" position="anchor" xlink:href="info:doi/10.1371/journal.pcbi.1005875.e011" xlink:type="simple"/>
<mml:math display="block" id="M11">
<mml:mi mathvariant="normal">S</mml:mi><mml:mi mathvariant="normal">i</mml:mi><mml:mi mathvariant="normal">m</mml:mi><mml:mi mathvariant="normal">i</mml:mi><mml:mi mathvariant="normal">l</mml:mi><mml:mi mathvariant="normal">a</mml:mi><mml:mi mathvariant="normal">r</mml:mi><mml:mi mathvariant="normal">i</mml:mi><mml:mi mathvariant="normal">t</mml:mi><mml:mi mathvariant="normal">y</mml:mi><mml:mo>(</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="normal">G</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="normal">G</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:mo>)</mml:mo><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mo>|</mml:mo><mml:mi>S</mml:mi><mml:mo>|</mml:mo></mml:mrow><mml:mrow><mml:mo>|</mml:mo><mml:mi>A</mml:mi><mml:mo>|</mml:mo></mml:mrow></mml:mfrac>
</mml:math>
</alternatives>
<label>(6)</label>
</disp-formula>
where |⋅| denotes the size of a set.</p>
<p>This is known as the Jaccard coefficient of the two graphs. The Jaccard distance, or 1- Jaccard coefficient, is then obtained. This is a representation of the dissimilarity between each pair of networks; the Jaccard dissimilarity is the measure used for the downstream hierarchical clustering.</p>
</sec>
<sec id="sec019">
<title>Cross-sample linkage of subpopulations</title>
<p>We perform agglomerative clustering of the pool of subpopulations from all samples. This clustering procedure greedily links networks that are the closest in Jaccard dissimilarity, and yields a dendrogram describing the distance relationship between all the subpopulations. We cut the dendrogram to obtain the <italic>k</italic> clades of subpopulations. Subpopulations from the same sample and falling into the same clade are then merged into a single subpopulation (<xref ref-type="fig" rid="pcbi.1005875.g005">Fig 5</xref>). This merging step has the effect of consolidating the moderate over-partitioning in the PAC step. No merging is performed for subpopulations from different samples sharing the same clade. In this way, we obtain <italic>k</italic> clades of subpopulations, with each clade containing no more than one subpopulation from each sample. We regard the subpopulations within each clade as being linked across samples.</p>
<p>In the above computation, only subpopulations with enough cells to define a stable covariance are used for network alignment via the Jaccard distance; the rest of the cell events from very small subpopulations are then merged with the closet clade by marker profile via distance of mean marker signals. If the small subpopulations are distant from the defined clades, then a new sample-specific clade is created for these small subpopulations.</p>
</sec>
<sec id="sec020">
<title>Elbow point analysis of optimal number of clades</title>
<p>To efficiently find the practical number of clades to output for PAC-MAN, we utilize the elbow point analysis approach. Initially in the PAC step, the sample points are clustered into 2–3 times the expected number of sample subpopulations expected by the researcher. Next, we calculate the within-cluster errors, or distance from the subpopulation centroid, for each cluster in all samples, and we obtain the within-cluster errors for all sample. This calculation is performed for a range of numbers of clades in MAN. Loess smoothing is applied to the average within-cluster errors over the numbers of clades, and the researcher determines the location of the elbow point, which is then inputted into the final network alignment.</p>
</sec>
<sec id="sec021">
<title>Constellation plot analysis</title>
<p>To visualize the cellular state distribution in high-dimension, we construct the constellation plot. On the constellation plot, we observe two layers of information: the distribution of the clusters by expression level projection and the network similarities. By building the network structures and performing structural alignments, we remove extraneous connectivity between subpopulations that may appear close together in ‘expression space’ by grouping only subpopulations with strong network structural similarity. Those subpopulations that are in different clades but are close together on the constellation plot can be sample-specific subpopulations worth validating by future sorting and characterization experiments; these subpopulations are coherent clusters by expression and their network structures are different from those of other subpopulations.</p>
<p>In the constellation plot construction, Barnes-Hut t-SNE with default setting (perplexity of 30 and 1000 iterations) was run on the centroids (of expression/measurement signal) of the discovered clade subpopulations for the entire dataset after PAC-MAN; t-SNE plot projects and separates the centroids in two dimensions. Next, the clades are color-coded such that 1) grey color indicates sample-specific clade and 2) non-grey colors indicate clades with multiple sample representation. The subpopulations in each clade are grouped by lines connecting the closest clade subpopulation, analogous to the visualization of stars by constellation nomenclature.</p>
<p>Relative Euclidean distances (in the t-SNE embedding) between subpopulations and clade centers are utilized to prune away subpopulations that are far away within clades. For clades containing three or more subpopulations, the distances to clade centroids for each clade on the t-SNE plane are used as thresholds, and subpopulations that are more than twice (threshold constant multiplier) the average distance to their clade centroid are pruned. For clades with only two subpopulations, the distances between the subpopulations for each two-subpopulation clade are calculated; the mean of these distances for the two-subpopulation clades is used as a global threshold. Any two-subpopulation clade with separate larger than twice (threshold constant multiplier) this global threshold is pruned. The researcher also controls a maximum global separation threshold, and the pruning procedure uses the minimum of the thresholds to determine the pruning of clade subpopulations. All pruned away subpopulations are given new clade designation (<xref ref-type="supplementary-material" rid="pcbi.1005875.s009">S9 Fig</xref>).</p>
</sec>
<sec id="sec022">
<title>Network annotation of subpopulations</title>
<p>To annotate the cellular states, we first apply PAC-MAN to learn the dataset-level subpopulation/clade labels. Next, these labels are used to learn the representative/clade networks. The top hubs (i.e. the most connected nodes) in these networks are used for annotation. This approach has biological significance in that important markers in a cellular state are often central to the underlying marker network, which is analogous to important genes in gene regulatory networks; these important markers have many connections with other markers. If the connections were broken, the cell would be perturbed and potentially driven to other states.</p>
</sec>
<sec id="sec023">
<title>Running published methods</title>
<p>To run t-SNE [<xref ref-type="bibr" rid="pcbi.1005875.ref016">16</xref>] a dimensionality reduction visualization tool, we utilized the scripts published here (<ext-link ext-link-type="uri" xlink:href="https://lvdmaaten.github.io/tsne/" xlink:type="simple">https://lvdmaaten.github.io/tsne/</ext-link>). Default settings were used.</p>
<p>To run SPADE, we first converted the simulated data to fcs format using Broad Institute’s free CSVtoFCS online tool in GenePattern[<xref ref-type="bibr" rid="pcbi.1005875.ref017">17</xref>] (<ext-link ext-link-type="uri" xlink:href="http://www.broadinstitute.org/cancer/software/genepattern#" xlink:type="simple">http://www.broadinstitute.org/cancer/software/genepattern#</ext-link>).</p>
<p>Next, we carried out the tests using the SPADE package in Bioconductor R[<xref ref-type="bibr" rid="pcbi.1005875.ref018">18</xref>] (<ext-link ext-link-type="uri" xlink:href="https://github.com/nolanlab/spade" xlink:type="simple">https://github.com/nolanlab/spade</ext-link>).</p>
<p>To run flowMeans, we carried out the tests using the flowMeans package in Bioconductor R[<xref ref-type="bibr" rid="pcbi.1005875.ref001">1</xref>] (<ext-link ext-link-type="uri" xlink:href="https://bioconductor.org/packages/release/bioc/html/flowMeans.html" xlink:type="simple">https://bioconductor.org/packages/release/bioc/html/flowMeans.html</ext-link>).</p>
<p>In the comparisons, we selected only cases that work for all methods to make the tests as fair as possible.</p>
<p>To calculate the mutual information of the subpopulations, we use the infotheo R package (<ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/web/packages/infotheo/index.html" xlink:type="simple">https://cran.r-project.org/web/packages/infotheo/index.html</ext-link>).</p>
<p>To run network inference, we use the mrnet algorithm in the parmigne R package [<xref ref-type="bibr" rid="pcbi.1005875.ref015">15</xref>]. (<ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/web/packages/parmigene/index.html" xlink:type="simple">https://cran.r-project.org/web/packages/parmigene/index.html</ext-link>).</p>
</sec>
<sec id="sec024">
<title>Code availability</title>
<p>The PAC R package can be accessed at: <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/web/packages/PAC/index.html" xlink:type="simple">https://cran.r-project.org/web/packages/PAC/index.html</ext-link></p>
</sec>
<sec id="sec025">
<title>Simulated data for clustering analysis</title>
<p>To compare the clustering methods, we generated simulated data from Gaussian Mixture Model varying dimension, the number of mixture components, mean, and covariance. The dimensions range from 5 to 50. The number of mixture components is varied along each dimension. The mean of each component was generated uniformly from a d-dimensional hypercube; we generated datasets using hypercube of different sizes, but kept all the other attributes the same. The covariance matrices were generated as <italic>AA</italic><sup><italic>T</italic></sup>, where <italic>A</italic> is a random matrix whose elements were independently drawn from the standard normal distribution. The sizes of the simulated dataset range from 100k to 200k.</p>
<p>The simulated data are provided as (Datasets 1–6). Datasets 1–6 are for the PAC part. Dataset 1 contains data with 5 dimensions; Dataset 2 contains data with 10 dimensions; Dataset 3 contains data with 20 dimensions; Dataset 4 contains data with 35 dimensions; Dataset 5 contains data with 40 dimensions; and Dataset 6 contains data with 50 dimensions. The ground truth labels are included as separate sheets in each dataset.</p>
<p>When applying flowMeans, SPADE, and the PAC to the data, we preset the desired number of subpopulations to that in the data to allow for direct comparisons.</p>
</sec>
<sec id="sec026">
<title>Gated flow cytometry data</title>
<p>Two data files were downloaded from the FlowCAP challenges[<xref ref-type="bibr" rid="pcbi.1005875.ref002">2</xref>]. One data file is from the Hematopoietic stem cell transplant (HSCT) data set; it has 9,936 cell events with 6 markers, and human gating found 5 subpopulations. Another data file is from the Normal Donors (ND) data set; it has 60,418 cell events with 12 markers, and human gating found 8 subpopulations. The files are the first (‘001’) of each dataset. These data files were all 1) compensated, meaning that the spectral overlap is accounted for, 2) transformed into linear space, and 3) pre-gated to remove irrelevant events. We used the data files without any further transformation and filtering. When applying flowMeans, SPADE, and the PAC to the data, we preset the desired number of subpopulations to that in the data to allow for direct comparisons.</p>
</sec>
<sec id="sec027">
<title>Gated mass cytometry data</title>
<p>Human gated mass cytometry data was obtained by gating for the conventional immunology cell types using the mouse bone marrow data recently published[<xref ref-type="bibr" rid="pcbi.1005875.ref011">11</xref>]. The expert gating strategy is provided as <xref ref-type="supplementary-material" rid="pcbi.1005875.s001">S1 Fig</xref>. The gated sample subset contains 64,639 cell events with 39 markers and 24 subpopulations and it is provided as Dataset 9.</p>
<p>To test the performance of different analysis methods, the data was first transformed using the asinh(x/5) function, which is the transformation used prior to hand-gating analysis; For SPADE analysis, we utilize the asinh(x/5) option in the SPADE commands. The post-clustering results from flowMeans, SPADE, b-PAC, and d-PAC were then subsetted using the indexes of gated cell events. These subsetted results are compared to the hand-gated results.</p>
</sec>
<sec id="sec028">
<title>Simulated data for MAN analysis</title>
<p>To test the linking of subpopulations, we generated simulated data from multivariate Gaussian with preset signal levels and randomly generated positive definite covariance matrices. There are two cases, batch effect and dynamic. Each simulated sample file has five dimensions, with two of these varying in levels; these are the dimensions that are visualized. Dataset 7 contains the data for general batch effects case and Dataset 8 contains the data for dynamic effects case. The ground truth labels are included as separate sheets in each dataset.</p>
<sec id="sec029">
<title>General batch scenario</title>
<p>Sample 1 represents data from an old instrument (instrument 1) while sample 2 represents data from a new instrument (instrument 2). There are two subpopulations per sample. These two subpopulations are the same, but their mean marker levels shifted higher up in sample 2 due to higher sensitivity of instrument 2 (<xref ref-type="fig" rid="pcbi.1005875.g006">Fig 6A</xref>). The subpopulations have different underlying relationships between the markers. In this simulated experiment, five markers were measured. Out of the five markers, two markers show significant shift, and we focus on these two dimensions by 2-dimensional scatterplots. In <xref ref-type="fig" rid="pcbi.1005875.g006">Fig 6A</xref>, the left subpopulation in sample 1 is the same as the left subpopulation in sample 2; the same with the right subpopulation. The same subpopulations were generated from multivariate Gaussian distributions with changing means with fixed covariance structure.</p>
</sec>
<sec id="sec030">
<title>Dynamic scenario</title>
<p>Dynamic scenario models the treatment-control and perturbation studies. In the simulation, we have generated two subpopulations that nearly converge over the time course (<xref ref-type="fig" rid="pcbi.1005875.g009">Fig 9</xref>). The researcher could lose the dynamic information if they were to combine the samples for clustering analysis. The related subpopulations were generated from multivariate Gaussian distributions with changing means with fixed covariance structure.</p>
</sec>
</sec>
<sec id="sec031">
<title>Raw CyTOF data processing</title>
<p>The researcher preprocesses the data to 1) normalize the values to normalization bead signals, 2) de-barcode the samples if multiple barcoded samples were stained and ran together, and 3) pre-gate to remove irrelevant cells and debris to clean up the data[<xref ref-type="bibr" rid="pcbi.1005875.ref009">9</xref>,<xref ref-type="bibr" rid="pcbi.1005875.ref019">19</xref>]. Gene expressions look like log-normal distributions[<xref ref-type="bibr" rid="pcbi.1005875.ref020">20</xref>]; given the lognormal nature of the values, the hyperbolic arcsine transform is applied to the data matrix to bring the measured marker levels (estimation of expression values) close to normality, while preserving all data points. Often, researchers use the asinh(x/5) transformation, and we use the same transformation for the CyTOF datasets analyzed in this study.</p>
</sec>
<sec id="sec032">
<title>Mouse tissue data</title>
<p>In the Spitzer et al., 2015 dataset[<xref ref-type="bibr" rid="pcbi.1005875.ref011">11</xref>], three mouse strains were grown, and total leukocytes were collected from different tissues: thymus, spleen, small intestine, mesenteric lymph node, lung, liver, inguinal lymph node, colon, bone marrow, and blood. In each experiment, 39 expression markers were monitored. The authors used the C57BL6 mouse strain as the reference[<xref ref-type="bibr" rid="pcbi.1005875.ref011">11</xref>]; the data was downloaded from Cytobank, and we performed our analysis on the reference strain.</p>
<p>First, all individual samples were filtered by taking the top 95% of cells based on DNA content and then the top 95% of cells based on cisplatin: DNA content allows the extraction of good-quality cells and cisplatin level (low) allows the extraction of live cells. Overall, the top 90% of cell events were extracted. The filtered samples were then transformed by the hyperbolic arcsine (x/5) function, and merged as a single file, which contains 13,236,927 cell events and 39 markers per event (<xref ref-type="supplementary-material" rid="pcbi.1005875.s016">S2 Table</xref>).</p>
<p>Using PAC-MAN, we obtained 50 subpopulations in each sample, then, using elbow point analysis, we output 130 clades for the entire dataset. The 130 clades account for the traditional immune subpopulations and sample-specific subpopulations, which may include resident immune cells that are unique to certain tissues. In the network alignment step, smaller PAC subpopulations (&lt;1,000 cells) are left out because they may not have stable covariance and network structures. We attempt to assign the left-out small subpopulations back to the dataset: hierarchical clustering of the cluster centroids (marker signals or expression level) was performed, and we limit the total number of unique small sample-specific subpopulation by generating 5 “expression” clades per sample in the clustering (the larger subpopulations with a maximum of four sample-specific minor subpopulations that have less than 1,000 cells). Subsequently, any clade with less than 100 cells was discarded. Subpopulation proportion heatmap was plotted to visualize the subpopulation-specificities and relationships across the samples. Network annotation was performed using the hub markers of each representative subpopulation in each sample. Finally, we plotted the expression heatmap for all the clades and the constellation plot to visualize the cross-sample clade relationships.</p>
</sec>
</sec>
<sec id="sec033">
<title>Supporting information</title>
<supplementary-material id="pcbi.1005875.s001" mimetype="image/tiff" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.s001" xlink:type="simple">
<label>S1 Fig</label>
<caption>
<title>Gating strategy of CyTOF data for methods comparison.</title>
<p>Biaxial gating hierarchy for the mouse bone marrow CyTOF dataset. Gating strategy that was used to find 24 reference populations in the mouse bone marrow CyTOF data. Pre-gating step involved removal of doublets, dead cells, erythrocytes and neutrophils. Non-neutrophils population was either subject to cluster analysis by computational tools or subsequent gating. Dotted boxes represent 24 terminal gates that were selected as reference populations for the comparison analysis.</p>
<p>(TIF)</p>
</caption>
</supplementary-material>
<supplementary-material id="pcbi.1005875.s002" mimetype="image/tiff" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.s002" xlink:type="simple">
<label>S2 Fig</label>
<caption>
<title>Subpopulation purity of simulated and real CyTOF data.</title>
<p>(a) Subpopulation-specific purity plot of 35-dimensional simulated data with 10 subpopulations. The blue points denote the differences between the p-measures of the partition-based method (either d-PAC or b-PAC) and flowMeans, while the red points denote the p-measure differences between the partition methods and SPADE. The horizontal line at 0 means no difference between the methods. Most of the blue and red points are above 0, indicating that the PAC generates purer subpopulations compared to the ground truth. The two subplots are very similar, which means that d-PAC and b-PAC give very similar p-measures. More precisely, the sum of differences between d-PAC and flowMeans and d-PAC and SPADE are 0.85 and 1.09, respectively; and the overall difference between b-PAC and flowMeans and b-PAC and SPADE are 0.84 and 1.08, respectively.</p>
<p>(b) Subpopulation-specific purity plot of the hand-gated CyTOF data. The same convention is used as in (S2A Fig). Again, more blue and red points are above 0, indicating that the partition-based methods generate purer subpopulations compared to the ground truth. There is a cluster of points below 0 occurring in the middle of the plot, suggesting that flowMeans and SPADE capture the mid-size subpopulations more similar to hand-gating than the partition-based methods. More specifically, flowMeans does better (p-measure difference of 0.1 or better; difference of less 0.1 is considered practically no difference) with finding subpopulations of GMP, CD8 T cells, MEP, CD4 T cells (compared to d-PAC), and Plasma cells, while SPADE does better with CD19+IgM- B cells, NK cells (compared to d-PAC), CD8 T cells, NKT cells, Basophils, Short-Term HSC, and Plasma cells. However, overall, PAC has a much better performance, as the absolute sum of points above 0 is higher than that of points below 0. More precisely, the sum of differences between d-PAC and flowMeans and d-PAC and SPADE are 1.21 and 1.45, respectively; and the overall difference between b-PAC and flowMeans and b-PAC and SPADE are 2.06 and 2.31, respectively. The difference table is provided in <xref ref-type="supplementary-material" rid="pcbi.1005875.s015">S1 Table</xref>.</p>
<p>(TIF)</p>
</caption>
</supplementary-material>
<supplementary-material id="pcbi.1005875.s003" mimetype="image/tiff" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.s003" xlink:type="simple">
<label>S3 Fig</label>
<caption>
<title>Networks inferred from subpopulations in the dynamic example simulated dataset.</title>
<p><xref ref-type="fig" rid="pcbi.1005875.g009">Fig 9</xref> introduced the dynamic example in which five samples each having 2 true subpopulations captures the almost-convergence of means. Here the underlying network structures for the PAC discovered subpopulations (three per sample) in <xref ref-type="fig" rid="pcbi.1005875.g010">Fig 10</xref> are presented.</p>
<p>(TIF)</p>
</caption>
</supplementary-material>
<supplementary-material id="pcbi.1005875.s004" mimetype="image/tiff" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.s004" xlink:type="simple">
<label>S4 Fig</label>
<caption>
<title>Comparison between aligning cross-sample subpopulations by network, expression profile, or both.</title>
<p>(a) PAC can be used to discover more subpopulations, with the effect of more partitions from the true clusters. (b) When over-partitioning is present, network or expression profile alone cannot resolve the dynamic (or batch) effects due to noisy covariance for small fragments of distributions. However, first aligning the larger subpopulations with more stable covariance, and thus network structures, and then merge in the smaller subpopulations by expression profile resolves the effects. (c) If more irrelevant edges were introduced, network alignment would fail due to the negative impact of the miscellaneous edges; however, eliminating small subpopulations from the alignment step alleviates the increased edge count problem.</p>
<p>(TIF)</p>
</caption>
</supplementary-material>
<supplementary-material id="pcbi.1005875.s005" mimetype="image/tiff" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.s005" xlink:type="simple">
<label>S5 Fig</label>
<caption>
<title>PAC-MAN style linkage by means.</title>
<p>(a) t-SNE plots of mouse tissue samples colored by representative subpopulations labels from linkage by means. (b) Subpopulation proportion heatmap of clades of samples from linkage by means.</p>
<p>(TIF)</p>
</caption>
</supplementary-material>
<supplementary-material id="pcbi.1005875.s006" mimetype="image/tiff" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.s006" xlink:type="simple">
<label>S6 Fig</label>
<caption>
<title>Comparison between network and means PAC-MAN.</title>
<p>(a) PAC-discovered subpopulations are aggregated by MAN into clades; the number of PAC subpopulations/clades for the network and means PAC-MAN approaches are plotted. (b) After aggregating shared clades within samples, the number of shared clades for the entire dataset is plotted for the two PAC-MAN approaches.</p>
<p>(TIF)</p>
</caption>
</supplementary-material>
<supplementary-material id="pcbi.1005875.s007" mimetype="image/tiff" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.s007" xlink:type="simple">
<label>S7 Fig</label>
<caption>
<title>Clustering with t-SNE projected points.</title>
<p>We use t-SNE plots heavily for visualization in our study. We tested the approach of clustering on t-SNE projected points using kmeans. We observe that, despite being a very valuable visualization tool, t-SNE points do not contain much information for defining well-separated clusters for the usual clustering algorithms that depend on Gaussian geometry. It is best to perform the clustering using all data points in the original high-dimensional space, and then use t-SNE to visualize a subset of the points (amount chosen with computational capacity to run t-SNE).</p>
<p>(TIF)</p>
</caption>
</supplementary-material>
<supplementary-material id="pcbi.1005875.s008" mimetype="image/tiff" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.s008" xlink:type="simple">
<label>S8 Fig</label>
<caption>
<title>Elbow point analysis to find practical optimal number of clades.</title>
<p>Elbow point analysis is the most computationally feasible approach to find the optimal number of clades to output. We calculated the within-cluster errors (from the centroid) for each of the example tissue sample. Next, we averaged the within-cluster errors for all 10 tissue samples. This calculation was performed for a range of numbers of clades. Next, loess smoothing was applied to the average within-cluster errors over the numbers of clades. The elbow point occurs at 130 clades, highlighted by the vertical blue line.</p>
<p>(TIF)</p>
</caption>
</supplementary-material>
<supplementary-material id="pcbi.1005875.s009" mimetype="image/tiff" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.s009" xlink:type="simple">
<label>S9 Fig</label>
<caption>
<title>Pruned constellation plot.</title>
<p>As descripted in Materials and Methods, relative distances between subpopulations and clade centers are utilized to prune away subpopulations that are far away within clades. Clades 6 and 39 were pruned by setting threshold constant multiplier at 2.</p>
<p>(TIF)</p>
</caption>
</supplementary-material>
<supplementary-material id="pcbi.1005875.s010" mimetype="image/tiff" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.s010" xlink:type="simple">
<label>S10 Fig</label>
<caption>
<title>t-SNE visualization of clustering methods.</title>
<p>Higher resolution version of <xref ref-type="fig" rid="pcbi.1005875.g004">Fig 4</xref>.</p>
<p>(TIFF)</p>
</caption>
</supplementary-material>
<supplementary-material id="pcbi.1005875.s011" mimetype="image/tiff" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.s011" xlink:type="simple">
<label>S11 Fig</label>
<caption>
<title>Visualization of PAC vs. PAC-MAN results for blood, bone marrow, colon, inguinal lymph node, and liver samples.</title>
<p>Higher resolution version of <xref ref-type="fig" rid="pcbi.1005875.g012">Fig 12</xref> (in another color scheme) with subpopulation and clade labels.</p>
<p>(TIF)</p>
</caption>
</supplementary-material>
<supplementary-material id="pcbi.1005875.s012" mimetype="image/tiff" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.s012" xlink:type="simple">
<label>S12 Fig</label>
<caption>
<title>Visualization of PAC vs. PAC-MAN results for lung, mesenteric lymph node, spleen, thymus, and small intestine samples.</title>
<p>Higher resolution version of <xref ref-type="fig" rid="pcbi.1005875.g013">Fig 13</xref> (in another color scheme) with subpopulation and clade labels.</p>
<p>(TIF)</p>
</caption>
</supplementary-material>
<supplementary-material id="pcbi.1005875.s013" mimetype="image/tiff" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.s013" xlink:type="simple">
<label>S13 Fig</label>
<caption>
<title>Heatmap of clade proportions across the tissue samples.</title>
<p>Higher resolution version of <xref ref-type="fig" rid="pcbi.1005875.g014">Fig 14</xref> with clade labels.</p>
<p>(TIF)</p>
</caption>
</supplementary-material>
<supplementary-material id="pcbi.1005875.s014" mimetype="image/tiff" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.s014" xlink:type="simple">
<label>S14 Fig</label>
<caption>
<title>Heatmap of average subpopulation expression levels in all tissue samples.</title>
<p>Higher resolution version of <xref ref-type="fig" rid="pcbi.1005875.g015">Fig 15</xref> with clade labels.</p>
<p>(TIF)</p>
</caption>
</supplementary-material>
<supplementary-material id="pcbi.1005875.s015" mimetype="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.s015" xlink:type="simple">
<label>S1 Table</label>
<caption>
<title>Purity (p) measure differences in CyTOF comparison.</title>
<p>p-measure differences in gated CyTOF data analysis comparison. The differences are shown for all the annotated cell subpopulations, which are ordered by their sizes. Overall, the PAC methods give more positive p-measures.</p>
<p>(XLSX)</p>
</caption>
</supplementary-material>
<supplementary-material id="pcbi.1005875.s016" mimetype="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.s016" xlink:type="simple">
<label>S2 Table</label>
<caption>
<title>Sample sizes in mouse tissue CyTOF dataset.</title>
<p>The numbers of cells in the samples of Spitzer et al., 2015 CyTOF dataset. The data is from the C57BL6 mouse strain and a total of ten tissue samples are present. The raw column shows the number of cells prior to filtering by DNA and cisplatin values. The final cell counts are shown in the filtered file (3<sup>rd</sup>) column.</p>
<p>(XLSX)</p>
</caption>
</supplementary-material>
<supplementary-material id="pcbi.1005875.s017" mimetype="application/vnd.ms-excel" position="float" xlink:href="info:doi/10.1371/journal.pcbi.1005875.s017" xlink:type="simple">
<label>S3 Table</label>
<caption>
<title>PAC-MAN subpopulation characterization output for mouse tissue CyTOF dataset.</title>
<p>The full set of annotated results, along with mean expressions, subpopulation proportion and counts, are reported.</p>
<p>(XLS)</p>
</caption>
</supplementary-material>
</sec>
</body>
<back>
<ack>
<p>We thank the members of Wong Lab, in particular Tung-yu Wu, Chen-yu Tseng and Kun Yang, for critical feedback. We thank Karen Sachs for critical feedback and valuable discussions.</p>
</ack>
<ref-list>
<title>References</title>
<ref id="pcbi.1005875.ref001"><label>1</label><mixed-citation publication-type="journal" xlink:type="simple"><name name-style="western"><surname>Aghaeepour</surname> <given-names>N</given-names></name>, <name name-style="western"><surname>Nikolic</surname> <given-names>R</given-names></name>, <name name-style="western"><surname>Hoos</surname> <given-names>HH</given-names></name>, <name name-style="western"><surname>Brinkman</surname> <given-names>RR</given-names></name>. <article-title>Rapid cell population identification in flow cytometry data</article-title>. <source>Cytometry A</source>. <year>2011</year> <month>Jan</month> <day>1</day>;<volume>79A</volume>(<issue>1</issue>):<fpage>6</fpage>–<lpage>13</lpage>.</mixed-citation></ref>
<ref id="pcbi.1005875.ref002"><label>2</label><mixed-citation publication-type="journal" xlink:type="simple"><name name-style="western"><surname>Aghaeepour</surname> <given-names>N</given-names></name>, <name name-style="western"><surname>Finak</surname> <given-names>G</given-names></name>, <name name-style="western"><surname>Consortium</surname> <given-names>TF</given-names></name>, <name name-style="western"><surname>Consortium</surname> <given-names>TD</given-names></name>, <name name-style="western"><surname>Hoos</surname> <given-names>H</given-names></name>, <name name-style="western"><surname>Mosmann</surname> <given-names>TR</given-names></name>, <etal>et al</etal>. <article-title>Critical assessment of automated flow cytometry data analysis techniques</article-title>. <source>Nat Methods</source>. <year>2013</year> <month>Mar</month>;<volume>10</volume>(<issue>3</issue>):<fpage>228</fpage>–<lpage>38</lpage>. <comment>doi: <ext-link ext-link-type="uri" xlink:href="https://doi.org/10.1038/nmeth.2365" xlink:type="simple">10.1038/nmeth.2365</ext-link></comment> <object-id pub-id-type="pmid">23396282</object-id></mixed-citation></ref>
<ref id="pcbi.1005875.ref003"><label>3</label><mixed-citation publication-type="journal" xlink:type="simple"><name name-style="western"><surname>Qiu</surname> <given-names>P</given-names></name>, <name name-style="western"><surname>Simonds</surname> <given-names>EF</given-names></name>, <name name-style="western"><surname>Bendall</surname> <given-names>SC</given-names></name>, <name name-style="western"><surname>Gibbs</surname> <given-names>KD</given-names> <suffix>Jr</suffix></name>, <name name-style="western"><surname>Bruggner</surname> <given-names>RV</given-names></name>, <name name-style="western"><surname>Linderman</surname> <given-names>MD</given-names></name>, <etal>et al</etal>. <article-title>Extracting a cellular hierarchy from high-dimensional cytometry data with SPADE</article-title>. <source>Nat Biotechnol</source>. <year>2011</year> <month>Oct</month>;<volume>29</volume>(<issue>10</issue>):<fpage>886</fpage>–<lpage>91</lpage>. <comment>doi: <ext-link ext-link-type="uri" xlink:href="https://doi.org/10.1038/nbt.1991" xlink:type="simple">10.1038/nbt.1991</ext-link></comment> <object-id pub-id-type="pmid">21964415</object-id></mixed-citation></ref>
<ref id="pcbi.1005875.ref004"><label>4</label><mixed-citation publication-type="journal" xlink:type="simple"><name name-style="western"><surname>Wong</surname> <given-names>WH</given-names></name>, <name name-style="western"><surname>Ma</surname> <given-names>L</given-names></name>. <article-title>Optional Pólya tree and Bayesian inference</article-title>. <source>Ann Stat</source>. <year>2010</year> <month>Jun</month>;<volume>38</volume>(<issue>3</issue>):<fpage>1433</fpage>–<lpage>59</lpage>.</mixed-citation></ref>
<ref id="pcbi.1005875.ref005"><label>5</label><mixed-citation publication-type="journal" xlink:type="simple"><name name-style="western"><surname>Lu</surname> <given-names>L</given-names></name>, <name name-style="western"><surname>Jiang</surname> <given-names>H</given-names></name>, <name name-style="western"><surname>Wong</surname> <given-names>WH</given-names></name>. <article-title>Multivariate Density Estimation by Bayesian Sequential Partitioning</article-title>. <source>J Am Stat Assoc</source>. <year>2013</year> <month>Dec</month> <day>1</day>;<volume>108</volume>(<issue>504</issue>):<fpage>1402</fpage>–<lpage>10</lpage>.</mixed-citation></ref>
<ref id="pcbi.1005875.ref006"><label>6</label><mixed-citation publication-type="journal" xlink:type="simple"><name name-style="western"><surname>Jiang</surname> <given-names>H</given-names></name>, <name name-style="western"><surname>Mu</surname> <given-names>JC</given-names></name>, <name name-style="western"><surname>Yang</surname> <given-names>K</given-names></name>, <name name-style="western"><surname>Du</surname> <given-names>C</given-names></name>, <name name-style="western"><surname>Lu</surname> <given-names>L</given-names></name>, <name name-style="western"><surname>Wong</surname> <given-names>WH</given-names></name>. <article-title>Computational Aspects of Optional Pólya Tree</article-title>. <source>J Comput Graph Stat</source>. <year>2015</year> <month>Feb</month> <day>13</day>;0(ja):00–00.</mixed-citation></ref>
<ref id="pcbi.1005875.ref007"><label>7</label><mixed-citation publication-type="journal" xlink:type="simple"><name name-style="western"><surname>Li</surname> <given-names>D</given-names></name>, <name name-style="western"><surname>Yang</surname> <given-names>K</given-names></name>, <name name-style="western"><surname>Wong</surname> <given-names>WH</given-names></name>. <article-title>Density Estimation via Discrepancy Based Adaptive Sequential Partition</article-title>. In: <source>Advances in Neural Information Processing Systems</source>. <year>2016</year>. p. <fpage>1091</fpage>–<lpage>1099</lpage>.</mixed-citation></ref>
<ref id="pcbi.1005875.ref008"><label>8</label><mixed-citation publication-type="journal" xlink:type="simple"><name name-style="western"><surname>Samusik</surname> <given-names>N</given-names></name>, <name name-style="western"><surname>Good</surname> <given-names>Z</given-names></name>, <name name-style="western"><surname>Spitzer</surname> <given-names>MH</given-names></name>, <name name-style="western"><surname>Davis</surname> <given-names>KL</given-names></name>, <name name-style="western"><surname>Nolan</surname> <given-names>GP</given-names></name>. <article-title>Automated mapping of phenotype space with single-cell data</article-title>. <source>Nat Methods</source>. <year>2016</year> <month>Jun</month>;<volume>13</volume>(<issue>6</issue>):<fpage>493</fpage>–<lpage>6</lpage>. <comment>doi: <ext-link ext-link-type="uri" xlink:href="https://doi.org/10.1038/nmeth.3863" xlink:type="simple">10.1038/nmeth.3863</ext-link></comment> <object-id pub-id-type="pmid">27183440</object-id></mixed-citation></ref>
<ref id="pcbi.1005875.ref009"><label>9</label><mixed-citation publication-type="journal" xlink:type="simple"><name name-style="western"><surname>Finck</surname> <given-names>R</given-names></name>, <name name-style="western"><surname>Simonds</surname> <given-names>EF</given-names></name>, <name name-style="western"><surname>Jager</surname> <given-names>A</given-names></name>, <name name-style="western"><surname>Krishnaswamy</surname> <given-names>S</given-names></name>, <name name-style="western"><surname>Sachs</surname> <given-names>K</given-names></name>, <name name-style="western"><surname>Fantl</surname> <given-names>W</given-names></name>, <etal>et al</etal>. <article-title>Normalization of mass cytometry data with bead standards</article-title>. <source>Cytometry A</source>. <year>2013</year> <month>May</month> <day>1</day>;<volume>83A</volume>(<issue>5</issue>):<fpage>483</fpage>–<lpage>94</lpage>.</mixed-citation></ref>
<ref id="pcbi.1005875.ref010"><label>10</label><mixed-citation publication-type="journal" xlink:type="simple"><name name-style="western"><surname>Zunder</surname> <given-names>ER</given-names></name>, <name name-style="western"><surname>Lujan</surname> <given-names>E</given-names></name>, <name name-style="western"><surname>Goltsev</surname> <given-names>Y</given-names></name>, <name name-style="western"><surname>Wernig</surname> <given-names>M</given-names></name>, <name name-style="western"><surname>Nolan</surname> <given-names>GP</given-names></name>. <article-title>A Continuous Molecular Roadmap to iPSC Reprogramming through Progression Analysis of Single-Cell Mass Cytometry</article-title>. <source>Cell Stem Cell</source>. <year>2015</year> <month>Mar</month> <day>5</day>;<volume>16</volume>(<issue>3</issue>):<fpage>323</fpage>–<lpage>37</lpage>. <comment>doi: <ext-link ext-link-type="uri" xlink:href="https://doi.org/10.1016/j.stem.2015.01.015" xlink:type="simple">10.1016/j.stem.2015.01.015</ext-link></comment> <object-id pub-id-type="pmid">25748935</object-id></mixed-citation></ref>
<ref id="pcbi.1005875.ref011"><label>11</label><mixed-citation publication-type="journal" xlink:type="simple"><name name-style="western"><surname>Spitzer</surname> <given-names>MH</given-names></name>, <name name-style="western"><surname>Gherardini</surname> <given-names>PF</given-names></name>, <name name-style="western"><surname>Fragiadakis</surname> <given-names>GK</given-names></name>, <name name-style="western"><surname>Bhattacharya</surname> <given-names>N</given-names></name>, <name name-style="western"><surname>Yuan</surname> <given-names>RT</given-names></name>, <name name-style="western"><surname>Hotson</surname> <given-names>AN</given-names></name>, <etal>et al</etal>. <article-title>An interactive reference framework for modeling a dynamic immune system</article-title>. <source>Science</source>. <year>2015</year> <month>Jul</month> <day>10</day>;<volume>349</volume>(<issue>6244</issue>):<fpage>1259425</fpage>. <comment>doi: <ext-link ext-link-type="uri" xlink:href="https://doi.org/10.1126/science.1259425" xlink:type="simple">10.1126/science.1259425</ext-link></comment> <object-id pub-id-type="pmid">26160952</object-id></mixed-citation></ref>
<ref id="pcbi.1005875.ref012"><label>12</label><mixed-citation publication-type="journal" xlink:type="simple"><name name-style="western"><surname>Ostrovsky</surname> <given-names>R</given-names></name>, <name name-style="western"><surname>Rabani</surname> <given-names>Y</given-names></name>, <name name-style="western"><surname>Schulman</surname> <given-names>LJ</given-names></name>, <name name-style="western"><surname>Swamy</surname> <given-names>C</given-names></name>. <article-title>The Effectiveness of Lloyd-type Methods for the K-means Problem</article-title>. <source>J ACM</source>. <year>2013</year> <month>Jan</month>;<volume>59</volume>(<issue>6</issue>):<fpage>28:1</fpage>–<lpage>28:22</lpage>.</mixed-citation></ref>
<ref id="pcbi.1005875.ref013"><label>13</label><mixed-citation publication-type="other" xlink:type="simple">Arthur D, Vassilvitskii S. K-means++: The Advantages of Careful Seeding. In: Proceedings of the Eighteenth Annual ACM-SIAM Symposium on Discrete Algorithms. Philadelphia, PA, USA: Society for Industrial and Applied Mathematics; 2007. p. 1027–1035. (SODA ‘07).</mixed-citation></ref>
<ref id="pcbi.1005875.ref014"><label>14</label><mixed-citation publication-type="journal" xlink:type="simple"><name name-style="western"><surname>Samusik</surname> <given-names>N</given-names></name>, <name name-style="western"><surname>Good</surname> <given-names>Z</given-names></name>, <name name-style="western"><surname>Spitzer</surname> <given-names>MH</given-names></name>, <name name-style="western"><surname>Davis</surname> <given-names>KL</given-names></name>, <name name-style="western"><surname>Nolan</surname> <given-names>GP</given-names></name>. <article-title>Automated mapping of phenotype space with single-cell data</article-title>. <source>Nat Methods</source>. <year>2016</year> <month>Jun</month>;<volume>13</volume>(<issue>6</issue>):<fpage>493</fpage>–<lpage>6</lpage>. <comment>doi: <ext-link ext-link-type="uri" xlink:href="https://doi.org/10.1038/nmeth.3863" xlink:type="simple">10.1038/nmeth.3863</ext-link></comment> <object-id pub-id-type="pmid">27183440</object-id></mixed-citation></ref>
<ref id="pcbi.1005875.ref015"><label>15</label><mixed-citation publication-type="journal" xlink:type="simple"><name name-style="western"><surname>Sales</surname> <given-names>G</given-names></name>, <name name-style="western"><surname>Romualdi</surname> <given-names>C</given-names></name>. <article-title>parmigene—a parallel R package for mutual information estimation and gene network reconstruction</article-title>. <source>Bioinformatics</source>. <year>2011</year> <month>Jul</month> <day>1</day>;<volume>27</volume>(<issue>13</issue>):<fpage>1876</fpage>–<lpage>7</lpage>. <comment>doi: <ext-link ext-link-type="uri" xlink:href="https://doi.org/10.1093/bioinformatics/btr274" xlink:type="simple">10.1093/bioinformatics/btr274</ext-link></comment> <object-id pub-id-type="pmid">21531770</object-id></mixed-citation></ref>
<ref id="pcbi.1005875.ref016"><label>16</label><mixed-citation publication-type="journal" xlink:type="simple"><name name-style="western"><surname>Maaten</surname> <given-names>L van der</given-names></name>, <name name-style="western"><surname>Hinton</surname> <given-names>G</given-names></name>. <article-title>Visualizing Data using t-SNE</article-title>. <source>J Mach Learn Res</source>. <year>2008</year>;<volume>9</volume>(<month>Nov</month>):<fpage>2579</fpage>–<lpage>605</lpage>.</mixed-citation></ref>
<ref id="pcbi.1005875.ref017"><label>17</label><mixed-citation publication-type="journal" xlink:type="simple"><name name-style="western"><surname>Reich</surname> <given-names>M</given-names></name>, <name name-style="western"><surname>Liefeld</surname> <given-names>T</given-names></name>, <name name-style="western"><surname>Gould</surname> <given-names>J</given-names></name>, <name name-style="western"><surname>Lerner</surname> <given-names>J</given-names></name>, <name name-style="western"><surname>Tamayo</surname> <given-names>P</given-names></name>, <name name-style="western"><surname>Mesirov</surname> <given-names>JP</given-names></name>. <article-title>GenePattern 2.0</article-title>. <source>Nat Genet</source>. <year>2006</year> <month>May</month>;<volume>38</volume>(<issue>5</issue>):<fpage>500</fpage>–<lpage>1</lpage>. <comment>doi: <ext-link ext-link-type="uri" xlink:href="https://doi.org/10.1038/ng0506-500" xlink:type="simple">10.1038/ng0506-500</ext-link></comment> <object-id pub-id-type="pmid">16642009</object-id></mixed-citation></ref>
<ref id="pcbi.1005875.ref018"><label>18</label><mixed-citation publication-type="journal" xlink:type="simple"><name name-style="western"><surname>Linderman</surname> <given-names>MD</given-names></name>, <name name-style="western"><surname>Bjornson</surname> <given-names>Z</given-names></name>, <name name-style="western"><surname>Simonds</surname> <given-names>EF</given-names></name>, <name name-style="western"><surname>Qiu</surname> <given-names>P</given-names></name>, <name name-style="western"><surname>Bruggner</surname> <given-names>RV</given-names></name>, <name name-style="western"><surname>Sheode</surname> <given-names>K</given-names></name>, <etal>et al</etal>. <article-title>CytoSPADE: high-performance analysis and visualization of high-dimensional cytometry data</article-title>. <source>Bioinformatics</source>. <year>2012</year> <month>Sep</month> <day>15</day>;<volume>28</volume>(<issue>18</issue>):<fpage>2400</fpage>–<lpage>1</lpage>. <comment>doi: <ext-link ext-link-type="uri" xlink:href="https://doi.org/10.1093/bioinformatics/bts425" xlink:type="simple">10.1093/bioinformatics/bts425</ext-link></comment> <object-id pub-id-type="pmid">22782546</object-id></mixed-citation></ref>
<ref id="pcbi.1005875.ref019"><label>19</label><mixed-citation publication-type="journal" xlink:type="simple"><name name-style="western"><surname>Zunder</surname> <given-names>ER</given-names></name>, <name name-style="western"><surname>Finck</surname> <given-names>R</given-names></name>, <name name-style="western"><surname>Behbehani</surname> <given-names>GK</given-names></name>, <name name-style="western"><surname>Amir</surname> <given-names>ED</given-names></name>, <name name-style="western"><surname>Krishnaswamy</surname> <given-names>S</given-names></name>, <name name-style="western"><surname>Gonzalez</surname> <given-names>VD</given-names></name>, <etal>et al</etal>. <article-title>Palladium-based mass tag cell barcoding with a doublet-filtering scheme and single-cell deconvolution algorithm</article-title>. <source>Nat Protoc</source>. <year>2015</year> <month>Feb</month>;<volume>10</volume>(<issue>2</issue>):<fpage>316</fpage>–<lpage>33</lpage>. <comment>doi: <ext-link ext-link-type="uri" xlink:href="https://doi.org/10.1038/nprot.2015.020" xlink:type="simple">10.1038/nprot.2015.020</ext-link></comment> <object-id pub-id-type="pmid">25612231</object-id></mixed-citation></ref>
<ref id="pcbi.1005875.ref020"><label>20</label><mixed-citation publication-type="journal" xlink:type="simple"><name name-style="western"><surname>Bengtsson</surname> <given-names>M</given-names></name>, <name name-style="western"><surname>Ståhlberg</surname> <given-names>A</given-names></name>, <name name-style="western"><surname>Rorsman</surname> <given-names>P</given-names></name>, <name name-style="western"><surname>Kubista</surname> <given-names>M</given-names></name>. <article-title>Gene expression profiling in single cells from the pancreatic islets of Langerhans reveals lognormal distribution of mRNA levels</article-title>. <source>Genome Res</source>. <year>2005</year> <month>Oct</month> <day>1</day>;<volume>15</volume>(<issue>10</issue>):<fpage>1388</fpage>–<lpage>92</lpage>. <comment>doi: <ext-link ext-link-type="uri" xlink:href="https://doi.org/10.1101/gr.3820805" xlink:type="simple">10.1101/gr.3820805</ext-link></comment> <object-id pub-id-type="pmid">16204192</object-id></mixed-citation></ref>
</ref-list>
</back>
</article>